!function(t,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],o):o((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,o){"use strict";class i{constructor(t,i,e,r=1){this.width=1,this.doors=[],this.x=t[0],this.y=t[1];const n=o.utils.DIRS[i];this.length=e,this.width=r,i===o.utils.UP||i===o.utils.DOWN?(this.x2=this.x+(r-1),this.y2=this.y+(e-1)*n[1]):(this.x2=this.x+(e-1)*n[0],this.y2=this.y+(r-1)),this.dir=i}translate(t,o){this.x+=t,this.y+=o,this.x2+=t,this.y2+=o,this.doors&&this.doors.forEach((i=>{i&&(i[0]<0||i[1]<0||(i[0]+=t,i[1]+=o))}))}}class e{constructor(t,o,i,e,r){this.doors=[],this.hall=null,this.digger=t,this.x=o,this.y=i,this.width=e,this.height=r}get cx(){return this.x+Math.floor(this.width/2)}get cy(){return this.y+Math.floor(this.height/2)}translate(t,o){this.x+=t,this.y+=o,this.doors&&this.doors.forEach((i=>{i&&(i[0]<0||i[1]<0||(i[0]+=t,i[1]+=o))})),this.hall&&this.hall.translate(t,o)}}var r={};function n(t,i){return i=i||{},(t=t||{}).width&&t.height||o.utils.ERROR("All diggers require config to include width and height."),Object.entries(i).forEach((([i,e])=>{const r=t[i];if(!0===e)"number"!=typeof r&&o.utils.ERROR("Invalid configuration for digger: "+i+" expected number received "+typeof r);else if("number"==typeof e){"number"!=typeof t[i]&&(t[i]=e)}else if(Array.isArray(e))if("number"==typeof r)t[i]=new Array(e.length).fill(r);else if(Array.isArray(r)){if(e.length>r.length)for(let t=r.length;t<e.length;++t)r[t]=e[t]}else o.utils.WARN("Received unexpected config for digger : "+i+" expected array, received "+typeof r+", using defaults."),t[i]=e.slice();else o.utils.WARN("Unexpected digger configuration parameter: ",i,""+e)})),t}const h=o.utils.DIRS;function l(t,i){const e=o.utils.firstOpt("horizontalHallLength",i,[9,15]),r=o.utils.firstOpt("verticalHallLength",i,[2,9]);return t==o.utils.UP||t==o.utils.DOWN?r:e}function a(t,e,r,n,l){const a=n.doors[e],f=h[e];let s=a[0],c=a[1];const d=l.tile||1;for(let o=0;o<r;o++)t[s][c]=d,s+=f[0],c+=f[1];s-=f[0],c-=f[1];const g=new i(a,e,r);return g.doors=function(t,i,e,r,n){let l,a;const f=o.utils.firstOpt("obliqueChance",n,15),s=o.random.chance(f),c=[[-1,-1],[-1,-1],[-1,-1],[-1,-1]];for(let o=0;o<4;o++)l=i+h[o][0],a=e+h[o][1],o!=r&&!s||!t.hasXY(l,a)||t[l][a]?(c[o][0]=-1,c[o][1]=-1):(c[o][0]=l,c[o][1]=a);return c}(t,s,c,e,l),g}function f(t,e,r){const n=function(t,i,e){const r=i.doors;let n=e.dir||o.utils.NO_DIRECTION;if(n==o.utils.NO_DIRECTION){const i=o.random.sequence(4);for(let a=0;a<4;a++){n=i[a];const f=l(n,e)[1],s=r[n][0]+Math.floor(h[n][0]*f),c=r[n][1]+Math.floor(h[n][1]*f);if(-1!=r[n][0]&&-1!=r[n][1]&&t.hasXY(s,c))break;n=o.utils.NO_DIRECTION}}return n}(t,e,r=r||{});if(n===o.utils.NO_DIRECTION)return null;console.log("dir",n);const f=o.random.range(...l(n,r));console.log("length",f);const s=r.width||1;return console.log("width",s),s>1?function(t,e,r,n,h){const l=n.doors[e],a=h.tile||1,f=[[-1,-1],[-1,-1],[-1,-1],[-1,-1]];let s,c,d;if(e===o.utils.UP){s=Math.max(l[0]-1,n.x),c=l[1]-r+1;for(let o=s;o<s+2;++o)for(let i=c;i<c+r;++i)t[o][i]=a;f[e]=[s,c-1],d=new i([s,l[1]],e,r,2)}else if(e===o.utils.DOWN){s=Math.max(l[0]-1,n.x),c=l[1]+r-1;for(let o=s;o<s+2;++o)for(let i=c;i>c-r;--i)t[o][i]=a;f[e]=[s,c+1],d=new i([s,l[1]],e,r,2)}else if(e===o.utils.LEFT){s=l[0]-r+1,c=Math.max(l[1]-1,n.y);for(let o=s;o<s+r;++o)for(let i=c;i<c+2;++i)t[o][i]=a;f[e]=[s-1,c],d=new i([l[0],c],e,r,2)}else{s=l[0]+r-1,c=Math.max(l[1]-1,n.y);for(let o=s;o>s-r;--o)for(let i=c;i<c+2;++i)t[o][i]=a;f[e]=[s+1,c],d=new i([l[0],c],e,r,2)}return d.doors=f,d.width=2,d}(t,n,f,e,r):a(t,n,f,e,r)}const s=o.utils.DIRS;var c;function d(t,i,e,r={}){const n=e.hall?e.hall.doors:e.doors;for(let h=0;h<c.length;h++){const l=Math.floor(c[h]/t.height),a=c[h]%t.height;if(0!=t.get(l,a))continue;const f=o.grid.directionOfDoorSite(t,l,a,1);if(f!=o.utils.NO_DIRECTION){const h=(f+2)%4,s=l-n[h][0],c=a-n[h][1];if(-1!=n[h][0]&&g(t,i,s,c))return o.grid.offsetZip(t,i,s,c,((o,i,e,n)=>{t[e][n]=r.tile||1})),(r.door||!1!==r.placeDoor)&&(t[l][a]=r.door||2),e.translate(s,c),!0}}return!1}function g(t,o,i,e){let r,n,h,l,a,f;for(r=0;r<o.width;r++)for(n=0;n<o.height;n++)if(o[r][n])for(h=r+i,l=n+e,a=h-1;a<=h+1;a++)for(f=l-1;f<=l+1;f++)if(!t.hasXY(a,f)||t.isBoundaryXY(a,f)||0!==t.get(a,f))return!1;return!0}function u(t,i,e,r,n={}){const h=o.random.sequence(i.length);for(let o=0;o<h.length;o++){const l=i[h[o]];if(!l)continue;if(M(t,l[0],l[1],e,r,n))return!0}return!1}function M(t,i,e,r,n,h={}){const l=n.hall?n.hall.doors:n.doors,a=o.random.sequence(4);for(let f of a){const a=l[(f+2)%4];if(a&&(-1!=a[0]&&g(t,r,i-a[0],e-a[1]))){const l=i-a[0],f=e-a[1];return o.grid.offsetZip(t,r,l,f,((o,i,e,r)=>{t[e][r]=h.tile||1})),(h.door||!1!==h.placeDoor)&&(t[i][e]=h.door||2),n.translate(l,f),!0}}return!1}function m(t){let i,e,r,n,h,l,a;const f=o.grid.alloc(t.width,t.height);for(f.copy(t),i=0;i<f.width;i++)for(e=0;e<f.height;e++)if(!f[i][e]&&(l=o.grid.directionOfDoorSite(f,i,e,1),l!=o.utils.NO_DIRECTION)){for(n=i+s[l][0],h=e+s[l][1],a=!1,r=0;r<10&&f.hasXY(n,h)&&!a;r++)f[n][h]&&(a=!0),n+=s[l][0],h+=s[l][1];a||(f[i][e]=l+200)}let c=[];for(l=0;l<4;l++){const t=f.randomMatchingLoc(l+200)||[-1,-1];c[l]=[t[0],t[1]]}return o.grid.free(f),c}function w(t,o,i){const e=t.get(o,i);return 1===e||2===e||5===e}function R(t,o,i){const e=t.get(o,i);return 0===e||3===e}function y(t){let i,e,r,n,h,l;do{for(l=!1,i=0;i<t.width-1;i++)for(e=0;e<t.height-1;e++)for(r=0;r<=1;r++)w(t,i+r,e)&&!w(t,i+(1-r),e)&&R(t,i+(1-r),e)&&!w(t,i+r,e+1)&&R(t,i+r,e+1)&&w(t,i+(1-r),e+1)&&(o.random.chance(50)?(n=i+(1-r),h=e):(n=i+r,h=e+1),l=!0,t[n][h]=1)}while(1==l)}function p(t){t.forEach(((o,i,e)=>{t.isBoundaryXY(i,e)||2==o&&(1!=t.get(i+1,e)&&1!=t.get(i-1,e)||1!=t.get(i,e+1)&&1!=t.get(i,e-1)?(1!==t.get(i+1,e)?1:0)+(1!==t.get(i-1,e)?1:0)+(1!==t.get(i,e+1)?1:0)+(1!==t.get(i,e-1)?1:0)>=3&&(t[i][e]=1):t[i][e]=1)}))}function O(t){t.forEach(((o,i,e)=>{0==o&&(t[i][e]=3)}))}var x={__proto__:null,start:function(t){c=o.random.sequence(t.width*t.height),t.fill(0)},finish:function(t){y(t),O(t),p(t)},dig:function(t,i={}){"string"==typeof i&&(i={digger:i});const e=i.digger||i.id||"SMALL",n=r[e];n||o.utils.ERROR("Failed to find digger: "+e);let h=i.locs||i.loc||null;if(h&&Array.isArray(h))h&&h.length&&2==h.length&&"number"==typeof h[0]?h=[h]:0==h.length&&(h=null);else if(h=null,0===t.count(1)){h=[[Math.floor(t.width/2),t.height-2]]}const l=Object.assign({},n,i),a=o.grid.alloc(t.width,t.height),s=l.hallChance||l.hallway||0,c=o.random.chance(s);let g,M=!1,w=l.tries||10;for(;--w>=0&&!M;)a.fill(0),g=n.fn(l,a),g.doors=m(a),c&&(g.hall=f(a,g,l)),M=h?u(t,h,a,g,l):d(t,a,g,l);return o.grid.free(a),g&&M?g:null},attachRoom:d,roomFitsAt:g,forceRoomAtMapLoc:function(t,i,e,r,n={}){for(let h=0;h<c.length;h++){const l=Math.floor(c[h]/t.height),a=c[h]%t.height;if(e[l][a])continue;if(o.grid.directionOfDoorSite(e,l,a,1)!=o.utils.NO_DIRECTION){const h=i[0]-l,f=i[1]-a;if(g(t,e,h,f))return o.grid.offsetZip(t,e,h,f,((o,i,e,r)=>{t[e][r]=n.tile||1})),(n.door||!1!==n.placeDoor)&&(t[i[0]][i[1]]=n.door||2),r.translate(h,f),!0}}return!1},chooseRandomDoorSites:m,isPassable:w,isObstruction:R,removeDiagonalOpenings:y,finishDoors:p,finishWalls:O,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,LAKE:4,BRIDGE:5,Hall:i,Room:e,diggers:r,install:function(t,o,i){return(i=o(i||{})).fn=o,i.id=t,r[t]=i,i},checkConfig:n,cavern:function(t,i){if(t=n(t,{width:12,height:8}),!i)return t;let r,h,l;l=o.grid.alloc(i.width,i.height,0);const a=Math.floor(.5*t.width),f=t.width,s=Math.floor(.5*t.height),c=t.height;i.fill(0);const d=l.fillBlob(5,a,s,f,c,55,"ffffffttt","ffffttttt");return r=Math.floor((i.width-d.width)/2),h=Math.floor((i.height-d.height)/2),o.grid.offsetZip(i,l,r-d.x,h-d.y,1),o.grid.free(l),new e(t.id,r,h,d.width,d.height)},choiceRoom:function(t,i){let e,n;t=t||{},Array.isArray(t.choices)?e=t.choices:"object"==typeof t.choices?e=Object.keys(t.choices):o.utils.ERROR("Expected choices to be either array of choices or map { digger: weight }");for(let t of e)r[t]||o.utils.ERROR("Missing digger choice: "+t);if(!i)return t;n=Array.isArray(t.choices)?o.random.item(t.choices):o.random.weighted(t.choices);const h=r[n];let l=h;return t.opts&&(l=Object.assign({},h,t.opts)),h.fn(l,i)},entranceRoom:function(t,o){if(t=n(t,{width:20,height:10}),!o)return t;const i=Math.floor(.4*t.width),r=t.height,h=t.width,l=Math.floor(.5*t.height),a=Math.floor(o.width/2-i/2-1),f=o.height-r-2,s=Math.floor(o.width/2-h/2-1),c=o.height-l-2;return o.fill(0),o.fillRect(a,f,i,r,1),o.fillRect(s,c,h,l,1),new e(t.id,Math.min(a,s),Math.min(f,c),Math.max(i,h),Math.max(r,l))},crossRoom:function(t,i){if(t=n(t,{width:12,height:20}),!i)return t;const r=Math.max(2,Math.floor(t.width*o.random.range(15,60)/100)),h=Math.max(2,Math.floor(t.width*o.random.range(20,100)/100)),l=Math.max(2,Math.floor(t.height*o.random.range(50,100)/100)),a=Math.max(2,Math.floor(t.height*o.random.range(25,75)/100)),f=o.random.range(Math.max(0,Math.floor(i.width/2)-(r-1)),Math.min(i.width,Math.floor(i.width/2))),s=f+Math.floor(r/2)+o.random.range(0,2)+o.random.range(0,2)-3-Math.floor(h/2),c=Math.floor(i.height/2-l),d=Math.floor(i.height/2-a-(o.random.range(0,2)+o.random.range(0,1)));return i.fill(0),i.fillRect(f-5,c+5,r,l,1),i.fillRect(s-5,d+5,h,a,1),new e(t.id,Math.min(f,s)-5,Math.min(c,d)-5,Math.max(r,h),Math.max(l,a))},symmetricalCrossRoom:function(t,i){if(t=n(t,{width:8,height:5}),!i)return t;let r=Math.floor(t.width*o.random.range(50,100)/100),h=Math.floor(t.height*o.random.range(75,100)/100),l=Math.max(2,Math.floor(t.width*o.random.range(25,50)/100));h%2==0&&l>2&&(l-=1);let a=Math.max(2,Math.floor(t.height*o.random.range(25,50)/100));r%2==0&&a>2&&(a-=1),i.fill(0);const f=Math.floor((i.width-r)/2),s=Math.floor((i.height-a)/2);i.fillRect(f,s,r,a,1);const c=Math.floor((i.width-l)/2),d=Math.floor((i.height-h)/2);return i.fillRect(c,d,l,h,1),new e(t.id,Math.min(f,c),Math.min(s,d),Math.max(r,l),Math.max(h,a))},rectangularRoom:function(t,i){if(t=n(t,{width:6,height:4,minPct:50}),!i)return t;const r=Math.floor(t.width*o.random.range(t.minPct,100)/100),h=Math.floor(t.height*o.random.range(t.minPct,100)/100);i.fill(0);const l=Math.floor((i.width-r)/2),a=Math.floor((i.height-h)/2);return i.fillRect(l,a,r,h,1),new e(t.id,l,a,r,h)},circularRoom:function(t,i){if(t=n(t,{width:6,height:6}),!i)return t;const r=Math.floor((Math.min(t.width,t.height)-1)*o.random.range(75,100)/200);i.fill(0);const h=Math.floor(i.width/2),l=Math.floor(i.height/2);return r>1&&i.fillCircle(h,l,r,1),new e(t.id,h,l,2*r,2*r)},brogueDonut:function(t,i){if(t=n(t,{width:10,height:10,altChance:5,ringMinWidth:3,holeMinSize:3,holeChance:50}),!i)return t;const r=Math.floor(Math.min(t.width,t.height)*o.random.range(75,100)/100);i.fill(0);const h=Math.floor(i.width/2),l=Math.floor(i.height/2);return i.fillCircle(h,l,r,1),r>t.ringMinWidth+t.holeMinSize&&o.random.chance(t.holeChance)&&i.fillCircle(h,l,o.random.range(t.holeMinSize,r-t.holeMinSize),0),new e(t.id,h,l,2*r,2*r)},chunkyRoom:function(t,i){if(t=n(t,{count:8}),!i)return t;let r,h,l,a,f,s,c,d=Math.floor(t.count*o.random.range(25,100)/100);for(a=Math.floor(i.width/2)-Math.floor(t.width/2),f=Math.floor(i.width/2)+Math.floor(t.width/2),s=Math.floor(i.height/2)-Math.floor(t.height/2),c=Math.floor(i.height/2)+Math.floor(t.height/2),i.fill(0),i.fillCircle(Math.floor(i.width/2),Math.floor(i.height/2),2,1),r=0;r<d;)if(h=o.random.range(a,f),l=o.random.range(s,c),i[h][l]){if(h-2<a)continue;if(h+2>f)continue;if(l-2<s)continue;if(l+2>c)continue;i.fillCircle(h,l,2,1),r++}return new e(t.id,a,s,f-a+1,c-s+1)}};t.dig=x,t.diggers=r,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-dig.min.js.map

!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,i){"use strict";const e={0:"NULL",1:"FLOOR",2:"DOOR",3:"WALL",8:"IMPREGNABLE",4:"LAKE",5:"SHALLOW",6:"BRIDGE",7:"UP_STAIRS",17:"DOWN_STAIRS"},r=[];function o(t){r.length=t;for(let i=0;i<t;++i)r[i]=i;i.random.shuffle(r)}function n(t,e){t.forEach(((r,o,n)=>{e[o][n]=h(t,o,n)?1:i.path.OBSTRUCTION}))}function h(t,i,e){return a(t,i,e)||f(t,i,e)||u(t,i,e)||g(t,i,e)||w(t,i,e)}function s(t,i,e){return 0===t.get(i,e)}function l(t,i,e){return 0===t.get(i,e)}function a(t,i,e){return 1==t.get(i,e)}function f(t,i,e){return 2===t.get(i,e)}function u(t,i,e){return 6===t.get(i,e)}function c(t,i,e){const r=t.get(i,e);return 3===r||8===r}function d(t,i,e){return s(t,i,e)||c(t,i,e)}function g(t,i,e){const r=t.get(i,e);return 7===r||17===r}function m(t,i,e){return 4===t.get(i,e)}function w(t,i,e){return 5===t.get(i,e)}function p(t,i,e){return m(t,i,e)||w(t,i,e)}function y(t,i,e,r){t.hasXY(i,e)&&(t[i][e]=r)}var M={__proto__:null,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,DEEP:4,SHALLOW:5,BRIDGE:6,UP_STAIRS:7,DOWN_STAIRS:17,IMPREGNABLE:8,TILEMAP:e,SEQ:r,initSeqence:o,fillCostGrid:n,isPassable:h,isNothing:s,isDiggable:l,isFloor:a,isDoor:f,isBridge:u,isWall:c,isObstruction:d,isStairs:g,isDeep:m,isShallow:w,isAnyWater:p,setGrid:y};const R=i.utils.DIRS;function D(t,e,o,n){const h=o.hall?o.hall.doors:o.doors;for(let s=0;s<r.length;s++){const l=Math.floor(r[s]/t.height),a=r[s]%t.height;if(0!=t.get(l,a))continue;const f=b(t,l,a);if(f!=i.utils.NO_DIRECTION){const r=(f+2)%4,s=h[r];if(!s)continue;const u=l-s[0],c=a-s[1];if(-1!=s[0]&&A(t,e,u,c))return i.grid.offsetZip(t,e,u,c,((i,e,r,o)=>{t[r][o]=n.room.tile||1})),O(t,o,n,l,a,r),o.translate(u,c),!0}}return!1}function O(t,e,r,o,n,h){if(0===r.door)return;const s=r.door||2;if(t[o][n]=s,e.hall&&e.hall.width>1&&e.hall.dir===h)if(h===i.utils.UP||h===i.utils.DOWN){let i=!0,e=1;for(;i;)i=!1,0===t.get(o-e,n)&&t.get(o-e,n-1)&&t.get(o-e,n+1)&&(t[o-e][n]=s,i=!0),0===t.get(o+e,n)&&t.get(o+e,n-1)&&t.get(o+e,n+1)&&(t[o+e][n]=s,i=!0),++e}else{let i=!0,e=1;for(;i;)i=!1,0===t.get(o,n-e)&&t.get(o-1,n-e)&&t.get(o+1,n-e)&&(t[o][n-e]=r.door,i=!0),0===t.get(o,n+e)&&t.get(o-1,n+e)&&t.get(o+1,n+e)&&(t[o][n+e]=r.door,i=!0),++e}}function A(t,i,e,r){let o,n,h,s,l,a;for(o=0;o<i.width;o++)for(n=0;n<i.height;n++)if(i[o][n])for(h=o+e,s=n+r,l=h-1;l<=h+1;l++)for(a=s-1;a<=s+1;a++)if(!t.hasXY(l,a)||t.isBoundaryXY(l,a)||0!==t.get(l,a))return!1;return!0}function b(t,e,r){let o,n,h,s,l,f;for(n=i.utils.NO_DIRECTION,o=0;o<4;o++)if(h=e+R[o][0],s=r+R[o][1],l=e-R[o][0],f=r-R[o][1],t.hasXY(l,f)&&t.hasXY(h,s)&&a(t,l,f)){if(n!=i.utils.NO_DIRECTION)return i.utils.NO_DIRECTION;n=o}return n}function _(t,e,r,o,n){const h=i.random.sequence(e.length);for(let i=0;i<h.length;i++){const s=e[h[i]];if(!s)continue;if(E(t,s[0],s[1],r,o,n))return!0}return!1}function E(t,e,r,o,n,h){const s=n.hall?n.hall.doors:n.doors,l=i.random.sequence(4);for(let a of l){const l=(a+2)%4,f=s[l];if(f&&(-1!=f[0]&&A(t,o,e-f[0],r-f[1]))){const s=e-f[0],a=r-f[1];return i.grid.offsetZip(t,o,s,a,((i,e,r,o)=>{t[r][o]=h.room.tile||1})),O(t,n,h,e,r,l),n.translate(s,a),!0}}return!1}function I(t,e){let r,o,n,h,s,l,a;const f=[[],[],[],[]],u=t.height,c=t.width;for(r=0;r<c;r++)for(o=0;o<u;o++)if(!t[r][o]&&(l=b(t,r,o),l!=i.utils.NO_DIRECTION)){for(h=r+R[l][0],s=o+R[l][1],a=!1,n=0;n<10&&t.hasXY(h,s)&&!a;n++)t[h][s]&&(a=!0),h+=R[l][0],s+=R[l][1];a||f[l].push([r,o])}let d=[];for(l=0;l<4;l++){const t=i.random.item(f[l])||[-1,-1];d[l]=[t[0],t[1]]}return d}var N={__proto__:null,attachRoom:D,attachDoor:O,roomFitsAt:A,directionOfDoorSite:b,forceRoomAtMapLoc:function(t,e,o,n,h){for(let s=0;s<r.length;s++){const l=Math.floor(r[s]/t.height),a=r[s]%t.height;if(o[l][a])continue;if(b(o,l,a)!=i.utils.NO_DIRECTION){const r=e[0]-l,s=e[1]-a;if(A(t,o,r,s)){if(i.grid.offsetZip(t,o,r,s,((i,e,r,o)=>{t[r][o]=h.room.tile||1})),!1!==h.room.door){const i=!0!==h.room.door&&h.room.door?h.room.door:2;t[e[0]][e[1]]=i}return n.translate(r,s),!0}}}return!1},attachRoomAtMapDoor:_,chooseRandomDoorSites:I};class x{constructor(t,e,r,o=1){this.width=1,this.doors=[],this.x=t[0],this.y=t[1];const n=i.utils.DIRS[e];this.length=r,this.width=o,e===i.utils.UP||e===i.utils.DOWN?(this.x2=this.x+(o-1),this.y2=this.y+(r-1)*n[1]):(this.x2=this.x+(r-1)*n[0],this.y2=this.y+(o-1)),this.dir=e}translate(t,i){this.x+=t,this.y+=i,this.x2+=t,this.y2+=i,this.doors&&this.doors.forEach((e=>{e&&(e[0]<0||e[1]<0||(e[0]+=t,e[1]+=i))}))}}class F{constructor(t,i,e,r,o){this.doors=[],this.hall=null,this.digger=t,this.x=i,this.y=e,this.width=r,this.height=o}get cx(){return this.x+Math.floor(this.width/2)}get cy(){return this.y+Math.floor(this.height/2)}translate(t,i){this.x+=t,this.y+=i,this.doors&&this.doors.forEach((e=>{e&&(e[0]<0||e[1]<0||(e[0]+=t,e[1]+=i))})),this.hall&&this.hall.translate(t,i)}}const S=i.utils.DIRS;var L={};function T(t,i,e={}){const r=i(e||{});return r.fn=i,r.id=t,L[t]=r,r}function v(t={}){return i.utils.clamp(function(t){if(!t)return 1;if("number"==typeof t)return t;if(void 0===t.width)return 1;let e=t.width;if("number"==typeof e)return e;e=Array.isArray(e)?i.random.weighted(e)+1:"string"==typeof e?i.range.make(e).value():Number.parseInt(i.random.weighted(e));return e}(t),1,3)}function X(t,e){return e.length||(e.length=[]),Array.isArray(e.length)?t==i.utils.UP||t==i.utils.DOWN?i.range.make(e.length[1]||[2,9]):i.range.make(e.length[0]||[9,15]):i.range.make(e.length)}function Y(t,e,r){const o=e.doors;let n=r.dir||i.utils.NO_DIRECTION;if(n==i.utils.NO_DIRECTION){const e=i.random.sequence(4);for(let h=0;h<4;h++){n=e[h];const s=X(n,r).hi,l=o[n];if(l&&-1!=l[0]&&-1!=l[1]){const i=l[0]+Math.floor(S[n][0]*s),e=l[1]+Math.floor(S[n][1]*s);if(t.hasXY(i,e))break}n=i.utils.NO_DIRECTION}}return n}function C(t,e,r,o,n){let h,s;const l=i.utils.firstOpt("obliqueChance",n,15),a=i.random.chance(l),f=[];for(let i=0;i<4;i++)h=e+S[i][0],s=r+S[i][1],i!=o&&!a||!t.hasXY(h,s)||t[h][s]||(f[i]=[h,s]);return f}function W(t,e,r){if((t=t||{}).width=1,!e)return t;const o=Y(e,r,t);if(o===i.utils.NO_DIRECTION)return null;const n=X(o,t).value(),h=r.doors[o],s=S[o];let l=h[0],a=h[1];const f=t.tile||1;for(let t=0;t<n;t++)e[l][a]=f,l+=s[0],a+=s[1];l-=s[0],a-=s[1];const u=new x(h,o,n);return u.doors=C(e,l,a,o,t),u}T("DEFAULT",W,{chance:15});var B={__proto__:null,halls:L,install:T,pickWidth:v,pickLengthRange:X,pickHallDirection:Y,pickHallExits:C,digWide:function(t,e,r){if((t=t||{}).width||(t.width=2),!e)return t;const o=Y(e,r,t);if(o===i.utils.NO_DIRECTION)return null;const n=X(o,t).value(),h=v(t)||2,s=r.doors[o],l=t.tile||1,a=[];let f,u,c;if(o===i.utils.UP){f=i.utils.clamp(s[0],r.x,r.x+r.width-h),u=s[1]-n+1;for(let t=f;t<f+h;++t)for(let i=u;i<u+n;++i)e[t][i]=l;a[o]=[f,u-1],c=new x([f,s[1]],o,n,2)}else if(o===i.utils.DOWN){f=i.utils.clamp(s[0],r.x,r.x+r.width-h),u=s[1]+n-1;for(let t=f;t<f+h;++t)for(let i=u;i>u-n;--i)e[t][i]=l;a[o]=[f,u+1],c=new x([f,s[1]],o,n,2)}else if(o===i.utils.LEFT){f=s[0]-n+1,u=i.utils.clamp(s[1],r.y,r.y+r.height-h);for(let t=f;t<f+n;++t)for(let i=u;i<u+h;++i)e[t][i]=l;a[o]=[f-1,u],c=new x([s[0],u],o,n,2)}else{f=s[0]+n-1,u=i.utils.clamp(s[1],r.y,r.y+r.height-h);for(let t=f;t>f-n;--t)for(let i=u;i<u+h;++i)e[t][i]=l;a[o]=[f+1,u],c=new x([s[0],u],o,n,h)}return c.doors=a,c.width=h,c},dig:W},P={};function k(t,i,e){const r=i(e||{});return r.fn=i,r.id=t,P[t]=r,r}function U(t,e){return t=t||{},e=e||{},Object.entries(e).forEach((([e,r])=>{let o=t[e];if("tile"===e)return void(void 0===o&&(t[e]=r));if(!0===r){if(!o)return i.utils.ERROR("Missing required config for digger: "+e)}else o=("number"==typeof r||Array.isArray(r),o||r);const n=i.range.make(o);t[e]=n})),t}function G(t,i){if(t=U(t,{width:[3,6],height:[3,6]}),!i)return t;const e=t.width.value(),r=t.height.value(),o=t.tile||1;i.fill(0);const n=Math.floor((i.width-e)/2),h=Math.floor((i.height-r)/2);return i.fillRect(n,h,e,r,o),new F(t.id,n,h,e,r)}k("DEFAULT",G);var q={__proto__:null,rooms:P,install:k,checkConfig:U,cavern:function(t,e){if(t=U(t,{width:12,height:8}),!e)return t;let r,o,n;const h=t.width.value(),s=t.height.value(),l=t.tile||1;n=i.grid.alloc(e.width,e.height,0);const a=Math.floor(.5*h),f=h,u=Math.floor(.5*s),c=s;e.fill(0);const d=n.fillBlob(5,a,u,f,c,55,"ffffffttt","ffffttttt");return r=Math.floor((e.width-d.width)/2),o=Math.floor((e.height-d.height)/2),i.grid.offsetZip(e,n,r-d.x,o-d.y,l),i.grid.free(n),new F(t.id,r,o,d.width,d.height)},choiceRoom:function(t,e){let r;if(t=t||{},Array.isArray(t.choices)?r=i.random.item.bind(i.random,t.choices):"object"==typeof t.choices?r=i.random.weighted.bind(i.random,t.choices):i.utils.ERROR("Expected choices to be either array of room ids or map - ex: { ROOM_ID: weight }"),!e)return t;let o=r();const n=P[o];n||i.utils.ERROR("Missing digger choice: "+o);let h=n;return t.opts&&(h=Object.assign({},n,t.opts)),n.fn(h,e)},entrance:function(t,i){if(t=U(t,{width:20,height:10}),!i)return t;const e=t.width.value(),r=t.height.value(),o=t.tile||1,n=Math.floor(.4*e),h=r,s=e,l=Math.floor(.5*r),a=Math.floor(i.width/2-n/2-1),f=i.height-h-2,u=Math.floor(i.width/2-s/2-1),c=i.height-l-2;return i.fill(0),i.fillRect(a,f,n,h,o),i.fillRect(u,c,s,l,o),new F(t.id,Math.min(a,u),Math.min(f,c),Math.max(n,s),Math.max(h,l))},cross:function(t,e){if(t=U(t,{width:12,height:20}),!e)return t;const r=t.width.value(),o=t.height.value(),n=t.tile||1,h=r,s=Math.max(3,Math.floor(r*i.random.range(25,75)/100)),l=Math.max(3,Math.floor(o*i.random.range(25,75)/100)),a=o,f=Math.floor((e.width-h)/2),u=f+i.random.range(2,Math.max(2,h-s-2)),c=Math.floor((e.height-a)/2),d=c+i.random.range(2,Math.max(2,a-l-2));return e.fill(0),e.fillRect(f,d,h,l,n),e.fillRect(u,c,s,a,n),new F(t.id,f,c,Math.max(h,s),Math.max(l,a))},symmetricalCross:function(t,e){if(t=U(t,{width:7,height:7}),!e)return t;const r=t.width.value(),o=t.height.value(),n=t.tile||1;let h=Math.max(3,Math.floor(r*i.random.range(25,50)/100)),s=Math.max(3,Math.floor(o*i.random.range(25,50)/100));e.fill(0);const l=Math.floor((e.width-r)/2),a=Math.floor((e.height-s)/2);e.fillRect(l,a,r,s,n);const f=Math.floor((e.width-h)/2),u=Math.floor((e.height-o)/2);return e.fillRect(f,u,h,o,n),new F(t.id,Math.min(l,f),Math.min(a,u),Math.max(r,h),Math.max(o,s))},rectangular:G,circular:function(t,i){if(t=U(t,{radius:[3,4]}),!i)return t;const e=t.radius.value(),r=t.tile||1;i.fill(0);const o=Math.floor(i.width/2),n=Math.floor(i.height/2);return e>1&&i.fillCircle(o,n,e,r),new F(t.id,o-e,n-e,2*e+1,2*e+1)},brogueDonut:function(t,e){if(t=U(t,{radius:[5,10],ringMinWidth:3,holeMinSize:3,holeChance:50}),!e)return t;const r=t.radius.value(),o=t.ringMinWidth.value(),n=t.holeMinSize.value(),h=t.tile||1;e.fill(0);const s=Math.floor(e.width/2),l=Math.floor(e.height/2);return e.fillCircle(s,l,r,h),r>o+n&&i.random.chance(t.holeChance.value())&&e.fillCircle(s,l,i.random.range(n,r-n),0),new F(t.id,s-r,l-r,2*r+1,2*r+1)},chunkyRoom:function(t,e){if(t=U(t,{count:[2,12],width:[5,20],height:[5,20]}),!e)return t;let r,o,n,h,s,l,a,f=t.count.value();const u=t.width.value(),c=t.height.value(),d=t.tile||1;for(h=Math.floor(e.width/2)-Math.floor(u/2),s=Math.floor(e.width/2)+Math.floor(u/2),l=Math.floor(e.height/2)-Math.floor(c/2),a=Math.floor(e.height/2)+Math.floor(c/2),e.fill(0),e.fillCircle(Math.floor(e.width/2),Math.floor(e.height/2),2,d),r=0;r<f;)if(o=i.random.range(h,s),n=i.random.range(l,a),e[o][n]){if(o-2<h)continue;if(o+2>s)continue;if(n-2<l)continue;if(n+2>a)continue;e.fillCircle(o,n,2,d),r++}const g=e.valueBounds(d);return new F(t.id,g.x,g.y,g.width,g.height)}};class H{constructor(t,i,e,r){this.width=t,this.height=i,this.disruptsFn=e,this.passableFn=r}create(t,e={}){let r,o,n,h,s,l,a,f,u,c,d,g=0;l=e.height||15,a=e.width||30,f=e.minSize||5,u=e.tries||20,c=e.count||1,d=e.canDisrupt||!1;const m=e.wreath||0,w=e.wreathTile||5,p=e.tile||4,y=i.grid.alloc(this.width,this.height,0);let M=0;for(;M<c&&g<c;){const e=Math.round((a-f)*(c-M)/c)+f,R=Math.round((l-f)*(c-M)/c)+f;y.fill(0);const D=y.fillBlob(5,4,4,e,R,55,"ffffftttt","ffffttttt");let O=!1;for(n=0;n<u&&!O;n++)if(h=i.random.range(1-D.x,y.width-D.width-D.x-2),s=i.random.range(1-D.y,y.height-D.height-D.y-2),d||!this.isDisruptedBy(y,-h,-s)){for(O=!0,r=0;r<D.width;r++)for(o=0;o<D.height;o++)if(y[r+D.x][o+D.y]){const e=r+D.x+h,n=o+D.y+s;t(e,n,p),m&&i.utils.forCircle(e,n,m,((i,e)=>{this.passableFn(i,e)&&t(i,e,w)}))}break}O?++g:++M}return i.grid.free(y),g}isDisruptedBy(t,e=0,r=0){const o=i.grid.alloc(this.width,this.height);let n=!1;i.utils.forRect(this.width,this.height,((i,h)=>{const s=i+e,l=h+r;t.get(s,l)?this.disruptsFn(i,h)&&(n=!0):this.passableFn(i,h)&&(o[i][h]=1)}));let h=!0;for(let t=0;t<o.width&&!n;++t)for(let i=0;i<o.height&&!n;++i)1==o[t][i]&&(h?(o.floodFill(t,i,1,2),h=!1):n=!0);return i.grid.free(o),n}}function j(t,i={}){return new H(t.width,t.height,g.bind(M,t),h.bind(M,t)).create(y.bind(M,t),i)}var K={__proto__:null,digLakes:j};class Z{constructor(t,i,e,r,o){this.width=t,this.height=i,this.isAnyWaterFn=e,this.isBridgeFn=o,this.isPassableFn=r}create(t,e={}){let r,o,n,h,s,l,a,f=0;const u=e.maxConnectionLength||5,c=e.minimumPathingDistance||20,d=i.grid.alloc(this.width,this.height),g=i.grid.alloc(this.width,this.height),m=[[1,0],[0,1]];g.update(((t,e,r)=>this.isPassableFn(e,r)?1:i.path.OBSTRUCTION));const w=i.random.sequence(this.width*this.height);for(n=0;n<w.length;n++)if(l=Math.floor(w[n]/this.height),a=w[n]%this.height,this.isPassableFn(l,a)&&!this.isAnyWaterFn(l,a))for(s=0;s<=1;s++){const e=m[s];if(r=l+e[0],o=a+e[1],h=u,this.isAnyWaterFn(r,o))for(h=0;h<u&&(r+=e[0],o+=e[1],this.isAnyWaterFn(r,o));++h);if(this.isPassableFn(r,o)&&h<u&&(i.path.calculateDistances(d,r,o,g,!1),d[l][a]>c&&d[l][a]<i.path.NO_PATH)){for(;l!==r||a!==o;)this.isBridgeCandidate(l,a,e)?(t(l,a,6),g[l][a]=1):(t(l,a,1),g[l][a]=1),l+=e[0],a+=e[1];++f;break}}return i.grid.free(d),i.grid.free(g),f}isBridgeCandidate(t,i,e){return!!this.isBridgeFn(t,i)||!!this.isAnyWaterFn(t,i)&&(!!this.isAnyWaterFn(t+e[1],i+e[0])&&!!this.isAnyWaterFn(t-e[1],i-e[0]))}}function z(t,i,e){return new Z(t.width,t.height,p.bind(M,t),h.bind(M,t),u.bind(M,t)).create(y.bind(M,t),{minimumPathingDistance:i,maxConnectionLength:e})}var Q={__proto__:null,Bridges:Z,digBridges:z};class V{constructor(t,i,e,r){this.width=t,this.height=i,this.isFloorFn=e,this.isDiggableFn=r}create(t,e={}){let r=!1!==e.up,o=!1!==e.down;const n=e.minDistance||Math.floor(Math.max(this.width,this.height)/2),h=e.isValidXY||this.isStairXY.bind(this),s=e.setup||this.setupStairs.bind(this),l={};let a,f;if(e.start&&"string"!=typeof e.start){let t=e.start;t=!0===t?i.random.matchingXY(this.width,this.height,h):i.random.matchingXYNear(i.utils.x(t),i.utils.y(t),h),l.start=t}if(Array.isArray(e.up)&&Array.isArray(e.down)){const t=e.up;a=i.random.matchingXYNear(i.utils.x(t),i.utils.y(t),h);const r=e.down;f=i.random.matchingXYNear(i.utils.x(r),i.utils.y(r),h)}else if(Array.isArray(e.up)&&!Array.isArray(e.down)){const t=e.up;a=i.random.matchingXYNear(i.utils.x(t),i.utils.y(t),h),o&&(f=i.random.matchingXY(this.width,this.height,((t,e)=>!(i.utils.distanceBetween(t,e,a[0],a[1])<n)&&h(t,e))))}else if(Array.isArray(e.down)&&!Array.isArray(e.up)){const t=e.down;f=i.random.matchingXYNear(i.utils.x(t),i.utils.y(t),h),r&&(a=i.random.matchingXY(this.width,this.height,((t,e)=>!(i.utils.distanceBetween(t,e,f[0],f[1])<n)&&h(t,e))))}else r?(a=i.random.matchingXY(this.width,this.height,h),o&&(f=i.random.matchingXY(this.width,this.height,((t,e)=>!(i.utils.distanceBetween(t,e,a[0],a[1])<n)&&h(t,e))))):o&&(f=i.random.matchingXY(this.width,this.height,h));return a&&(l.up=a.slice(),s(a[0],a[1],t,e.upTile||7,e.wall||8),"up"===e.start&&(l.start=l.up)),void 0!==f&&(l.down=f.slice(),s(f[0],f[1],t,e.downTile||17,e.wall||8),"down"===e.start&&(l.start=l.down)),a||f?l:null}hasXY(t,i){return!(t<0||i<0)&&!(t>=this.width||i>=this.height)}isStairXY(t,e){let r=0;if(!this.hasXY(t,e)||!this.isDiggableFn(t,e))return!1;for(let o=0;o<4;++o){const n=i.utils.DIRS[o];if(!this.hasXY(t+n[0],e+n[1]))return!1;if(!this.hasXY(t-n[0],e-n[1]))return!1;if(this.isFloorFn(t+n[0],e+n[1])){if(r+=1,!this.isDiggableFn(t-n[0]+n[1],e-n[1]+n[0]))return!1;if(!this.isDiggableFn(t-n[0]-n[1],e-n[1]-n[0]))return!1}else if(!this.isDiggableFn(t+n[0],e+n[1]))return!1}return 1==r}setupStairs(t,e,r,o,n){const h=i.random.sequence(4);let s=null;for(let r=0;r<h.length;++r){s=i.utils.DIRS[r];const o=t+s[0],n=e+s[1];if(this.isFloorFn(o,n)&&this.isDiggableFn(t-s[0],e-s[1]))break;s=null}s||i.utils.ERROR("No stair direction found!"),r(t,e,o);const l=i.utils.CLOCK_DIRS.findIndex((t=>t[0]==s[0]&&t[1]==s[1]));for(let o=0;o<i.utils.CLOCK_DIRS.length;++o){const h=o?o-1:7,s=(o+1)%8;if(o==l||h==l||s==l)continue;const a=i.utils.CLOCK_DIRS[o];r(t+a[0],e+a[1],n)}return!0}}function J(t,i={}){return new V(t.width,t.height,a.bind(M,t),l.bind(M,t)).create(y.bind(M,t),i)}function $(t){let e,r,o,n,s,l;do{for(l=!1,e=0;e<t.width-1;e++)for(r=0;r<t.height-1;r++)for(o=0;o<=1;o++)h(t,e+o,r)&&!h(t,e+(1-o),r)&&d(t,e+(1-o),r)&&!h(t,e+o,r+1)&&d(t,e+o,r+1)&&h(t,e+(1-o),r+1)&&(i.random.chance(50)?(n=e+(1-o),s=r):(n=e+o,s=r+1),l=!0,t[n][s]=1)}while(1==l)}function tt(t){t.forEach(((i,e,r)=>{t.isBoundaryXY(e,r)||2==i&&(1!=t.get(e+1,r)&&1!=t.get(e-1,r)||1!=t.get(e,r+1)&&1!=t.get(e,r-1)?(1!==t.get(e+1,r)?1:0)+(1!==t.get(e-1,r)?1:0)+(1!==t.get(e,r+1)?1:0)+(1!==t.get(e,r-1)?1:0)>=3&&(t[e][r]=1):t[e][r]=1)}))}function it(t,i=3){t.forEach(((e,r,o)=>{0==e&&(t[r][o]=i)}))}var et={__proto__:null,room:q,hall:B,lake:K,bridge:Q,stairs:{__proto__:null,Stairs:V,addStairs:J},utils:N,start:function(t){o(t.width*t.height),t.fill(0)},finish:function(t){$(t),it(t),tt(t)},addRoom:function(t,e){if("string"==typeof(e=e||{room:"DEFAULT",hall:"DEFAULT",tries:10})&&(e={room:e}),e.loc&&(e.locs=[e.loc]),e.room||(e.room="DEFAULT"),"function"==typeof e.room&&(e.room={fn:e.room}),"string"==typeof e.room){const t=e.room;e.room=P[t],e.room||i.utils.ERROR("Failed to find room: "+t)}const r=e.room;let o=null;if(!0===e.hall&&(e.hall="DEFAULT"),!1===e.hall||e.hall||(e.hall="DEFAULT"),"function"==typeof e.hall&&(e.hall={fn:e.hall}),"string"==typeof e.hall){const t=e.hall;if(e.hall=L[t],!e.hall)return i.utils.ERROR("Failed to find hall: "+t),null;o=e.hall}else e.hall&&e.hall.fn&&(o=e.hall);!1===e.door?e.door=0:!0===e.door?e.door=2:"number"==typeof e.door?e.door=i.random.chance(e.door)?2:1:e.door=1;let n=e.locs||null;if(n&&n.doors&&(n=n.doors),n&&Array.isArray(n))n&&n.length&&2==n.length&&"number"==typeof n[0]?n=[n]:0==n.length&&(n=null);else if(n=null,0===t.count(1)){n=[[Math.floor(t.width/2),t.height-2]]}const h=e.room,s=i.grid.alloc(t.width,t.height);let l=!1;if(o){let t=void 0!==o.chance?o.chance:15;l=i.random.chance(t)}let a,f=!1,u=e.tries||10;for(;--u>=0&&!f;)s.fill(0),a=h.fn(r,s),a.doors=I(s),l&&o&&(a.hall=o.fn(o,s,a)),f=n?_(t,n,s,a,e):D(t,s,a,e);return i.grid.free(s),a&&f?a:null},addLoops:function(t,e,o){let s,l,a,u,c,d,g,m,w;e=e||Math.floor(Math.min(t.width,t.height)/2),o=o||1;const p=t,y=i.grid.alloc(t.width,t.height),M=i.grid.alloc(t.width,t.height),R=[[1,0],[0,1]];function D(i,e,r){return!!t.hasXY(i,e)&&(!!t.hasXY(i+r[1],e+r[0])&&(!!t.hasXY(i-r[1],e-r[0])&&(!t.get(i,e)&&(!t.get(i+r[1],e+r[0])&&!t.get(i-r[1],e-r[0])))))}function O(i,e,r){return!!t.hasXY(i,e)&&(!!t.hasXY(i+r[1],e+r[0])&&(!!t.hasXY(i-r[1],e-r[0])&&(!!t.get(i,e)||(!!t.get(i+r[1],e+r[0])||!!t.get(i-r[1],e-r[0])))))}for(n(t,M),c=0;c<r.length;c++){m=Math.floor(r[c]/p.height),w=r[c]%p.height;if(!p[m][w])for(g=0;g<=1;g++){let r=R[g];if(D(m,w,r)){if(d=o,t.hasXY(m+r[0],w+r[1])&&h(t,m+r[0],w+r[1])){if(!t.hasXY(m-r[0],w-r[1])||f(t,m-r[0],w-r[1]))continue}else{if(!t.hasXY(m-r[0],w-r[1])||!h(t,m-r[0],w-r[1]))continue;if(!t.hasXY(m+r[0],w+r[1])||f(t,m+r[0],w+r[1]))continue;r=r.map((t=>-1*t))}for(s=m+r[0],l=w+r[1],a=m,u=w,d=0;d<o&&(a-=r[0],u-=r[1],!O(a,u,r));++d);if(d<o&&(i.path.calculateDistances(y,s,l,M,!1),y[a][u]>e&&y[a][u]<3e4)){for(;a!==s||u!==l;)0==t.get(a,u)&&(t[a][u]=1,M[a][u]=1),a+=r[0],u+=r[1];t[m][w]=2;break}}}}i.grid.free(y),i.grid.free(M)},addLakes:function(t,i){return j(t,i)},addBridges:function(t,i,e){return z(t,i,e)},addStairs:function(t,i={}){return J(t,i)},removeDiagonalOpenings:$,finishDoors:tt,finishWalls:it,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,DEEP:4,SHALLOW:5,BRIDGE:6,UP_STAIRS:7,DOWN_STAIRS:17,IMPREGNABLE:8,TILEMAP:e,SEQ:r,initSeqence:o,fillCostGrid:n,isPassable:h,isNothing:s,isDiggable:l,isFloor:a,isDoor:f,isBridge:u,isWall:c,isObstruction:d,isStairs:g,isDeep:m,isShallow:w,isAnyWater:p,setGrid:y,Hall:x,Room:F};t.dig=et,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-dig.min.js.map

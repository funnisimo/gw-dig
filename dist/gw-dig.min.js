!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,i){"use strict";const e={0:"NULL",1:"FLOOR",2:"DOOR",3:"WALL",8:"IMPREGNABLE",4:"LAKE",5:"SHALLOW",6:"BRIDGE",7:"UP_STAIRS",17:"DOWN_STAIRS"},o=[];function n(t){o.length=t;for(let i=0;i<t;++i)o[i]=i;i.random.shuffle(o)}function r(t,e){t.forEach(((o,n,r)=>{e[n][r]=l(t,n,r)?1:i.path.OBSTRUCTION}))}function l(t,i,e){return s(t,i,e)||a(t,i,e)||f(t,i,e)||d(t,i,e)||m(t,i,e)}function h(t,i,e){return 0===t.get(i,e)}function s(t,i,e){return 1==t.get(i,e)}function a(t,i,e){return 2===t.get(i,e)}function f(t,i,e){return 6===t.get(i,e)}function u(t,i,e){const o=t.get(i,e);return 3===o||8===o}function c(t,i,e){return h(t,i,e)||u(t,i,e)}function d(t,i,e){const o=t.get(i,e);return 7===o||17===o}function g(t,i,e){return 4===t.get(i,e)}function m(t,i,e){return 5===t.get(i,e)}function w(t,i,e){return g(t,i,e)||m(t,i,e)}function M(t,i,e,o){t.hasXY(i,e)&&(t[i][e]=o)}var p={__proto__:null,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,DEEP:4,SHALLOW:5,BRIDGE:6,UP_STAIRS:7,DOWN_STAIRS:17,IMPREGNABLE:8,TILEMAP:e,SEQ:o,initSeqence:n,fillCostGrid:r,isPassable:l,isNothing:h,isFloor:s,isDoor:a,isBridge:f,isWall:u,isObstruction:c,isStairs:d,isDeep:g,isShallow:m,isAnyWater:w,setGrid:M};const R=i.utils.DIRS;function y(t,e,n,r){const l=n.hall?n.hall.doors:n.doors;for(let h=0;h<o.length;h++){const s=Math.floor(o[h]/t.height),a=o[h]%t.height;if(0!=t.get(s,a))continue;const f=_(t,s,a);if(f!=i.utils.NO_DIRECTION){const o=(f+2)%4,h=l[o];if(!h)continue;const u=s-h[0],c=a-h[1];if(-1!=h[0]&&D(t,e,u,c))return i.grid.offsetZip(t,e,u,c,((i,e,o,n)=>{t[o][n]=r.room.tile||1})),O(t,n,r,s,a,o),n.translate(u,c),!0}}return!1}function O(t,e,o,n,r,l){if(0===o.door)return;const h=o.door||2;if(t[n][r]=h,e.hall&&e.hall.width>1&&e.hall.dir===l)if(l===i.utils.UP||l===i.utils.DOWN){let i=!0,e=1;for(;i;)i=!1,0===t.get(n-e,r)&&t.get(n-e,r-1)&&t.get(n-e,r+1)&&(t[n-e][r]=h,i=!0),0===t.get(n+e,r)&&t.get(n+e,r-1)&&t.get(n+e,r+1)&&(t[n+e][r]=h,i=!0),++e}else{let i=!0,e=1;for(;i;)i=!1,0===t.get(n,r-e)&&t.get(n-1,r-e)&&t.get(n+1,r-e)&&(t[n][r-e]=o.door,i=!0),0===t.get(n,r+e)&&t.get(n-1,r+e)&&t.get(n+1,r+e)&&(t[n][r+e]=o.door,i=!0),++e}}function D(t,i,e,o){let n,r,l,h,s,a;for(n=0;n<i.width;n++)for(r=0;r<i.height;r++)if(i[n][r])for(l=n+e,h=r+o,s=l-1;s<=l+1;s++)for(a=h-1;a<=h+1;a++)if(!t.hasXY(s,a)||t.isBoundaryXY(s,a)||0!==t.get(s,a))return!1;return!0}function _(t,e,o){let n,r,l,h,a,f;for(r=i.utils.NO_DIRECTION,n=0;n<4;n++)if(l=e+R[n][0],h=o+R[n][1],a=e-R[n][0],f=o-R[n][1],t.hasXY(a,f)&&t.hasXY(l,h)&&s(t,a,f)){if(r!=i.utils.NO_DIRECTION)return i.utils.NO_DIRECTION;r=n}return r}function L(t,e,o,n,r){const l=i.random.sequence(e.length);for(let i=0;i<l.length;i++){const h=e[l[i]];if(!h)continue;if(A(t,h[0],h[1],o,n,r))return!0}return!1}function A(t,e,o,n,r,l){const h=r.hall?r.hall.doors:r.doors,s=i.random.sequence(4);for(let a of s){const s=(a+2)%4,f=h[s];if(f&&(-1!=f[0]&&D(t,n,e-f[0],o-f[1]))){const h=e-f[0],a=o-f[1];return i.grid.offsetZip(t,n,h,a,((i,e,o,n)=>{t[o][n]=l.room.tile||1})),O(t,r,l,e,o,s),r.translate(h,a),!0}}return!1}function E(t,e){let o,n,r,l,h,s,a;const f=[[],[],[],[]],u=t.height,c=t.width;for(o=0;o<c;o++)for(n=0;n<u;n++)if(!t[o][n]&&(s=_(t,o,n),s!=i.utils.NO_DIRECTION)){for(l=o+R[s][0],h=n+R[s][1],a=!1,r=0;r<10&&t.hasXY(l,h)&&!a;r++)t[l][h]&&(a=!0),l+=R[s][0],h+=R[s][1];a||f[s].push([o,n])}let d=[];for(s=0;s<4;s++){const t=i.random.item(f[s])||[-1,-1];d[s]=[t[0],t[1]]}return d}var I={__proto__:null,attachRoom:y,attachDoor:O,roomFitsAt:D,directionOfDoorSite:_,forceRoomAtMapLoc:function(t,e,n,r,l){for(let h=0;h<o.length;h++){const s=Math.floor(o[h]/t.height),a=o[h]%t.height;if(n[s][a])continue;if(_(n,s,a)!=i.utils.NO_DIRECTION){const o=e[0]-s,h=e[1]-a;if(D(t,n,o,h)){if(i.grid.offsetZip(t,n,o,h,((i,e,o,n)=>{t[o][n]=l.room.tile||1})),!1!==l.room.door){const i=!0!==l.room.door&&l.room.door?l.room.door:2;t[e[0]][e[1]]=i}return r.translate(o,h),!0}}}return!1},attachRoomAtMapDoor:L,chooseRandomDoorSites:E};class N{constructor(t,e,o,n=1){this.width=1,this.doors=[],this.x=t[0],this.y=t[1];const r=i.utils.DIRS[e];this.length=o,this.width=n,e===i.utils.UP||e===i.utils.DOWN?(this.x2=this.x+(n-1),this.y2=this.y+(o-1)*r[1]):(this.x2=this.x+(o-1)*r[0],this.y2=this.y+(n-1)),this.dir=e}translate(t,i){this.x+=t,this.y+=i,this.x2+=t,this.y2+=i,this.doors&&this.doors.forEach((e=>{e&&(e[0]<0||e[1]<0||(e[0]+=t,e[1]+=i))}))}}class x{constructor(t,i,e,o,n){this.doors=[],this.hall=null,this.digger=t,this.x=i,this.y=e,this.width=o,this.height=n}get cx(){return this.x+Math.floor(this.width/2)}get cy(){return this.y+Math.floor(this.height/2)}translate(t,i){this.x+=t,this.y+=i,this.doors&&this.doors.forEach((e=>{e&&(e[0]<0||e[1]<0||(e[0]+=t,e[1]+=i))})),this.hall&&this.hall.translate(t,i)}}const b=i.utils.DIRS;var S={};function T(t,i,e={}){const o=i(e||{});return o.fn=i,o.id=t,S[t]=o,o}function v(t={}){return i.utils.clamp(function(t){if(!t)return 1;if("number"==typeof t)return t;if(void 0===t.width)return 1;let e=t.width;if("number"==typeof e)return e;e=Array.isArray(e)?i.random.weighted(e)+1:"string"==typeof e?i.range.make(e).value():Number.parseInt(i.random.weighted(e));return e}(t),1,3)}function C(t,e){return e.length||(e.length=[]),Array.isArray(e.length)?t==i.utils.UP||t==i.utils.DOWN?i.range.make(e.length[1]||[2,9]):i.range.make(e.length[0]||[9,15]):i.range.make(e.length)}function F(t,e,o){const n=e.doors;let r=o.dir||i.utils.NO_DIRECTION;if(r==i.utils.NO_DIRECTION){const e=i.random.sequence(4);for(let l=0;l<4;l++){r=e[l];const h=C(r,o).hi,s=n[r];if(s&&-1!=s[0]&&-1!=s[1]){const i=s[0]+Math.floor(b[r][0]*h),e=s[1]+Math.floor(b[r][1]*h);if(t.hasXY(i,e))break}r=i.utils.NO_DIRECTION}}return r}function W(t,e,o,n,r){let l,h;const s=i.utils.firstOpt("obliqueChance",r,15),a=i.random.chance(s),f=[];for(let i=0;i<4;i++)l=e+b[i][0],h=o+b[i][1],i!=n&&!a||!t.hasXY(l,h)||t[l][h]||(f[i]=[l,h]);return f}function B(t,e,o){if((t=t||{}).width=1,!e)return t;const n=F(e,o,t);if(n===i.utils.NO_DIRECTION)return null;const r=C(n,t).value(),l=o.doors[n],h=b[n];let s=l[0],a=l[1];const f=t.tile||1;for(let t=0;t<r;t++)e[s][a]=f,s+=h[0],a+=h[1];s-=h[0],a-=h[1];const u=new N(l,n,r);return u.doors=W(e,s,a,n,t),u}T("DEFAULT",B,{chance:15});var P={__proto__:null,halls:S,install:T,pickWidth:v,pickLengthRange:C,pickHallDirection:F,pickHallExits:W,digWide:function(t,e,o){if((t=t||{}).width||(t.width=2),!e)return t;const n=F(e,o,t);if(n===i.utils.NO_DIRECTION)return null;const r=C(n,t).value(),l=v(t)||2,h=o.doors[n],s=t.tile||1,a=[];let f,u,c;if(n===i.utils.UP){f=i.utils.clamp(h[0],o.x,o.x+o.width-l),u=h[1]-r+1;for(let t=f;t<f+l;++t)for(let i=u;i<u+r;++i)e[t][i]=s;a[n]=[f,u-1],c=new N([f,h[1]],n,r,2)}else if(n===i.utils.DOWN){f=i.utils.clamp(h[0],o.x,o.x+o.width-l),u=h[1]+r-1;for(let t=f;t<f+l;++t)for(let i=u;i>u-r;--i)e[t][i]=s;a[n]=[f,u+1],c=new N([f,h[1]],n,r,2)}else if(n===i.utils.LEFT){f=h[0]-r+1,u=i.utils.clamp(h[1],o.y,o.y+o.height-l);for(let t=f;t<f+r;++t)for(let i=u;i<u+l;++i)e[t][i]=s;a[n]=[f-1,u],c=new N([h[0],u],n,r,2)}else{f=h[0]+r-1,u=i.utils.clamp(h[1],o.y,o.y+o.height-l);for(let t=f;t>f-r;--t)for(let i=u;i<u+l;++i)e[t][i]=s;a[n]=[f+1,u],c=new N([h[0],u],n,r,l)}return c.doors=a,c.width=l,c},dig:B},X={};function Y(t,i,e){const o=i(e||{});return o.fn=i,o.id=t,X[t]=o,o}function k(t,e){return t=t||{},e=e||{},Object.entries(e).forEach((([e,o])=>{let n=t[e];if("tile"===e)return void(void 0===n&&(t[e]=o));if(!0===o){if(!n)return i.utils.ERROR("Missing required config for digger: "+e)}else n=("number"==typeof o||Array.isArray(o),n||o);const r=i.range.make(n);t[e]=r})),t}function U(t,i){if(t=k(t,{width:[3,6],height:[3,6]}),!i)return t;const e=t.width.value(),o=t.height.value(),n=t.tile||1;i.fill(0);const r=Math.floor((i.width-e)/2),l=Math.floor((i.height-o)/2);return i.fillRect(r,l,e,o,n),new x(t.id,r,l,e,o)}Y("DEFAULT",U);var G={__proto__:null,rooms:X,install:Y,checkConfig:k,cavern:function(t,e){if(t=k(t,{width:12,height:8}),!e)return t;let o,n,r;const l=t.width.value(),h=t.height.value(),s=t.tile||1;r=i.grid.alloc(e.width,e.height,0);const a=Math.floor(.5*l),f=l,u=Math.floor(.5*h),c=h;e.fill(0);const d=r.fillBlob(5,a,u,f,c,55,"ffffffttt","ffffttttt");return o=Math.floor((e.width-d.width)/2),n=Math.floor((e.height-d.height)/2),i.grid.offsetZip(e,r,o-d.x,n-d.y,s),i.grid.free(r),new x(t.id,o,n,d.width,d.height)},choiceRoom:function(t,e){let o;if(t=t||{},Array.isArray(t.choices)?o=i.random.item.bind(i.random,t.choices):"object"==typeof t.choices?o=i.random.weighted.bind(i.random,t.choices):i.utils.ERROR("Expected choices to be either array of room ids or map - ex: { ROOM_ID: weight }"),!e)return t;let n=o();const r=X[n];r||i.utils.ERROR("Missing digger choice: "+n);let l=r;return t.opts&&(l=Object.assign({},r,t.opts)),r.fn(l,e)},entrance:function(t,i){if(t=k(t,{width:20,height:10}),!i)return t;const e=t.width.value(),o=t.height.value(),n=t.tile||1,r=Math.floor(.4*e),l=o,h=e,s=Math.floor(.5*o),a=Math.floor(i.width/2-r/2-1),f=i.height-l-2,u=Math.floor(i.width/2-h/2-1),c=i.height-s-2;return i.fill(0),i.fillRect(a,f,r,l,n),i.fillRect(u,c,h,s,n),new x(t.id,Math.min(a,u),Math.min(f,c),Math.max(r,h),Math.max(l,s))},cross:function(t,e){if(t=k(t,{width:12,height:20}),!e)return t;const o=t.width.value(),n=t.height.value(),r=t.tile||1,l=o,h=Math.max(3,Math.floor(o*i.random.range(25,75)/100)),s=Math.max(3,Math.floor(n*i.random.range(25,75)/100)),a=n,f=Math.floor((e.width-l)/2),u=f+i.random.range(2,Math.max(2,l-h-2)),c=Math.floor((e.height-a)/2),d=c+i.random.range(2,Math.max(2,a-s-2));return e.fill(0),e.fillRect(f,d,l,s,r),e.fillRect(u,c,h,a,r),new x(t.id,f,c,Math.max(l,h),Math.max(s,a))},symmetricalCross:function(t,e){if(t=k(t,{width:7,height:7}),!e)return t;const o=t.width.value(),n=t.height.value(),r=t.tile||1;let l=Math.max(3,Math.floor(o*i.random.range(25,50)/100)),h=Math.max(3,Math.floor(n*i.random.range(25,50)/100));e.fill(0);const s=Math.floor((e.width-o)/2),a=Math.floor((e.height-h)/2);e.fillRect(s,a,o,h,r);const f=Math.floor((e.width-l)/2),u=Math.floor((e.height-n)/2);return e.fillRect(f,u,l,n,r),new x(t.id,Math.min(s,f),Math.min(a,u),Math.max(o,l),Math.max(n,h))},rectangular:U,circular:function(t,i){if(t=k(t,{radius:[3,4]}),!i)return t;const e=t.radius.value(),o=t.tile||1;i.fill(0);const n=Math.floor(i.width/2),r=Math.floor(i.height/2);return e>1&&i.fillCircle(n,r,e,o),new x(t.id,n-e,r-e,2*e+1,2*e+1)},brogueDonut:function(t,e){if(t=k(t,{radius:[5,10],ringMinWidth:3,holeMinSize:3,holeChance:50}),!e)return t;const o=t.radius.value(),n=t.ringMinWidth.value(),r=t.holeMinSize.value(),l=t.tile||1;e.fill(0);const h=Math.floor(e.width/2),s=Math.floor(e.height/2);return e.fillCircle(h,s,o,l),o>n+r&&i.random.chance(t.holeChance.value())&&e.fillCircle(h,s,i.random.range(r,o-r),0),new x(t.id,h-o,s-o,2*o+1,2*o+1)},chunkyRoom:function(t,e){if(t=k(t,{count:[2,12],width:[5,20],height:[5,20]}),!e)return t;let o,n,r,l,h,s,a,f=t.count.value();const u=t.width.value(),c=t.height.value(),d=t.tile||1;for(l=Math.floor(e.width/2)-Math.floor(u/2),h=Math.floor(e.width/2)+Math.floor(u/2),s=Math.floor(e.height/2)-Math.floor(c/2),a=Math.floor(e.height/2)+Math.floor(c/2),e.fill(0),e.fillCircle(Math.floor(e.width/2),Math.floor(e.height/2),2,d),o=0;o<f;)if(n=i.random.range(l,h),r=i.random.range(s,a),e[n][r]){if(n-2<l)continue;if(n+2>h)continue;if(r-2<s)continue;if(r+2>a)continue;e.fillCircle(n,r,2,d),o++}const g=e.valueBounds(d);return new x(t.id,g.x,g.y,g.width,g.height)}};class q{constructor(t,i,e,o){this.width=t,this.height=i,this.disruptsFn=e,this.passableFn=o}create(t,e={}){let o,n,r,l,h,s,a,f,u,c,d,g=0;s=e.height||15,a=e.width||30,f=e.minSize||5,u=e.tries||20,c=e.count||1,d=e.canDisrupt||!1;const m=e.wreath||0,w=e.wreathTile||5,M=e.tile||4,p=i.grid.alloc(this.width,this.height,0);let R=0;for(;R<c&&g<c;){const e=Math.round((a-f)*(c-R)/c)+f,y=Math.round((s-f)*(c-R)/c)+f;p.fill(0);const O=p.fillBlob(5,4,4,e,y,55,"ffffftttt","ffffttttt");let D=!1;for(r=0;r<u&&!D;r++)if(l=i.random.range(1-O.x,p.width-O.width-O.x-2),h=i.random.range(1-O.y,p.height-O.height-O.y-2),d||!this.isDisruptedBy(p,-l,-h)){for(D=!0,o=0;o<O.width;o++)for(n=0;n<O.height;n++)if(p[o+O.x][n+O.y]){const e=o+O.x+l,r=n+O.y+h;t(e,r,M),m&&i.utils.forCircle(e,r,m,((i,e)=>{this.passableFn(i,e)&&t(i,e,w)}))}break}D?++g:++R}return i.grid.free(p),g}isDisruptedBy(t,e=0,o=0){const n=i.grid.alloc(this.width,this.height);let r=!1;i.utils.forRect(this.width,this.height,((i,l)=>{const h=i+e,s=l+o;t.get(h,s)?this.disruptsFn(i,l)&&(r=!0):this.passableFn(i,l)&&(n[i][l]=1)}));let l=!0;for(let t=0;t<n.width&&!r;++t)for(let i=0;i<n.height&&!r;++i)1==n[t][i]&&(l?(n.floodFill(t,i,1,2),l=!1):r=!0);return i.grid.free(n),r}}function H(t,i={}){return new q(t.width,t.height,d.bind(p,t),l.bind(p,t)).create(M.bind(p,t),i)}var j={__proto__:null,digLakes:H};class K{constructor(t,i,e,o,n){this.width=t,this.height=i,this.isAnyWaterFn=e,this.isBridgeFn=n,this.isPassableFn=o}create(t,e={}){let o,n,r,l,h,s,a,f=0;const u=e.maxConnectionLength||5,c=e.minimumPathingDistance||20,d=i.grid.alloc(this.width,this.height),g=i.grid.alloc(this.width,this.height),m=[[1,0],[0,1]];g.update(((t,e,o)=>this.isPassableFn(e,o)?1:i.path.OBSTRUCTION));const w=i.random.sequence(this.width*this.height);for(r=0;r<w.length;r++)if(s=Math.floor(w[r]/this.height),a=w[r]%this.height,this.isPassableFn(s,a)&&!this.isAnyWaterFn(s,a))for(h=0;h<=1;h++){const e=m[h];if(o=s+e[0],n=a+e[1],l=u,this.isAnyWaterFn(o,n))for(l=0;l<u&&(o+=e[0],n+=e[1],this.isAnyWaterFn(o,n));++l);if(this.isPassableFn(o,n)&&l<u&&(i.path.calculateDistances(d,o,n,g,!1),d[s][a]>c&&d[s][a]<i.path.NO_PATH)){for(;s!==o||a!==n;)this.isBridgeCandidate(s,a,e)?(t(s,a,6),g[s][a]=1):(t(s,a,1),g[s][a]=1),s+=e[0],a+=e[1];++f;break}}return i.grid.free(d),i.grid.free(g),f}isBridgeCandidate(t,i,e){return!!this.isBridgeFn(t,i)||!!this.isAnyWaterFn(t,i)&&(!!this.isAnyWaterFn(t+e[1],i+e[0])&&!!this.isAnyWaterFn(t-e[1],i-e[0]))}}function Z(t,i,e){return new K(t.width,t.height,w.bind(p,t),l.bind(p,t),f.bind(p,t)).create(M.bind(p,t),{minimumPathingDistance:i,maxConnectionLength:e})}function z(t,e,o,n){let r=0;if(!c(n,e,o))return!1;for(let t=0;t<4;++t){const l=i.utils.DIRS[t];if(!n.hasXY(e+l[0],o+l[1]))return!1;if(!n.hasXY(e-l[0],o-l[1]))return!1;if(s(n,e+l[0],o+l[1])){if(r+=1,!c(n,e-l[0]+l[1],o-l[1]+l[0]))return!1;if(!c(n,e-l[0]-l[1],o-l[1]-l[0]))return!1}else if(!c(n,e+l[0],o+l[1]))return!1}return 1==r}function Q(t,e,o,n){const r=i.random.sequence(4);let l=null;for(let n=0;n<r.length;++n){l=i.utils.DIRS[n];if(s(t,e+l[0],o+l[1])&&c(t,e-l[0],o-l[1]))break;l=null}l||i.utils.ERROR("No stair direction found!"),t.set(e,o,n);const h=i.utils.CLOCK_DIRS.findIndex((t=>t[0]==l[0]&&t[1]==l[1]));for(let n=0;n<i.utils.CLOCK_DIRS.length;++n){const r=n?n-1:7,l=(n+1)%8;if(n==h||r==h||l==h)continue;const s=i.utils.CLOCK_DIRS[n];t.set(e+s[0],o+s[1],3)}return!0}function V(t,e={}){let o=!1!==e.up,n=!1!==e.down;const r=e.minDistance||Math.floor(Math.max(t.width,t.height)/2),l=e.isValid||z,h=e.setup||Q;let s=Array.isArray(e.up)?e.up:null,a=Array.isArray(e.down)?e.down:null;const f={};if(e.start&&"string"!=typeof e.start){let o=e.start;o=!0===o?t.randomMatchingLoc(l):t.matchingLocNear(i.utils.x(o),i.utils.y(o),l),f.start=o}return s&&a?(s=t.matchingLocNear(i.utils.x(s),i.utils.y(s),l),a=t.matchingLocNear(i.utils.x(a),i.utils.y(a),l)):s&&!a?(s=t.matchingLocNear(i.utils.x(s),i.utils.y(s),l),n&&(a=t.randomMatchingLoc(((e,o,n)=>!(i.utils.distanceBetween(o,n,s[0],s[1])<r)&&l(e,o,n,t))))):a&&!s?(a=t.matchingLocNear(i.utils.x(a),i.utils.y(a),l),o&&(s=t.randomMatchingLoc(((e,o,n)=>!(i.utils.distanceBetween(o,n,a[0],a[1])<r)&&z(0,o,n,t))))):o?(s=t.randomMatchingLoc(l),n&&(a=t.randomMatchingLoc(((e,o,n)=>!(i.utils.distanceBetween(o,n,s[0],s[1])<r)&&z(0,o,n,t))))):n&&(a=t.randomMatchingLoc(l)),s&&(f.up=s.slice(),h(t,s[0],s[1],e.upTile||7),"up"===e.start&&(f.start=f.up)),a&&(f.down=a.slice(),h(t,a[0],a[1],e.downTile||17),"down"===e.start&&(f.start=f.down)),s||a?f:null}function J(t){let e,o,n,r,h,s;do{for(s=!1,e=0;e<t.width-1;e++)for(o=0;o<t.height-1;o++)for(n=0;n<=1;n++)l(t,e+n,o)&&!l(t,e+(1-n),o)&&c(t,e+(1-n),o)&&!l(t,e+n,o+1)&&c(t,e+n,o+1)&&l(t,e+(1-n),o+1)&&(i.random.chance(50)?(r=e+(1-n),h=o):(r=e+n,h=o+1),s=!0,t[r][h]=1)}while(1==s)}function $(t){t.forEach(((i,e,o)=>{t.isBoundaryXY(e,o)||2==i&&(1!=t.get(e+1,o)&&1!=t.get(e-1,o)||1!=t.get(e,o+1)&&1!=t.get(e,o-1)?(1!==t.get(e+1,o)?1:0)+(1!==t.get(e-1,o)?1:0)+(1!==t.get(e,o+1)?1:0)+(1!==t.get(e,o-1)?1:0)>=3&&(t[e][o]=1):t[e][o]=1)}))}function tt(t,i=3){t.forEach(((e,o,n)=>{0==e&&(t[o][n]=i)}))}var it={__proto__:null,room:G,hall:P,lake:j,bridge:{__proto__:null,Bridges:K,digBridges:Z},stairs:{__proto__:null,isValidStairLoc:z,setupStairs:Q,addStairs:V},utils:I,start:function(t){n(t.width*t.height),t.fill(0)},finish:function(t){J(t),tt(t),$(t)},addRoom:function(t,e){if("string"==typeof(e=e||{room:"DEFAULT",hall:"DEFAULT",tries:10})&&(e={room:e}),e.loc&&(e.locs=[e.loc]),e.room||(e.room="DEFAULT"),"function"==typeof e.room&&(e.room={fn:e.room}),"string"==typeof e.room){const t=e.room;e.room=X[t],e.room||i.utils.ERROR("Failed to find room: "+t)}const o=e.room;let n=null;if(!0===e.hall&&(e.hall="DEFAULT"),!1===e.hall||e.hall||(e.hall="DEFAULT"),"function"==typeof e.hall&&(e.hall={fn:e.hall}),"string"==typeof e.hall){const t=e.hall;if(e.hall=S[t],!e.hall)return i.utils.ERROR("Failed to find hall: "+t),null;n=e.hall}else e.hall&&e.hall.fn&&(n=e.hall);!1===e.door?e.door=0:!0===e.door?e.door=2:"number"==typeof e.door?e.door=i.random.chance(e.door)?2:1:e.door=1;let r=e.locs||null;if(r&&r.doors&&(r=r.doors),r&&Array.isArray(r))r&&r.length&&2==r.length&&"number"==typeof r[0]?r=[r]:0==r.length&&(r=null);else if(r=null,0===t.count(1)){r=[[Math.floor(t.width/2),t.height-2]]}const l=e.room,h=i.grid.alloc(t.width,t.height);let s=!1;if(n){let t=void 0!==n.chance?n.chance:15;s=i.random.chance(t)}let a,f=!1,u=e.tries||10;for(;--u>=0&&!f;)h.fill(0),a=l.fn(o,h),a.doors=E(h),s&&n&&(a.hall=n.fn(n,h,a)),f=r?L(t,r,h,a,e):y(t,h,a,e);return i.grid.free(h),a&&f?a:null},addLoops:function(t,e,n){let h,s,f,u,c,d,g,m,w;e=e||Math.floor(Math.min(t.width,t.height)/2),n=n||1;const M=t,p=i.grid.alloc(t.width,t.height),R=i.grid.alloc(t.width,t.height),y=[[1,0],[0,1]];function O(i,e,o){return!!t.hasXY(i,e)&&(!!t.hasXY(i+o[1],e+o[0])&&(!!t.hasXY(i-o[1],e-o[0])&&(!t.get(i,e)&&(!t.get(i+o[1],e+o[0])&&!t.get(i-o[1],e-o[0])))))}function D(i,e,o){return!!t.hasXY(i,e)&&(!!t.hasXY(i+o[1],e+o[0])&&(!!t.hasXY(i-o[1],e-o[0])&&(!!t.get(i,e)||(!!t.get(i+o[1],e+o[0])||!!t.get(i-o[1],e-o[0])))))}for(r(t,R),c=0;c<o.length;c++){m=Math.floor(o[c]/M.height),w=o[c]%M.height;if(!M[m][w])for(g=0;g<=1;g++){let o=y[g];if(O(m,w,o)){if(d=n,t.hasXY(m+o[0],w+o[1])&&l(t,m+o[0],w+o[1])){if(!t.hasXY(m-o[0],w-o[1])||a(t,m-o[0],w-o[1]))continue}else{if(!t.hasXY(m-o[0],w-o[1])||!l(t,m-o[0],w-o[1]))continue;if(!t.hasXY(m+o[0],w+o[1])||a(t,m+o[0],w+o[1]))continue;o=o.map((t=>-1*t))}for(h=m+o[0],s=w+o[1],f=m,u=w,d=0;d<n&&(f-=o[0],u-=o[1],!D(f,u,o));++d);if(d<n&&(i.path.calculateDistances(p,h,s,R,!1),p[f][u]>e&&p[f][u]<3e4)){for(;f!==h||u!==s;)0==t.get(f,u)&&(t[f][u]=1,R[f][u]=1),f+=o[0],u+=o[1];t[m][w]=2;break}}}}i.grid.free(p),i.grid.free(R)},addLakes:function(t,i){return H(t,i)},addBridges:function(t,i,e){return Z(t,i,e)},addStairs:function(t,i={}){return V(t,i)},removeDiagonalOpenings:J,finishDoors:$,finishWalls:tt,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,DEEP:4,SHALLOW:5,BRIDGE:6,UP_STAIRS:7,DOWN_STAIRS:17,IMPREGNABLE:8,TILEMAP:e,SEQ:o,initSeqence:n,fillCostGrid:r,isPassable:l,isNothing:h,isFloor:s,isDoor:a,isBridge:f,isWall:u,isObstruction:c,isStairs:d,isDeep:g,isShallow:m,isAnyWater:w,setGrid:M,Hall:N,Room:x};t.dig=it,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-dig.min.js.map

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rot-js")):"function"==typeof define&&define.amd?define(["exports","rot-js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.ROT)}(this,(function(t,e){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,e}var s=i(e);function r(t,e){let i=0;for(;t;){const s=t.next;e(t,i++),t=s}return i}function n(t,e,i){return i.next=t[e]||null,t[e]=i,!0}function h(t,e,i){const s=t[e];if(s===i)return t[e]=i.next||null,i.next=null,!0;if(!s)return!1;{let t=s,e=t.next;for(;e&&e!==i;)t=e,e=t.next;if(e===i)return t.next=e.next||null,i.next=null,!0}return!1}function l(t,e){for(;t&&!e(t);)t=t.next;return t}const o=[[0,-1],[1,0],[0,1],[-1,0],[1,-1],[1,1],[-1,1],[-1,-1]],a=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]];function c(){}function u(){return!0}function f(t,e,i){return t<e?e:t>i?i:t}function _(t){return t.x||t[0]||0}function g(t){return t.y||t[1]||0}class d{constructor(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s}get left(){return this.x}get right(){return this.x+this.width-1}get top(){return this.y}get bottom(){return this.y+this.height-1}contains(...t){let e=t[0],i=t[1];return"number"!=typeof e&&(i=i(e),e=e(e)),this.x<=e&&this.y<=i&&this.x+this.width>e&&this.y+this.height>i}}function E(t,e,i,s=!1){const r=s?4:8;for(let s=0;s<r;++s){const r=o[s];i(t+r[0],e+r[1])}}function p(t,e,i,s){const r=Math.abs(t-i),n=Math.abs(e-s);return r+n-.6*Math.min(r,n)}function A(t,e){return p(0,0,t,e)}function S(t,e,i,s){let r=i-t,n=s-e;if(r&&n){const t=Math.abs(r),e=Math.abs(n);t>=2*e?n=0:e>=2*t&&(r=0)}return[Math.sign(r),Math.sign(n)]}function T(t,e,i){const s=t[i],r=e[i];s&&s.copy&&r?s.copy(r):s&&s.clear&&!r?s.clear():s&&s.nullify&&!r?s.nullify():r&&r.clone?t[i]=r.clone():r&&Array.isArray(r)?t[i]=r.slice():s&&Array.isArray(s)?s.length=0:t[i]=r}function L(t,e,i=null){let s;e&&Object.keys(e).forEach((r=>{const n=r;let h=e[r];s=t;const l=r.split(".");for(;l.length>1;)r=l.shift(),void 0===s[r]?s=s[r]={}:"object"!=typeof s[r]?I("Trying to set default member on non-object config item: "+n):s=s[r];r=l.shift();let o=s[r];i&&i(s,r,o,h)||void 0===o&&(null===h?s[r]=null:Array.isArray(h)?s[r]=h.slice():s[r]=h)}))}function I(t){throw new Error(t)}function m(...t){console.warn(...t)}function R(...t){return t.find((t=>void 0!==t))}const y=65536;function C(t,e,i,s,r){let n,h,l=[],o=[],a=[],c=[],u=[],f=[-1,-1],_=[-1,-1];if(t==i&&e==s)return;const g=[t,e],d=[i,s];for(h=0;h<=1;h++)l[h]=d[h]-g[h]<<16,l[h]<0?(l[h]*=-1,u[h]=-1):u[h]=1,a[h]=c[h]=o[h]=0,f[h]=g[h];for(n=Math.max(l[0],l[1]),l[0]=Math.floor(l[0]*y/n),l[1]=Math.floor(l[1]*y/n);;){for(h=0;h<=1;h++)_[h]=f[h],a[h]+=l[h]>>16,o[h]+=l[h]==y?0:l[h],o[h]>=Math.floor(32768)&&(a[h]++,o[h]-=y),f[h]=Math.floor(u[h]*a[h]+g[h]);if(r(...f))break}}function O(t,e,i,s){let r,n;for(r=t-i-1;r<t+i+1;r++)for(n=e-i-1;n<e+i+1;n++)(r-t)*(r-t)+(n-e)*(n-e)<i*i+i&&s(r,n)}function b(...t){let e=0,i=0;arguments.length>3&&(e=t.shift(),i=t.shift());const s=e+t[0],r=i+t[1],n=t[2];for(let t=e;t<s;++t)for(let e=i;e<r;++e)n(t,e)}function N(t,e,i){let s,r,n,h,l=0,o=0;for(let c=0;c<a.length;c++){s=t+a[(c+7)%8][0],r=e+a[(c+7)%8][1],n=t+a[c][0],h=e+a[c][1];const u=i(n,h);u&&++o,u!=i(s,r)&&l++}return 0==l&&o?1:Math.floor(l/2)}var w={__proto__:null,DIRS:o,NO_DIRECTION:-1,UP:0,RIGHT:1,DOWN:2,LEFT:3,RIGHT_UP:4,RIGHT_DOWN:5,LEFT_DOWN:6,LEFT_UP:7,CLOCK_DIRS:a,NOOP:c,TRUE:u,FALSE:function(){return!1},ONE:function(){return 1},ZERO:function(){return 0},IDENTITY:function(t){return t},IS_ZERO:function(t){return 0==t},IS_NONZERO:function(t){return 0!=t},clamp:f,x:_,y:g,Bounds:d,copyXY:function(t,e){t.x=_(e),t.y=g(e)},addXY:function(t,e){t.x+=_(e),t.y+=g(e)},equalsXY:function(t,e){return!t&&!e||!(!t||!e)&&(_(t)==_(e)&&g(t)==g(e))},lerpXY:function(t,e,i){i>1&&(i/=100),i=f(i,0,1);const s=_(e)-_(t),r=g(e)-g(t);return[_(t)+Math.floor(s*i),g(t)+Math.floor(r*i)]},eachNeighbor:E,eachNeighborAsync:async function(t,e,i,s=!1){const r=s?4:8;for(let s=0;s<r;++s){const r=o[s],n=t+r[0],h=e+r[1];await i(n,h)}},matchingNeighbor:function(t,e,i,s=!1){const r=s?4:8;for(let s=0;s<r;++s){const r=o[s],n=t+r[0],h=e+r[1];if(i(n,h))return[n,h]}return[-1,-1]},distanceBetween:p,distanceFromTo:function(t,e){return p(_(t),g(t),_(e),g(e))},calcRadius:A,dirBetween:S,dirFromTo:function(t,e){return S(_(t),g(t),_(e),g(e))},dirIndex:function(t){const e=_(t),i=g(t);return o.findIndex((t=>t[0]==e&&t[1]==i))},isOppositeDir:function(t,e){return t[0]+e[0]==0&&t[1]+e[1]==0},isSameDir:function(t,e){return t[0]==e[0]&&t[1]==e[1]},dirSpread:function(t){const e=[t];return 0==t[0]?(e.push([1,t[1]]),e.push([-1,t[1]])):0==t[1]?(e.push([t[0],1]),e.push([t[0],-1])):(e.push([t[0],0]),e.push([0,t[1]])),e},stepFromTo:function(t,e,i){const s=_(t),r=g(t),n=[_(e)-s,g(e)-r],h=Math.abs(n[0])+Math.abs(n[1]),l=[0,0],o=[99999,99999];for(let t=0;t<=h;++t)l[0]=s+Math.floor(n[0]*t/h),l[1]=r+Math.floor(n[1]*t/h),l[0]==o[0]&&l[1]==o[1]||i(l[0],l[1]),o[0]=l[0],o[1]=l[1]},smoothHiliteGradient:function(t,e){return Math.floor(100*Math.sin(Math.PI*t/e))},copyObject:function(t,e){Object.keys(t).forEach((i=>{T(t,e,i)}))},assignObject:function(t,e){Object.keys(e).forEach((i=>{T(t,e,i)}))},assignOmitting:function(t,e,i){"string"==typeof t&&(t=t.split(/[,|]/g).map((t=>t.trim()))),Object.keys(i).forEach((s=>{t.includes(s)||T(e,i,s)}))},setDefault:function(t,e,i){void 0===t[e]&&(t[e]=i)},setDefaults:L,setOptions:function(t,e){L(t,e,((t,e,i,s)=>(null===s?t[e]=null:Array.isArray(s)?t[e]=s.slice():t[e]=s,!0)))},kindDefaults:function(t,e){return L(t,e,(function(t,e,i,s){return!(e.search(/[fF]lags$/)<0)&&(i?"string"==typeof i?i=i.split(/[,|]/).map((t=>t.trim())):Array.isArray(i)||(i=[i]):i=[],"string"==typeof s?s=s.split(/[,|]/).map((t=>t.trim())):Array.isArray(s)||(s=[s]),t[e]=s.concat(i),!0)}))},pick:function(t,...e){const i={};return e.forEach((e=>{const s=t[e];void 0!==s&&(i[e]=s)})),i},clearObject:function(t){Object.keys(t).forEach((e=>t[e]=void 0))},ERROR:I,WARN:m,first:R,getOpt:function(t,e,i){const s=t[e];return void 0===s?i:s},firstOpt:function(t,...e){for(let i of e){if("object"!=typeof i||Array.isArray(i))return i;if(void 0!==i[t])return i[t]}},arraysIntersect:function(t,e){return t.some((t=>e.includes(t)))},sum:function(t){return t.reduce(((t,e)=>t+e))},forLine:C,getLine:function(t,e,i,s){const r=[];return C(t,e,i,s,((t,e)=>(r.push([t,e]),t==i&&e==s))),r},getLineThru:function(t,e,i,s,r,n){const h=[];return C(t,e,i,s,((t,e)=>t<0||e<0||t>=r||e>=n||(h.push([t,e]),!1))),h},forCircle:O,forRect:b,forBorder:function(...t){let e=0,i=0;arguments.length>3&&(e=t.shift(),i=t.shift());const s=e+t[0]-1,r=i+t[1]-1,n=t[2];for(let t=e;t<=s;++t)n(t,i),n(t,r);for(let t=i;t<=r;++t)n(e,t),n(s,t)},arcCount:N,asyncForEach:async function(t,e){for(let i of t)await e(i)},chainLength:function(t){let e=0;for(;t;)e+=1,t=t.next;return e},chainIncludes:function(t,e){for(;t&&t!==e;)t=t.next;return t===e},eachChain:r,addToChain:n,removeFromChain:h,findInChain:l,Chain:class{constructor(t,e){this.data=null,this.sort=t||(()=>-1),this.onchange=e||(()=>{})}copy(t){this.data=t.data,this.sort=t.sort,this.onchange=t.onchange}get length(){let t=0;return this.forEach((()=>++t)),t}add(t){if(!this.data||this.sort(this.data,t)<0)return t.next=this.data,this.data=t,!0;let e=this.data,i=this.data.next;for(;i&&this.sort(i,t)<0;)e=i,i=i.next;return t.next=i,e.next=t,this.onchange(),!0}has(t){return null!==this.find((e=>e===t))}remove(t){return!!h(this,"data",t)&&(this.onchange(),!0)}find(t){return l(this.data,t)}forEach(t){return r(this.data,t)}reduce(t,e){let i=this.data;if(!i)return e;for(void 0===e&&(e=i,i=i.next);i;)t(e,i),i=i.next;return e}some(t){let e=this.data;for(;e;){if(t(e))return!0;e=e.next}return!1}every(t){let e=this.data;for(;e;){if(!t(e))return!1;e=e.next}return!0}}};function v(t,e){let i,s,r;for(s=0,i=0;i<e.length;i++)s+=e[i];if(s<=0)return-1;for(r=t.range(0,s-1),i=0;i<e.length;i++){if(e[i]>r)return i;r-=e[i]}return console.warn("Lottery Draw failed.",e,e.length),0}class M{constructor(){this._fn=s.RNG.clone()}seed(t){this._fn.setSeed(t)}value(){return this._fn.getUniform()}float(){return this.value()}number(t){return t<=0?0:(t=t||Number.MAX_SAFE_INTEGER,Math.floor(this.value()*t))}int(t=0){return this.number(t)}range(t,e){if(e<=t)return e;const i=e-t+1;return t+this.number(i)}dice(t,e,i=0){let s=0,r=1;t<0&&(t=-t,r=-1),i=i||0;for(let i=0;i<t;++i)s+=this.range(1,e);return s*=r,s+i}weighted(t){return Array.isArray(t)?v(this,t):function(t,e){const i=Object.entries(e),s=i.map((([t,e])=>e));return i[v(t,s)][0]}(this,t)}item(t){return Array.isArray(t)||(t=Object.values(t)),t[this.range(0,t.length-1)]}key(t){return this.item(Object.keys(t))}shuffle(t,e=0,i=0){let s,r,n;for(2==arguments.length&&(i=e,e=0),i=i||t.length,s=e=e||0;s<i;s++)r=this.range(e,i-1),s!=r&&(n=t[r],t[r]=t[s],t[s]=n);return t}sequence(t){const e=[];for(let i=0;i<t;i++)e[i]=i;return this.shuffle(e)}chance(t,e=100){return!(t<=0)&&(t>=e||this.number(e)<t)}clumped(t,e,i){if(e<=t)return t;if(i<=1)return this.range(t,e);let s,r=0,n=Math.floor((e-t)/i);for(s=0;s<(e-t)%i;s++)r+=this.range(0,n+1);for(;s<i;s++)r+=this.range(0,n);return r+t}matchingLoc(t,e,i){let s,r,n,h=0;if(h=0,b(t,e,((t,e)=>{i(t,e)&&h++})),0==h)return[-1,-1];for(n=this.range(0,h-1),s=0;s<t&&n>=0;s++)for(r=0;r<e&&n>=0;r++)if(i(s,r)){if(0==n)return[s,r];n--}return[-1,-1]}matchingLocNear(t,e,i){let s,r,n,h,l,o=[-1,-1];for(h=0,n=0;n<50&&!h;n++)for(s=t-n;s<=t+n;s++)for(r=e-n;r<=e+n;r++)s!=t-n&&s!=t+n&&r!=e-n&&r!=e+n||!i(s,r)||h++;if(0==h)return[-1,-1];for(l=1+this.number(h),n=0;n<50;n++)for(s=t-n;s<=t+n;s++)for(r=e-n;r<=e+n;r++)if((s==t-n||s==t+n||r==e-n||r==e+n)&&i(s,r)&&0==--l)return o[0]=s,o[1]=r,o;return[-1,-1]}}const D=new M,x=new M;class F{constructor(t,e=0,i=1,s){this._rng=s||null,Array.isArray(t)&&(i=t[2],e=t[1],t=t[0]),e<t&&([e,t]=[t,e]),this.lo=t||0,this.hi=e||this.lo,this.clumps=i||1}value(){return(this._rng||D).clumped(this.lo,this.hi,this.clumps)}copy(t){return this.lo=t.lo,this.hi=t.hi,this.clumps=t.clumps,this._rng=t._rng,this}toString(){return this.lo>=this.hi?""+this.lo:`${this.lo}-${this.hi}`}}function P(t,e){if(!t)return new F(0,0,0,e);if(t instanceof F)return t;if("function"==typeof t)throw new Error("Custom range functions not supported - extend Range");if(null==t)return new F(0,0,0,e);if("number"==typeof t)return new F(t,t,1,e);if(!0===t||!1===t)throw new Error("Invalid random config: "+t);if(Array.isArray(t))return new F(t[0],t[1],t[2],e);if("string"!=typeof t)throw new Error("Calculations must be strings.  Received: "+JSON.stringify(t));if(0==t.length)return new F(0,0,0,e);const i=/^(?:([+-]?\d*)[Dd](\d+)([+-]?\d*)|([+-]?\d+)-(\d+):?(\d+)?|([+-]?\d+)~(\d+)|([+-]?\d+\.?\d*))/g;let s;for(;null!==(s=i.exec(t));){if(s[2]){let t=Number.parseInt(s[1])||1;const i=Number.parseInt(s[2]),r=Number.parseInt(s[3])||0;return new F(r+t,r+t*i,t,e)}if(s[4]&&s[5]){const t=Number.parseInt(s[4]),i=Number.parseInt(s[5]),r=Number.parseInt(s[6]);return new F(t,i,r,e)}if(s[7]&&s[8]){const t=Number.parseInt(s[7]),i=Number.parseInt(s[8]);return new F(t-2*i,t+2*i,3,e)}if(s[9]){const t=Number.parseFloat(s[9]);return new F(t,t,1,e)}}throw new Error("Not a valid range - "+t)}const B=P;var U={__proto__:null,Range:F,make:P,from:B,asFn:function(t,e){const i=P(t,e);return()=>i.value()}};function V(t){return 1<<t}function H(t,...e){let i=0;for(let s=0;s<e.length;++s){let r=e[s];void 0!==r&&("number"!=typeof r?("string"==typeof r&&(r=r.split(/[,|]/).map((t=>t.trim())).map((t=>{const e=Number.parseInt(t);return e>=0?e:t}))),Array.isArray(r)&&r.forEach((e=>{if("string"==typeof e)if((e=e.trim()).startsWith("!")){const s=t[e.substring(1)];i&=~s}else{const s=t[e];s&&(i|=s)}else 0===e?i=0:i|=e}))):i|=r)}return i}var Y={__proto__:null,fl:V,toString:function(t,e){const i=Object.entries(t).reduce(((t,e)=>{const[i,s]=e;return"number"==typeof s&&(t[s]?t[s]+=" | "+i:t[s]=i),t}),[]),s=[];for(let t=0;t<32;++t){const r=1<<t;e&r&&s.push(i[r])}return s.join(" | ")},from:H};const k=o;function W(t,e){if(void 0===e)return new Array(t).fill(0);e=e||(()=>0);const i=new Array(t);for(let s=0;s<t;++s)i[s]=e(s);return i}function K(t){return!1===t?" ":!0===t?"T":t<10?""+t:t<36?String.fromCharCode("a".charCodeAt(0)+t-10):t<62?String.fromCharCode("A".charCodeAt(0)+t-10-26):"string"==typeof t?t[0]:"#"}class G extends Array{constructor(t,e,i){super(t);for(let s=0;s<t;++s)this[s]="function"==typeof i?new Array(e).fill(0).map(((t,e)=>i(s,e))):new Array(e).fill(i);this._width=t,this._height=e}get width(){return this._width}get height(){return this._height}get(t,e){if(this.hasXY(t,e))return this[t][e]}set(t,e,i){return!!this.hasXY(t,e)&&(this[t][e]=i,!0)}forEach(t){let e,i;for(e=0;e<this.width;e++)for(i=0;i<this.height;i++)t(this[e][i],e,i,this)}async forEachAsync(t){let e,i;for(e=0;e<this.width;e++)for(i=0;i<this.height;i++)await t(this[e][i],e,i,this)}eachNeighbor(t,e,i,s=!1){E(t,e,((t,e)=>{this.hasXY(t,e)&&i(this[t][e],t,e,this)}),s)}async eachNeighborAsync(t,e,i,s=!1){const r=s?4:8;for(let s=0;s<r;++s){const r=k[s],n=t+r[0],h=e+r[1];this.hasXY(n,h)&&await i(this[n][h],n,h,this)}}forRect(t,e,i,s,r){b(t,e,i,s,((t,e)=>{this.hasXY(t,e)&&r(this[t][e],t,e,this)}))}randomEach(t){D.sequence(this.width*this.height).forEach((e=>{const i=e%this.width,s=Math.floor(e/this.width);t(this[i][s],i,s,this)}))}map(t){const e=new this.constructor(this.width,this.height);return e.copy(this),e.update(t),e}some(t){return super.some(((e,i)=>e.some(((e,s)=>t(e,i,s,this)))))}forCircle(t,e,i,s){O(t,e,i,((t,e)=>{this.hasXY(t,e)&&s(this[t][e],t,e,this)}))}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}isBoundaryXY(t,e){return this.hasXY(t,e)&&(0==t||t==this.width-1||0==e||e==this.height-1)}calcBounds(){const t={left:this.width,top:this.height,right:0,bottom:0};return this.forEach(((e,i,s)=>{e&&(t.left>i&&(t.left=i),t.right<i&&(t.right=i),t.top>s&&(t.top=s),t.bottom<s&&(t.bottom=s))})),t}update(t){b(this.width,this.height,((e,i)=>{this.hasXY(e,i)&&(this[e][i]=t(this[e][i],e,i,this))}))}updateRect(t,e,i,s,r){b(t,e,i,s,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=r(this[t][e],t,e,this))}))}updateCircle(t,e,i,s){O(t,e,i,((t,e)=>{this.hasXY(t,e)&&(this[t][e]=s(this[t][e],t,e,this))}))}fill(t){const e="function"==typeof t?t:()=>t;this.update(e)}fillRect(t,e,i,s,r){const n="function"==typeof r?r:()=>r;this.updateRect(t,e,i,s,n)}fillCircle(t,e,i,s){const r="function"==typeof s?s:()=>s;this.updateCircle(t,e,i,r)}replace(t,e){this.update((i=>i==t?e:i))}copy(t){this.update(((e,i,s)=>t[i][s]))}count(t){const e="function"==typeof t?t:e=>e==t;let i=0;return this.forEach(((t,s,r)=>{e(t,s,r,this)&&++i})),i}dump(t,e=console.log){this.dumpRect(0,0,this.width,this.height,t,e)}dumpRect(t,e,i,s,r,n=console.log){let h,l;r=r||K,t=f(t,0,this.width-2),e=f(e,0,this.height-2);const o=f(t+i,1,this.width-1),a=f(e+s,1,this.height-1);let c=[];for(l=e;l<=a;l++){let e=(l+"]").padStart(3," ");for(h=t;h<=o;h++){h%10==0&&(e+=" ");e+=r(this[h][l],h,l)[0]}c.push(e)}n(c.join("\n"))}dumpAround(t,e,i,s,r=console.log){this.dumpRect(t-i,e-i,2*i,2*i,s,r)}closestMatchingLoc(t,e,i){let s=[-1,-1],r=100*(this.width+this.height);const n="function"==typeof i?i:t=>t==i;return this.forEach(((i,h,l)=>{if(n(i,h,l,this)){const i=Math.floor(100*p(t,e,h,l));i<r?(s[0]=h,s[1]=l,r=i):i==r&&D.chance(50)&&(s[0]=h,s[1]=l)}})),s}firstMatchingLoc(t){const e="function"==typeof t?t:e=>e==t;for(let t=0;t<this.width;++t)for(let i=0;i<this.height;++i)if(e(this[t][i],t,i,this))return[t,i];return[-1,-1]}randomMatchingLoc(t){const e="function"==typeof t?(e,i)=>t(this[e][i],e,i,this):(e,i)=>this.get(e,i)===t;return D.matchingLoc(this.width,this.height,e)}matchingLocNear(t,e,i){const s="function"==typeof i?(t,e)=>i(this[t][e],t,e,this):(t,e)=>this.get(t,e)===i;return D.matchingLocNear(t,e,s)}arcCount(t,e,i){return N(t,e,((t,e)=>this.hasXY(t,e)&&i(this[t][e],t,e,this)))}}const j=[];class X extends G{constructor(t,e,i=0){super(t,e,i)}static alloc(...t){let e=t[0]||0,i=t[1]||0,s=t[2]||0;if(1==t.length&&(e=t[0].width,i=t[0].height,s=t[0].get.bind(t[0])),!e||!i)throw new Error("Grid alloc requires width and height parameters.");let r=j.pop();return r?(r._resize(e,i,s),r):new X(e,i,s)}static free(t){if(t){if(j.indexOf(t)>=0)return;j.push(t)}}_resize(t,e,i=0){const s="function"==typeof i?i:()=>i;for(;this.length<t;)this.push([]);this.length=t;let r=0,n=0;for(r=0;r<t;++r){const t=this[r];for(n=0;n<e;++n)t[n]=s(r,n);t.length=e}this._width=t,this._height=e,void 0!==this.x&&(this.x=void 0,this.y=void 0)}findReplaceRange(t,e,i){this.update((s=>s>=t&&s<=e?i:s))}floodFillRange(t,e,i=0,s=0,r=0){let n,h,l,o=1;if(r>=i&&r<=s)throw new Error("Invalid grid flood fill");const a=(t,e)=>this.hasXY(t,e)&&this[t][e]>=i&&this[t][e]<=s;if(!a(t,e))return 0;for(this[t][e]=r,n=0;n<4;n++)h=t+k[n][0],l=e+k[n][1],a(h,l)&&(o+=this.floodFillRange(h,l,i,s,r));return o}invert(){this.update((t=>t?0:1))}leastPositiveValue(){let t=Number.MAX_SAFE_INTEGER;return this.forEach((e=>{e>0&&e<t&&(t=e)})),t}randomLeastPositiveLoc(){const t=this.leastPositiveValue();return this.randomMatchingLoc(t)}valueBounds(t,e){let i,s,r=!1,n=this.width-1,h=0,l=this.height-1,o=0;for(i=0;i<this.width;i++){for(r=!1,s=0;s<this.height;s++)if(this[i][s]==t){r=!0;break}r&&(i<n&&(n=i),i>h&&(h=i))}for(s=0;s<this.height;s++){for(r=!1,i=0;i<this.width;i++)if(this[i][s]==t){r=!0;break}r&&(s<l&&(l=s),s>o&&(o=s))}return(e=e||new d(0,0,0,0)).x=n,e.y=l,e.width=h-n+1,e.height=o-l+1,e}floodFill(t,e,i,s){let r,n,h,l=1;const o="function"==typeof i?i:t=>t==i,a="function"==typeof s?s:()=>s;for(this[t][e]=a(this[t][e],t,e,this),r=0;r<4;r++)n=t+k[r][0],h=e+k[r][1],this.hasXY(n,h)&&o(this[n][h],n,h,this)&&(l+=this.floodFill(n,h,o,a));return l}}const z=X.alloc.bind(X),$=X.free.bind(X);function q(t,e,i){return void 0===i?new X(t,e,0):"number"==typeof i?new X(t,e,i):new G(t,e,i)}var Q={__proto__:null,makeArray:W,Grid:G,NumGrid:X,alloc:z,free:$,make:q,offsetZip:function(t,e,i,s,r){const n="function"==typeof r?r:(e,i,s,n)=>t[s][n]=r;e.forEach(((r,h,l)=>{const o=h+i,a=l+s;t.hasXY(o,a)&&r&&n(t[o][a],r,o,a,h,l,t,e)}))},intersection:function(t,e,i){i=i||t,t.update(((t,s,r)=>e[s][r]&&i[s][r]||0))},unite:function(t,e,i){i=i||t,t.update(((t,s,r)=>i[s][r]||e[s][r]))}},J={};let Z={};const tt=[],et="keypress",it="mousemove",st="click",rt="tick",nt="mouseup",ht=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];async function lt(t,e){let i,s;return"function"==typeof(e=e||Z)?s=e:t.dir?s=e.dir:t.type===et?s=e[t.key]||e[t.code]||e.keypress:e[t.type]&&(s=e[t.type]),s&&("function"==typeof s?i=await s.call(e,t):J[s]?i=await J[s](t):m("No command found: "+s)),"next"in e&&!1===e.next&&(i=!1),ot(t),i}function ot(t){tt.push(t)}function at(t){const e=tt.pop()||{};return e.shiftKey=!1,e.ctrlKey=!1,e.altKey=!1,e.metaKey=!1,e.type=rt,e.key=null,e.code=null,e.x=-1,e.y=-1,e.dir=null,e.dt=t,e}function ct(t){let e=t.key,i=t.code.toLowerCase();t.shiftKey&&(e=e.toUpperCase(),i=i.toUpperCase()),t.ctrlKey&&(e="^"+e,i="^"+i),t.metaKey&&(e="#"+e,i="#"+i),t.altKey&&(i="/"+i);const s=tt.pop()||{};return s.shiftKey=t.shiftKey,s.ctrlKey=t.ctrlKey,s.altKey=t.altKey,s.metaKey=t.metaKey,s.type=et,s.key=e,s.code=i,s.x=-1,s.y=-1,s.clientX=-1,s.clientY=-1,s.dir=ut(t.code),s.dt=0,s}function ut(t){const e=t.toLowerCase();return"arrowup"===e?[0,-1]:"arrowdown"===e?[0,1]:"arrowleft"===e?[-1,0]:"arrowright"===e?[1,0]:null}function ft(t){return ht.includes(t.code)}function _t(t,e,i){const s=tt.pop()||{};return s.shiftKey=t.shiftKey,s.ctrlKey=t.ctrlKey,s.altKey=t.altKey,s.metaKey=t.metaKey,s.type=t.type,t.buttons&&"mouseup"!==t.type&&(s.type=st),s.key=null,s.code=null,s.x=e,s.y=i,s.clientX=t.clientX,s.clientY=t.clientY,s.dir=null,s.dt=0,s}class gt{constructor(){this.running=!1,this.events=[],this.mouse={x:-1,y:-1},this.CURRENT_HANDLER=null,this.PAUSED=null,this.LAST_CLICK={x:-1,y:-1}}hasEvents(){return this.events.length}clearEvents(){for(;this.events.length;){const t=this.events.shift();tt.push(t)}}pushEvent(t){if(this.PAUSED&&console.log("PAUSED EVENT",t.type),this.events.length){const e=this.events[this.events.length-1];if(e.type===t.type&&e.type===it)return e.x=t.x,e.y=t.y,void ot(t)}if(t.type===st){if(this.LAST_CLICK.x==t.x&&this.LAST_CLICK.y==t.y)return void ot(t);this.LAST_CLICK.x=t.x,this.LAST_CLICK.y=t.y}else if(t.type==nt)return this.LAST_CLICK.x=-1,this.LAST_CLICK.y=-1,void ot(t);if(this.CURRENT_HANDLER)this.CURRENT_HANDLER(t);else if(t.type===rt){const e=this.events[0];if(e&&e.type===rt)return e.dt+=t.dt,void ot(t);this.events.unshift(t)}else this.events.push(t)}nextEvent(t,e){e=e||u;let i,s=0;for(;this.events.length;){const t=this.events.shift();if(t.type===it&&(this.mouse.x=t.x,this.mouse.y=t.y),e(t))return Promise.resolve(t);ot(t)}return void 0===t&&(t=-1),0==t?Promise.resolve(null):(this.CURRENT_HANDLER?console.warn("OVERWRITE HANDLER - nextEvent"):this.events.length&&console.warn("SET HANDLER WITH QUEUED EVENTS - nextEvent"),this.CURRENT_HANDLER=r=>{if(r.type===it&&(this.mouse.x=r.x,this.mouse.y=r.y),r.type===rt&&t>0){if(s+=r.dt,s<t)return}else if(!e(r))return;this.CURRENT_HANDLER=null,r.dt=s,i(r)},new Promise((t=>i=t)))}async run(t,e=-1){const i=setInterval((()=>{const t=at(16);this.pushEvent(t)}),16);for(this.running=!0;this.running;){const i=await this.nextEvent(e);i&&await lt(i,t)&&(this.running=!1),t.draw&&"function"==typeof t.draw&&t.draw()}clearInterval(i)}stop(){this.running=!1}pauseEvents(){this.PAUSED||(this.PAUSED=this.CURRENT_HANDLER,this.CURRENT_HANDLER=null)}resumeEvents(){if(this.PAUSED&&(this.CURRENT_HANDLER&&console.warn("overwrite CURRENT HANDLER!"),this.CURRENT_HANDLER=this.PAUSED,this.PAUSED=null,this.events.length&&this.CURRENT_HANDLER)){const t=this.events.shift();this.CURRENT_HANDLER(t)}}async tickMs(t=1){let e;return setTimeout((()=>e()),t),new Promise((t=>e=t))}async nextKeyPress(t,e){return void 0===t&&(t=-1),e=e||u,this.nextEvent(t,(function(t){return t.type===et&&e(t)}))}async nextKeyOrClick(t,e){return void 0===t&&(t=-1),e=e||u,this.nextEvent(t,(function(t){return(t.type===et||t.type===st)&&e(t)}))}async pause(t){const e=await this.nextKeyOrClick(t);return e&&e.type!==rt}waitForAck(){return this.pause(3e5)}}function dt(){return new gt}const Et=dt();var pt,At={__proto__:null,commands:J,addCommand:function(t,e){J[t]=e},KEYPRESS:et,MOUSEMOVE:it,CLICK:st,TICK:rt,MOUSEUP:nt,setKeymap:function(t){Z=t},dispatchEvent:lt,makeTickEvent:at,makeKeyEvent:ct,keyCodeDirection:ut,ignoreKeyEvent:ft,onkeydown:function(t){if(ft(t))return;"Escape"===t.code&&Et.clearEvents();const e=ct(t);Et.pushEvent(e),t.preventDefault()},makeMouseEvent:_t,Loop:gt,make:dt,loop:Et};!function(t){t[t.VISIBLE=V(0)]="VISIBLE",t[t.WAS_VISIBLE=V(1)]="WAS_VISIBLE",t[t.CLAIRVOYANT_VISIBLE=V(2)]="CLAIRVOYANT_VISIBLE",t[t.WAS_CLAIRVOYANT_VISIBLE=V(3)]="WAS_CLAIRVOYANT_VISIBLE",t[t.TELEPATHIC_VISIBLE=V(4)]="TELEPATHIC_VISIBLE",t[t.WAS_TELEPATHIC_VISIBLE=V(5)]="WAS_TELEPATHIC_VISIBLE",t[t.ITEM_DETECTED=V(6)]="ITEM_DETECTED",t[t.WAS_ITEM_DETECTED=V(7)]="WAS_ITEM_DETECTED",t[t.MONSTER_DETECTED=V(8)]="MONSTER_DETECTED",t[t.WAS_MONSTER_DETECTED=V(9)]="WAS_MONSTER_DETECTED",t[t.REVEALED=V(10)]="REVEALED",t[t.MAGIC_MAPPED=V(11)]="MAGIC_MAPPED",t[t.IN_FOV=V(12)]="IN_FOV",t[t.WAS_IN_FOV=V(13)]="WAS_IN_FOV",t[t.ALWAYS_VISIBLE=V(14)]="ALWAYS_VISIBLE",t[t.ANY_KIND_OF_VISIBLE=t.VISIBLE|t.CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE]="ANY_KIND_OF_VISIBLE",t[t.IS_WAS_ANY_KIND_OF_VISIBLE=t.VISIBLE|t.WAS_VISIBLE|t.CLAIRVOYANT_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.TELEPATHIC_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="IS_WAS_ANY_KIND_OF_VISIBLE",t[t.WAS_ANY_KIND_OF_VISIBLE=t.WAS_VISIBLE|t.WAS_CLAIRVOYANT_VISIBLE|t.WAS_TELEPATHIC_VISIBLE]="WAS_ANY_KIND_OF_VISIBLE",t[t.PLAYER=t.IN_FOV]="PLAYER",t[t.CLAIRVOYANT=t.CLAIRVOYANT_VISIBLE]="CLAIRVOYANT",t[t.TELEPATHIC=t.TELEPATHIC_VISIBLE]="TELEPATHIC",t[t.VIEWPORT_TYPES=t.PLAYER|t.CLAIRVOYANT|t.TELEPATHIC|t.ITEM_DETECTED|t.MONSTER_DETECTED]="VIEWPORT_TYPES"}(pt||(pt={}));class St{constructor(t){this._setVisible=null,this._startX=-1,this._startY=-1,this._maxRadius=100,this._isBlocked=t.isBlocked,this._calcRadius=t.calcRadius||A,this._hasXY=t.hasXY||u,this._debug=t.debug||c}calculate(t,e,i=10,s){this._setVisible=s,this._setVisible(t,e,1),this._startX=t,this._startY=e,this._maxRadius=i+1;for(let t=4;t<8;++t){const e=o[t];this.castLight(1,1,0,0,e[0],e[1],0),this.castLight(1,1,0,e[0],0,0,e[1])}}castLight(t,e,i,s,r,n,h){if(t>=this._maxRadius)return void this._debug("CAST: row=%d, start=%d, end=%d, row >= maxRadius => cancel",t,e.toFixed(2),i.toFixed(2));if(e<i)return void this._debug("CAST: row=%d, start=%d, end=%d, start < end => cancel",t,e.toFixed(2),i.toFixed(2));this._debug("CAST: row=%d, start=%d, end=%d, x=%d,%d, y=%d,%d",t,e.toFixed(2),i.toFixed(2),s,r,n,h);let l,o,a,c,u,f=e,_=!1,g=-t,d=0;for(let E=-t;E<=0;E++){if(l=Math.floor(this._startX+E*s+g*r),o=Math.floor(this._startY+E*n+g*h),a=(E-.5)/(g+.5),c=(E+.5)/(g-.5),u=E/(g+.5),d=(E+.5)/g,!this._hasXY(l,o)){_=!0;continue}if(this._debug("- test %d,%d ... start=%d, min=%d, max=%d, end=%d, dx=%d, dy=%d",l,o,e.toFixed(2),u.toFixed(2),d.toFixed(2),i.toFixed(2),E,g),e<d){_=this._isBlocked(l,o);continue}if(i>u)break;const p=this._calcRadius(E,g);if(p<this._maxRadius){const t=1-p/this._maxRadius;this._setVisible(l,o,t),this._debug("       - visible")}if(_){if(this._isBlocked(l,o)){this._debug("       - blocked ... nextStart: %d",c.toFixed(2)),f=c;continue}_=!1}else this._isBlocked(l,o)&&t<this._maxRadius&&(this._debug("       - blocked ... start:%d, end:%d, nextStart: %d",f.toFixed(2),a.toFixed(2),c.toFixed(2)),_=!0,this.castLight(t+1,f,a,s,r,n,h),f=c)}_||this.castLight(t+1,f,i,s,r,n,h)}}class Tt{constructor(t,e={}){this.site=t,this.flags=q(t.width,t.height,pt.VISIBLE),this._changed=!0,this.viewportChanged=!1,this.fov=new St({isBlocked:(e,i)=>t.blocksVision(e,i),hasXY:(e,i)=>e>=0&&i>=0&&e<t.width&&i<t.height}),!0===e.fov&&this.flags.fill(0),e.visible?this.makeAlwaysVisible():!1===e.visible?this.flags.fill(0):e.revealed&&this.revealAll()}get changed(){return this._changed}isVisible(t,e){return!!((this.flags.get(t,e)||0)&pt.VISIBLE)}isAnyKindOfVisible(t,e){return!!((this.flags.get(t,e)||0)&pt.ANY_KIND_OF_VISIBLE)}isInFov(t,e){return!!((this.flags.get(t,e)||0)&pt.IN_FOV)}isDirectlyVisible(t,e){const i=pt.VISIBLE|pt.IN_FOV;return((this.flags.get(t,e)||0)&i)===i}isMagicMapped(t,e){return!!((this.flags.get(t,e)||0)&pt.MAGIC_MAPPED)}isRevealed(t,e){return!!((this.flags.get(t,e)||0)&pt.REVEALED)}makeAlwaysVisible(){this.flags.update((t=>t|pt.ALWAYS_VISIBLE|pt.REVEALED|pt.VISIBLE))}makeCellAlwaysVisible(t,e){this.flags[t][e]|=pt.ALWAYS_VISIBLE|pt.REVEALED}revealAll(){this.flags.update((t=>t|pt.REVEALED|pt.VISIBLE))}revealCell(t,e){const i=pt.REVEALED;this.flags[t][e]|=i}hideCell(t,e){this.flags[t][e]&=~(pt.MAGIC_MAPPED|pt.REVEALED)}magicMapCell(t,e){this.flags[t][e]|=pt.MAGIC_MAPPED}demoteCellVisibility(t){return(t&=~(pt.WAS_ANY_KIND_OF_VISIBLE|pt.WAS_IN_FOV))&pt.IN_FOV&&(t&=~pt.IN_FOV,t|=pt.WAS_IN_FOV),t&pt.VISIBLE&&(t&=~pt.VISIBLE,t|=pt.WAS_VISIBLE),t&pt.CLAIRVOYANT_VISIBLE&&(t&=~pt.CLAIRVOYANT_VISIBLE,t|=pt.WAS_CLAIRVOYANT_VISIBLE),t&pt.TELEPATHIC_VISIBLE&&(t&=~pt.TELEPATHIC_VISIBLE,t|=pt.WAS_TELEPATHIC_VISIBLE),t&pt.ALWAYS_VISIBLE&&(t|=pt.VISIBLE),t}updateCellVisibility(t,e,i){const s=!!(t&pt.VISIBLE),r=!!(t&pt.WAS_ANY_KIND_OF_VISIBLE);return s&&r||s&&!r&&(t&pt.REVEALED||(this.site.onCellRevealed(e,i),this.flags[e][i]|=pt.REVEALED)),s}updateCellClairyvoyance(t,e,i){const s=!!(t&pt.CLAIRVOYANT_VISIBLE),r=!!(t&pt.WAS_CLAIRVOYANT_VISIBLE);return s&&r||(!s&&r?(this.site.storeMemory(e,i),this.site.redrawCell(e,i)):!r&&s&&this.site.redrawCell(e,i,!0)),s}updateCellTelepathy(t,e,i){const s=!!(t&pt.TELEPATHIC_VISIBLE),r=!!(t&pt.WAS_TELEPATHIC_VISIBLE);return s&&r||(!s&&r?(this.site.storeMemory(e,i),this.site.redrawCell(e,i)):!r&&s&&this.site.redrawCell(e,i,!0)),s}updateCellDetect(t,e,i){const s=!!(t&pt.MONSTER_DETECTED),r=!!(t&pt.WAS_MONSTER_DETECTED);return s&&r||(!s&&r||!r&&s)&&this.site.redrawCell(e,i,!0),s}promoteCellVisibility(t,e,i){t&pt.IN_FOV&&this.site.hasVisibleLight(e,i)&&(t=this.flags[e][i]|=pt.VISIBLE),this.updateCellVisibility(t,e,i)||this.updateCellClairyvoyance(t,e,i)||this.updateCellTelepathy(t,e,i)||this.updateCellDetect(t,e,i)}update(t,e,i){return!(!this.viewportChanged&&void 0===t&&!this.site.lightingChanged())&&(this.flags.update(this.demoteCellVisibility.bind(this)),this.site.eachViewport(((t,e,i,s)=>{const r=s&pt.VIEWPORT_TYPES;if(!r)throw new Error("Received invalid viewport type: "+s);0!=i?this.fov.calculate(t,e,i,((t,e,i)=>{i&&(this.flags[t][e]|=r)})):this.flags[t][e]|=r})),void 0!==t&&void 0!==e&&this.fov.calculate(t,e,i,((t,e,i)=>{i&&(this.flags[t][e]|=pt.PLAYER)})),this.flags.forEach(this.promoteCellVisibility.bind(this)),!0)}}var Lt={__proto__:null,get FovFlags(){return pt},FOV:St,FovSystem:Tt};const It=3e4;function mt(t){return{distance:0,cost:0,index:t,left:null,right:null}}function Rt(t,e,i){return t.links[e+t.width*i]}const yt=o;function Ct(t,e,i){return e<=0||i<=0||(e>=t.length-1||i>=t[0].length-1)}function Ot(t,e){let i,s;for(function(t){let e,i,s,r=null,n=null,h=null;i=t.eightWays?8:4;let l=t.front.right;for(t.front.right=null;null!=l;){for(e=0;e<i;e++){if(s=l.index+(yt[e][0]+t.width*yt[e][1]),s<0||s>=t.width*t.height)continue;if(h=t.links[s],h.cost<0)continue;let i=0;if(e>=4){let s,r,n,h;if(i=.4142,r=l.index+yt[e][0],r<0||r>=t.width*t.height)continue;if(h=l.index+t.width*yt[e][1],h<0||h>=t.width*t.height)continue;if(s=t.links[r],n=t.links[h],-2==s.cost||-2==n.cost)continue}if(l.distance+h.cost+i<h.distance){for(h.distance=l.distance+h.cost+i,null!=h.right&&(h.right.left=h.left),null!=h.left&&(h.left.right=h.right),r=l,n=l.right;null!=n&&n.distance<h.distance;)r=n,n=n.right;null!=r&&(r.right=h),h.right=n,h.left=r,null!=n&&(n.left=h)}}n=l.right,l.left=null,l.right=null,l=n}}(t),i=0;i<t.width;i++)for(s=0;s<t.height;s++)e[i][s]=Rt(t,i,s).distance}var bt;function Nt(t,e,i,s,r=!1){let n,h,l,a,c,u;for(l=0,c=-1,a=0;a<(r?8:4);++a)n=e+o[a][0],h=i+o[a][1],u=s(n,h,e,i,t),!u&&t[e][i]-t[n][h]>l&&(c=a,l=t[e][i]-t[n][h]);return o[c]||null}var wt={__proto__:null,FORBIDDEN:-1,OBSTRUCTION:-2,AVOIDED:10,NO_PATH:It,calculateDistances:function(t,e,i,s,r=!1,n=3e4){const h=t.length,l=t[0].length;var o,a;let c,u;for(n<=0&&(n=It),(!bt||bt.width<h||bt.height<l)&&(o=h,a=l,bt={eightWays:!1,front:mt(-1),links:W(o*a,(t=>mt(t))),width:o,height:a}),bt.width=h,bt.height=l,c=0;c<h;c++)for(u=0;u<l;u++)Rt(bt,c,u).cost=Ct(s,c,u)?-2:s[c][u];!function(t,e,i){let s;for(t.eightWays=i,t.front.right=null,s=0;s<t.width*t.height;s++)t.links[s].distance=e,t.links[s].left=t.links[s].right=null}(bt,n,r),function(t,e,i,s){let r,n,h;if(e>0&&i>0&&e<t.width-1&&i<t.height-1&&(h=Rt(t,e,i),h.distance>s)){for(h.distance=s,null!=h.right&&(h.right.left=h.left),null!=h.left&&(h.left.right=h.right),r=t.front,n=t.front.right;null!=n&&n.distance<h.distance;)r=n,n=n.right;h.right=n,h.left=r,r.right=h,null!=n&&(n.left=h)}}(bt,e,i,0),Ot(bt,t)},nextStep:Nt,getPath:function(t,e,i,s){let r=e,n=i,h=0;if(t[r][n]<0||t[r][n]>=It){const e=function(t,e,i){let s,r,n,h,l,o=-1,a=-1;const c=t.length,u=t[0].length;for(h=1e4,l=1e4,s=1;s<c-1;s++)for(r=1;r<u-1;r++)t[s][r]>=0&&t[s][r]<It&&(n=(s-e)*(s-e)+(r-i)*(r-i),(n<h||n==h&&t[s][r]<l)&&(o=s,a=r,h=n,l=t[s][r]));return o>=0?[o,a]:null}(t,r,n);e&&(r=e[0],n=e[1])}const l=[[r,n]];let o;do{o=Nt(t,r,n,s,!0),o&&(r+=o[0],n+=o[1],l.push([r,n]),h++)}while(o);return h?l:null}};class vt{constructor(t,e,i=!1){this.fn=t,this.context=e||null,this.once=i||!1,this.next=null}matches(t,e,i){return!(this.fn!==t||void 0!==i&&i!=this.once||e&&this.context!==e)}}var Mt={};function Dt(t,e,i,s=!1){if("function"!=typeof e)throw new TypeError("The listener must be a function");const r=new vt(e,i||null,s);return n(Mt,t,r),r}function xt(t,e,i,s=!1){if(!Mt[t])return!1;if(!e)return!1;let n=!1;return r(Mt[t],(r=>{r.matches(e,i,s)&&(h(Mt,t,r),n=!0)})),n}function Ft(t){Mt[t]&&(Mt[t]=null)}async function Pt(...t){const e=t[0];if(!Mt[e])return!1;let i=Mt[e];for(;i;){let s=i.next;i.once&&h(Mt,e,i),await i.fn.apply(i.context,t),i=s}return!0}var Bt={__proto__:null,Listener:vt,addListener:Dt,on:function(t,e,i,s=!1){return Dt(t,e,i,s)},once:function(t,e,i){return Dt(t,e,i,!0)},removeListener:xt,off:function(t,e,i,s=!1){return xt(t,e,i,s)},clearEvent:Ft,removeAllListeners:function(t){t?Ft(t):Mt={}},emit:Pt};var Ut={__proto__:null,make:function(t){if(void 0===t)return()=>100;if(null===t)return()=>0;if("number"==typeof t)return()=>t;if("function"==typeof t)return t;let e={};if("string"==typeof t){const i=t.split(/[,|]/).map((t=>t.trim()));e={},i.forEach((t=>{let[i,s]=t.split(":");e[i]=Number.parseInt(s)||100}))}else e=t;const i=Object.entries(e).map((([t,e])=>{let i=0;if(i="string"==typeof e?Number.parseInt(e):e,t.includes("-")){let[e,s]=t.split("-").map((t=>t.trim())).map((t=>Number.parseInt(t)));return t=>t>=e&&t<=s?i:0}if(t.endsWith("+")){const e=Number.parseInt(t);return t=>t>=e?i:0}{const e=Number.parseInt(t);return t=>t===e?i:0}}));return 1==i.length?i[0]:t=>i.reduce(((e,i)=>e||i(t)),0)}};var Vt={__proto__:null,Scheduler:class{constructor(){this.next=null,this.time=0,this.cache=null}clear(){for(;this.next;){const t=this.next;this.next=t.next,t.next=this.cache,this.cache=t}}push(t,e=1){let i;if(this.cache?(i=this.cache,this.cache=i.next,i.next=null):i={fn:null,time:0,next:null},i.fn=t,i.time=this.time+e,this.next){let t=this,e=t.next;for(;e&&e.time<=i.time;)t=e,e=t.next;i.next=t.next,t.next=i}else this.next=i;return i}pop(){const t=this.next;return t?(this.next=t.next,t.next=this.cache,this.cache=t,this.time=Math.max(t.time,this.time),t.fn):null}remove(t){if(!t||!this.next)return;if(this.next===t)return void(this.next=t.next);let e=this.next,i=e.next;for(;i&&i!==t;)e=i,i=i.next;i===t&&(e.next=i.next)}}};const Ht="\n#version 300 es\nin uvec2 position;\nin uvec2 uv;\nin uint style;\nout vec2 fsUv;\nflat out uint fsStyle;\nuniform highp uvec2 tileSize;\nuniform uvec2 viewportSize;\nvoid main() {\n\tivec2 positionPx = ivec2(position * tileSize);\n\tvec2 positionNdc = (vec2(positionPx * 2) / vec2(viewportSize))-1.0;\n\tpositionNdc.y *= -1.0;\n\tgl_Position = vec4(positionNdc, 0.0, 1.0);\n\tfsUv = vec2(uv);\n\tfsStyle = style;\n}".trim(),Yt="\n#version 300 es\nprecision highp float;\nin vec2 fsUv;\nflat in uint fsStyle;\nout vec4 fragColor;\nuniform sampler2D font;\nuniform highp uvec2 tileSize;\nvoid main() {\n\tuvec2 fontTiles = uvec2(textureSize(font, 0)) / tileSize;\n\n\tuint glyph = (fsStyle & uint(0xFF000000)) >> 24;\n\tuint glyphX = (glyph & uint(0xF));\n\tuint glyphY = (glyph >> 4);\n\tuvec2 fontPosition = uvec2(glyphX, glyphY);\n\n\tuvec2 fontPx = (tileSize * fontPosition) + uvec2(vec2(tileSize) * fsUv);\n\tvec3 texel = texelFetch(font, ivec2(fontPx), 0).rgb;\n\n\tfloat s = 15.0;\n\tuint fr = (fsStyle & uint(0xF00)) >> 8;\n\tuint fg = (fsStyle & uint(0x0F0)) >> 4;\n\tuint fb = (fsStyle & uint(0x00F)) >> 0;\n\tvec3 fgRgb = vec3(fr, fg, fb) / s;\n  \n\tuint br = (fsStyle & uint(0xF00000)) >> 20;\n\tuint bg = (fsStyle & uint(0x0F0000)) >> 16;\n\tuint bb = (fsStyle & uint(0x00F000)) >> 12;\n\tvec3 bgRgb = vec3(br, bg, bb) / s;\n  \n\tfragColor = vec4(mix(bgRgb, fgRgb, texel), 1.0);\n}".trim();class kt{constructor(t={}){this._tileWidth=12,this._tileHeight=16,this.needsUpdate=!0,this._map={},t.font=t.font||"monospace",this._node=document.createElement("canvas"),this._ctx=this.node.getContext("2d"),this._configure(t)}static fromImage(t){if("string"==typeof t){if(t.startsWith("data:"))throw new Error("Glyph: You must load a data string into an image element and use that.");const e=document.getElementById(t);if(!e)throw new Error("Glyph: Failed to find image element with id:"+t);t=e}const e=new this({tileWidth:t.width/16,tileHeight:t.height/16});return e._ctx.drawImage(t,0,0),e}static fromFont(t){"string"==typeof t&&(t={font:t});const e=new this(t),i=t.basicOnly||t.basic||!1;return e._initGlyphs(i),e}get node(){return this._node}get ctx(){return this._ctx}get tileWidth(){return this._tileWidth}get tileHeight(){return this._tileHeight}get pxWidth(){return this._node.width}get pxHeight(){return this._node.height}forChar(t){return t&&t.length&&this._map[t]||-1}_configure(t){this._tileWidth=t.tileWidth||this.tileWidth,this._tileHeight=t.tileHeight||this.tileHeight,this.node.width=16*this.tileWidth,this.node.height=16*this.tileHeight,this._ctx.fillStyle="black",this._ctx.fillRect(0,0,this.pxWidth,this.pxHeight);const e=t.fontSize||t.size||Math.max(this.tileWidth,this.tileHeight);this._ctx.font=e+"px "+t.font,this._ctx.textAlign="center",this._ctx.textBaseline="middle",this._ctx.fillStyle="white"}draw(t,e){if(t>256)throw new Error("Cannot draw more than 256 glyphs.");const i=t%16*this.tileWidth,s=Math.floor(t/16)*this.tileHeight,r=i+Math.floor(this.tileWidth/2),n=s+Math.floor(this.tileHeight/2);this._ctx.save(),this._ctx.beginPath(),this._ctx.rect(i,s,this.tileWidth,this.tileHeight),this._ctx.clip(),this._ctx.fillStyle="black",this._ctx.fillRect(i,s,this.tileWidth,this.tileHeight),this._ctx.fillStyle="white","function"==typeof e?e(this._ctx,i,s,this.tileWidth,this.tileHeight):(void 0===this._map[e]&&(this._map[e]=t),this._ctx.fillText(e,r,n)),this._ctx.restore(),this.needsUpdate=!0}_initGlyphs(t=!1){for(let t=32;t<127;++t)this.draw(t,String.fromCharCode(t));[" ","☺","☻","♥","♦","♣","♠","☼","☀","★","☆","♂","♀","♪","♫","☸","▶","◀","↕","‼","⁋","☯","⌘","☖","↑","↓","→","←","Ω","↔","▲","▼"].forEach(((t,e)=>{this.draw(e,t)})),t||["⌂","Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","¢","£","¥","₧","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","⌐","¬","½","¼","¡","«","»","░","▒","▓","│","┤","╡","╢","╖","╕","╣","║","╗","╝","╜","╛","┐","└","┴","┬","├","─","┼","╞","╟","╚","╔","╩","╦","╠","═","╬","╧","╨","╤","╥","╙","╘","╒","╓","╫","╪","┘","┌","█","▄","▌","▐","▀","α","ß","Γ","π","Σ","σ","µ","τ","Φ","Θ","Ω","δ","∞","φ","ε","∩","≡","±","≥","≤","⌠","⌡","÷","≈","°","∙","·","√","ⁿ","²","■"," "].forEach(((t,e)=>{this.draw(e+127,t)}))}}function Wt(t,e,i,s){return s?((t=Math.max(0,Math.min(255,Math.round(2.550001*t))))<<16)+((e=Math.max(0,Math.min(255,Math.round(2.550001*e))))<<8)+(i=Math.max(0,Math.min(255,Math.round(2.550001*i)))):((t=Math.max(0,Math.min(15,Math.round(t/100*15))))<<8)+((e=Math.max(0,Math.min(15,Math.round(e/100*15))))<<4)+(i=Math.max(0,Math.min(15,Math.round(i/100*15))))}const Kt={};class Gt extends Int16Array{constructor(t=-1,e=0,i=0,s=0,r=0,n=0,h=0,l=!1){super(7),this.dances=!1,this.set([t,e,i,s,r,n,h]),this.dances=l}get r(){return Math.round(2.550001*this[0])}get _r(){return this[0]}set _r(t){this[0]=t}get g(){return Math.round(2.550001*this[1])}get _g(){return this[1]}set _g(t){this[1]=t}get b(){return Math.round(2.550001*this[2])}get _b(){return this[2]}set _b(t){this[2]=t}get _rand(){return this[3]}get _redRand(){return this[4]}get _greenRand(){return this[5]}get _blueRand(){return this[6]}get l(){return Math.round(.5*(Math.min(this._r,this._g,this._b)+Math.max(this._r,this._g,this._b)))}get s(){return this.l>=100?0:Math.round((Math.max(this._r,this._g,this._b)-Math.min(this._r,this._g,this._b))*(100-Math.abs(2*this.l-100))/100)}get h(){let t=0,e=this.r,i=this.g,s=this.b;return t=e>=i&&i>=s?(i-s)/(e-s)*60:i>e&&e>=s?60*(2-(e-s)/(i-s)):i>=s&&s>e?60*(2+(s-e)/(i-e)):s>i&&i>e?60*(4-(i-e)/(s-e)):s>e&&e>=i?60*(4+(e-i)/(s-i)):60*(6-(s-i)/(e-i)),Math.round(t)}isNull(){return this._r<0}equals(t){if("string"==typeof t)return t.startsWith("#")?this.css(t.length>4)==t:this.name==t;if("number"==typeof t)return this.toInt()==t||this.toInt(!0)==t;const e=Qt(t);return this.isNull()?e.isNull():this.every(((t,i)=>t==e[i]))}copy(t){t instanceof Gt?this.dances=t.dances:Array.isArray(t)?8===t.length&&(this.dances=t[7]):(t=Qt(t),this.dances=t.dances);for(let e=0;e<this.length;++e)this[e]=t[e]||0;return t instanceof Gt?this.name=t.name:this._changed(),this}_changed(){return this.name=void 0,this}clone(){const t=new this.constructor;return t.copy(this),t}assign(t=-1,e=0,i=0,s=0,r=0,n=0,h=0,l){for(let t=0;t<this.length;++t)this[t]=arguments[t]||0;return void 0!==l&&(this.dances=l),this._changed()}assignRGB(t=-1,e=0,i=0,s=0,r=0,n=0,h=0,l){for(let t=0;t<this.length;++t)this[t]=Math.round((arguments[t]||0)/2.55);return void 0!==l&&(this.dances=l),this._changed()}nullify(){return this[0]=-1,this.dances=!1,this._changed()}blackOut(){for(let t=0;t<this.length;++t)this[t]=0;return this.dances=!1,this._changed()}toInt(t=!1){if(this.isNull())return-1;if(!this.dances)return Wt(this._r,this._g,this._b,t);const e=x.number(this._rand),i=x.number(this._redRand),s=x.number(this._greenRand),r=x.number(this._blueRand);return Wt(this._r+e+i,this._g+e+s,this._b+e+r,t)}toLight(){return[this._r,this._g,this._b]}clamp(){return this.isNull()?this:(this._r=Math.min(100,Math.max(0,this._r)),this._g=Math.min(100,Math.max(0,this._g)),this._b=Math.min(100,Math.max(0,this._b)),this._changed())}mix(t,e){const i=Qt(t);if(i.isNull())return this;this.isNull()&&this.blackOut();const s=100-(e=Math.min(100,Math.max(0,e)));for(let t=0;t<this.length;++t)this[t]=Math.round((this[t]*s+i[t]*e)/100);return this.dances=this.dances||i.dances,this._changed()}lighten(t){if(this.isNull())return this;if((t=Math.min(100,Math.max(0,t)))<=0)return;const e=100-t;for(let i=0;i<3;++i)this[i]=Math.round((this[i]*e+100*t)/100);return this._changed()}darken(t){if(this.isNull())return this;if((t=Math.min(100,Math.max(0,t)))<=0)return;const e=100-t;for(let i=0;i<3;++i)this[i]=Math.round((this[i]*e+0*t)/100);return this._changed()}bake(t=!1){if(this.isNull())return this;if(this.dances&&!t)return;this.dances=!1;const e=this;if(e[3]+e[4]+e[5]+e[6]){const t=x.number(this._rand),e=x.number(this._redRand),i=x.number(this._greenRand),s=x.number(this._blueRand);this._r+=t+e,this._g+=t+i,this._b+=t+s;for(let t=3;t<this.length;++t)this[t]=0;return this._changed()}return this}add(t,e=100){const i=Qt(t);if(i.isNull())return this;this.isNull()&&this.blackOut();for(let t=0;t<this.length;++t)this[t]+=Math.round(i[t]*e/100);return this.dances=this.dances||i.dances,this._changed()}scale(t){if(this.isNull()||100==t)return this;t=Math.max(0,t);for(let e=0;e<this.length;++e)this[e]=Math.round(this[e]*t/100);return this._changed()}multiply(t){if(this.isNull())return this;let e=t;if(!Array.isArray(t)){if(t.isNull())return this;e=t}const i=Math.max(3,Math.min(this.length,e.length));for(let t=0;t<i;++t)this[t]=Math.round(this[t]*(e[t]||0)/100);return this._changed()}normalize(){if(this.isNull())return this;const t=Math.max(this._r,this._g,this._b);return t<=100?this:(this._r=Math.round(100*this._r/t),this._g=Math.round(100*this._g/t),this._b=Math.round(100*this._b/t),this._changed())}css(t=!1){return"#"+this.toInt(t).toString(16).padStart(t?6:3,"0")}toString(t=!1){return this.name?this.name:this.isNull()?"null color":this.css(t)}}function jt(t,e=!1){for(;t.length<3;)t.push(0);if(e)for(let e=0;e<7;++e)t[e]=Math.round(100*(t[e]||0)/255);return new Gt(...t)}function Xt(t){if(!t.startsWith("#"))throw new Error('Color CSS strings must be of form "#abc" or "#abcdef" - received: ['+t+"]");const e=Number.parseInt(t.substring(1),16);let i,s,r;return 4==t.length?(i=Math.round((e>>8)/15*100),s=Math.round(((240&e)>>4)/15*100),r=Math.round((15&e)/15*100)):(i=Math.round((e>>16)/255*100),s=Math.round(((65280&e)>>8)/255*100),r=Math.round((255&e)/255*100)),new Gt(i,s,r)}function zt(t){const e=Kt[t];if(!e)throw new Error("Unknown color name: "+t);return e}function $t(t,e=!1){const i=new Gt;for(let t=0;t<i.length;++t)i[t]=0;return t<0?i.assign(-1):e||t>4095?i.assign(Math.round(100*((16711680&t)>>16)/255),Math.round(100*((65280&t)>>8)/255),Math.round(100*(255&t)/255)):i.assign(Math.round(100*((3840&t)>>8)/15),Math.round(100*((240&t)>>4)/15),Math.round(100*(15&t)/15)),i}function qt(...t){let e=t[0],i=t[1];if(0==t.length)return new Gt;if(t.length>2&&(e=t,i=!1),null==e)return new Gt(-1);if(e instanceof Gt)return e.clone();if("string"==typeof e)return e.startsWith("#")?Xt(e):zt(e).clone();if(Array.isArray(e))return jt(e,i);if("number"==typeof e)return $t(e,i);throw new Error("Failed to make color - unknown argument: "+JSON.stringify(e))}function Qt(...t){const e=t[0];return e instanceof Gt?e:void 0===e?new Gt(-1):"string"!=typeof e||e.startsWith("#")?qt(e,t[1]):zt(e)}function Jt(t,e){if(t.isNull()||e.isNull())return;const i=t.clone().clamp(),s=e.clone().clamp();let r=Math.abs(i.h-s.h);if(r>180&&(r=360-r),r>45)return;if(Math.abs(i.l-s.l)>=40)return;const[n,h]=[i,s].sort(((t,e)=>t.s-e.s));for(;h.l-n.l<40;)h.mix(se,5),n.mix(ie,5);t.copy(i),e.copy(s)}function Zt(t,...e){let i=e;1==e.length&&(i=e[0]);const s=i instanceof Gt?i:qt(i);return Kt[t]=s,s.name=t,s}function te(t,...e){let i;return i=1==e.length?Zt(t,e[0]):Zt(t,...e),Zt("light_"+t,i.clone().lighten(25)),Zt("lighter_"+t,i.clone().lighten(50)),Zt("lightest_"+t,i.clone().lighten(75)),Zt("dark_"+t,i.clone().darken(25)),Zt("darker_"+t,i.clone().darken(50)),Zt("darkest_"+t,i.clone().darken(75)),i}const ee=Zt("NONE",-1),ie=Zt("black",0),se=Zt("white",4095);te("teal",[30,100,100]),te("brown",[60,40,0]),te("tan",[80,70,55]),te("pink",[100,60,66]),te("gray",[50,50,50]),te("yellow",[100,100,0]),te("purple",[100,0,100]),te("green",[0,100,0]),te("orange",[100,50,0]),te("blue",[0,0,100]),te("red",[100,0,0]),te("amber",[100,75,0]),te("flame",[100,25,0]),te("fuchsia",[100,0,100]),te("magenta",[100,0,75]),te("crimson",[100,0,25]),te("lime",[75,100,0]),te("chartreuse",[50,100,0]),te("sepia",[50,40,25]),te("violet",[50,0,100]),te("han",[25,0,100]),te("cyan",[0,100,100]),te("turquoise",[0,100,75]),te("sea",[0,100,50]),te("sky",[0,75,100]),te("azure",[0,50,100]),te("silver",[75,75,75]),te("gold",[100,85,0]);var re={__proto__:null,colors:Kt,Color:Gt,fromArray:jt,fromCss:Xt,fromName:zt,fromNumber:$t,make:qt,from:Qt,separate:Jt,swap:function(t,e){const i=t.clone();t.copy(e),e.copy(i)},relativeLuminance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.2126+(t.g-e.g)*(t.g-e.g)*.7152+(t.b-e.b)*(t.b-e.b)*.0722)/65025)},distance:function(t,e){return Math.round(100*((t.r-e.r)*(t.r-e.r)*.3333+(t.g-e.g)*(t.g-e.g)*.3333+(t.b-e.b)*(t.b-e.b)*.3333)/65025)},install:Zt,installSpread:te,NONE:ee};class ne{constructor(t){this.ch=R(null==t?void 0:t.ch,-1),this.fg=Qt(null==t?void 0:t.fg),this.bg=Qt(null==t?void 0:t.bg)}_changed(){return this}copy(t){return this.ch=t.ch,this.fg.copy(t.fg),this.bg.copy(t.bg),this._changed()}clone(){const t=new ne;return t.copy(this),t}equals(t){return this.ch==t.ch&&this.fg.equals(t.fg)&&this.bg.equals(t.bg)}get dances(){return this.fg.dances||this.bg.dances}nullify(){return this.ch=-1,this.fg.nullify(),this.bg.nullify(),this._changed()}blackOut(){return this.ch=0,this.fg.blackOut(),this.bg.blackOut(),this._changed()}draw(t=-1,e=-1,i=-1){return t&&-1!==t&&(this.ch=t),-1!==e&&null!==e&&(e=Qt(e),this.fg.copy(e)),-1!==i&&null!==i&&(i=Qt(i),this.bg.copy(i)),this._changed()}drawSprite(t,e){return t===this?this:(void 0===e&&(e=t.opacity),void 0===e&&(e=100),e<=0?void 0:(t.ch&&(this.ch=t.ch),(t.fg&&-1!==t.fg||0===t.fg)&&this.fg.mix(t.fg,e),(t.bg&&-1!==t.bg||0===t.bg)&&this.bg.mix(t.bg,e),this._changed()))}invert(){return[this.bg,this.fg]=[this.fg,this.bg],this._changed()}multiply(t,e=!0,i=!0){return t=Qt(t),e&&this.fg.multiply(t),i&&this.bg.multiply(t),this._changed()}scale(t,e=!0,i=!0){return e&&this.fg.scale(t),i&&this.bg.scale(t),this._changed()}mix(t,e=50,i=e){return t=Qt(t),e>0&&this.fg.mix(t,e),i>0&&this.bg.mix(t,i),this._changed()}add(t,e=100,i=e){return t=Qt(t),e>0&&this.fg.add(t,e),i>0&&this.bg.add(t,i),this._changed()}separate(){return Jt(this.fg,this.bg),this._changed()}bake(t=!1){return this.fg.bake(t),this.bg.bake(t),this._changed(),{ch:this.ch,fg:this.fg.toInt(),bg:this.bg.toInt()}}toString(){return`{ ch: ${this.ch}, fg: ${this.fg.toString(!0)}, bg: ${this.bg.toString(!0)} }`}}var he={colorStart:"Ω",colorEnd:"∆",field:"§",defaultFg:null,defaultBg:null},le={eachColor:()=>{},default:(t,e,i)=>void 0!==i?`${i}.!!${t}!!`:`!!${t}!!`};function oe(t){const e=he.field,i=t.split(e).map(((t,i)=>i%2==0?ce(t):0==t.length?ce(e):function(t){const e=/((\w+) )?(\w+)(\.(\w+))?(%[\+\.\-\d]*[dsf])?/.exec(t)||[],i=e[2],s=e[3],r=e[5],n=e[6];let h=(l=s,function(t){const e=le[l];if(e)return e(l,t);const i=t[l];return void 0!==i?i:le.default(l,t)});var l;r&&r.length&&(h=function(t,e){return function(i){const s=e(i);if(!s)return le.default(t,i,s);const r=s[t];return void 0===r?le.default(t,i,s):r}}(r,h));i&&i.length&&(h=function(t,e){const i=le[t]||le.default;return function(s){const r=e(s);return i(t,s,r)}}(i,h));n&&n.length&&(h=n.endsWith("s")?function(t,e){const i=/%(-?\d*)s/.exec(t)||[],s=Number.parseInt(i[1]||"0");return function(t){let i=""+e(t);return s<0?i=i.padEnd(-s):s&&(i=i.padStart(s)),i}}(n,h):n.endsWith("d")?function(t,e){const i=/%([\+-]*)(\d*)d/.exec(t)||["","","0"];let s=Number.parseInt(i[2]||"0");const r=i[1].includes("+"),n=i[1].includes("-");return function(t){const i=Number.parseInt(e(t)||0);let h=""+i;return i>0&&r&&(h="+"+h),s&&n?h.padEnd(s):s?h.padStart(s):h}}(n,h):function(t,e){const i=/%([\+-]*)(\d*)(\.(\d+))?f/.exec(t)||["","","0"];let s=Number.parseInt(i[2]||"0");const r=i[1].includes("+"),n=i[1].includes("-"),h=Number.parseInt(i[4])||0;return function(t){const i=Number.parseFloat(e(t)||0);let l;return l=h?i.toFixed(h):""+i,i>0&&r&&(l="+"+l),s&&n?l.padEnd(s):s?l.padStart(s):l}}(n,h));return h}(t)));return function(t={}){return i.map((e=>e(t))).join("")}}function ae(t,e={}){return oe(t)(e)}function ce(t){return()=>t}function ue(t,e,i,s){if(null==t)return;if(!e)return;if(!(t=""+t).length)return;const r=[],n=le.eachColor;void 0===i&&(i=he.defaultFg),void 0===s&&(s=he.defaultBg);const h={fg:i,bg:s},l=he.colorStart,o=he.colorEnd;n(h);let a=0;for(let c=0;c<t.length;++c){const u=t[c];if(u==l){let e=c+1;for(;e<t.length&&t[e]!=l;)++e;if(e==t.length)return void console.warn(`Reached end of string while seeking end of color start section.\n- text: ${t}\n- start @: ${c}`);if(e!=c+1){r.push([h.fg,h.bg]);const i=t.substring(c+1,e).split("|");h.fg=i[0]||h.fg,h.bg=i[1]||h.bg,n(h),c=e;continue}++c}else if(u==o){if(t[c+1]!=o){const t=r.pop();[h.fg,h.bg]=t||[i,s];continue}++c}e(u,h.fg,h.bg,a,c),++a}}function fe(t){if(!t||0==t.length)return 0;let e=0;const i=he.colorStart,s=he.colorEnd;for(let r=0;r<t.length;++r){const n=t[r];if(n==i){r=t.indexOf(i,r+1)}else n==s||++e}return e}function _e(t){const e=he.colorStart,i=he.colorEnd;let s=0;for(;s<t.length;){const r=t[s];if(r==e){for(++s;t[s]!=e&&s<t.length;)++s;++s}else if(r==i)for(++s;t[s]==i&&s<t.length;)++s;else{if(/[A-Za-z]/.test(r))return t.substring(0,s)+r.toUpperCase()+t.substring(s+1);++s}}return t}function ge(t,e){const i=he.colorStart,s=he.colorEnd;let r=e,n=0,h=!0;for(;r<t.length;){const e=t[r];if(" "==e){for(;" "==t[r+1];)++r,++n;return[r,n]}if("-"==e)return[r,n];if("\n"==e)return[r,n];if(e!=i)e!=s?(n+=h?1:0,++r):(t[r+1]==s&&(n+=1,++r),r++);else{if(t[r+1]==i&&h){n+=1,r+=2;continue}h=!h,++r}}return[r,n]}function de(t,e,i,s=""){return t.substring(0,e)+s+t.substring(e+i)}function Ee(t,e,i,s,r,n){if(n>=r)return[t,s];if(r+1>2*e)throw new Error("Cannot hyphenate - word length > 2 * width");if(n<4&&r<=e)return[t=de(t,i-1,1,"\n"),s+1];n+e<=r&&(t=de(t,i-1,1,"\n"),n=e);return[t=de(t,function(t,e,i){const s=he.colorStart,r=he.colorEnd;let n=e;for(;i>0;){const e=t[n];if(e===s){if(++n,t[n]===s)--i;else for(;t[n]!==s;)++n;++n}else e===r?(t[n+1]===r&&(--i,++n),++n):(--i,++n)}return n}(t,i,Math.min(Math.floor(r/2),n-1)),0,"-\n"),s+2]}function pe(t,e,i=0){if(!e)throw new Error("Need string and width");if(t.length<e)return t;if(fe(t)<e)return t;if(-1==t.indexOf("\n"))return Ae(t,e,i);return t.split("\n").map(((t,s)=>Ae(t,e,s?i:0))).join("\n")}function Ae(t,e,i){if(t.length<e)return t;if(fe(t)<e)return t;let s=e;e-=i;let r=t,n=!0,h=-1;for(;h<r.length;){let[t,i]=ge(r,h+(n?1:0)),l=!1;if("-"==r[t]&&(t++,i++,l=!0),i>e)[r,t]=Ee(r,e,h+1,t,i,s);else if(i==s){const i=l?0:1;r=de(r,t,i,t<r.length?"\n":""),t+=1-i,s=e}else if(i>s){const o=n?1:0;r=de(r,h,o,"\n"),t+=1-o;s=e-i-(l?0:1)}else{s-=i+(l?0:1)}n=!l,h=t}return r}function Se(t,e,i=0){const s=he.colorStart,r=[];let n=pe(t,e,i),h=0,l=null,o=null;ue(n,((t,e,i,a,c)=>{if("\n"==t){let t=l||o?`${s}${l||""}${o?"|"+o:""}${s}`:"";r.push(t+n.substring(h,c)),h=c+1,l=e,o=i}}));let a=l||o?`${s}${l||""}${o?"|"+o:""}${s}`:"";return r.push(a+n.substring(h)),r}var Te={__proto__:null,compile:oe,apply:ae,eachChar:ue,length:fe,padStart:function(t,e,i=" "){const s=t.length-fe(t);return t.padStart(e+s,i)},padEnd:function(t,e,i=" "){const s=t.length-fe(t);return t.padEnd(e+s,i)},center:function(t,e,i=" "){const s=t.length,r=e-fe(t);if(r<=0)return t;const n=Math.floor(r/2);return t.padStart(s+n,i).padEnd(s+r,i)},firstChar:function(t){const e=he.colorStart,i=he.colorEnd;let s=0;for(;s<t.length;){const r=t[s];if(r===e){if(t[s+1]===e)return e;for(++s;t[s]!==e;)++s;++s}else{if(r!==i)return r;if(t[s+1]===i)return i;++s}}return null},capitalize:_e,removeColors:function(t){const e=he.colorStart,i=he.colorEnd;let s="",r=0;for(let n=0;n<t.length;++n){const h=t[n];if(h===e){if(t[n+1]==e){++n;continue}for(s+=t.substring(r,n),++n;t[n]!=e&&n<t.length;)++n;r=n+1}else if(h===i){if(t[n+1]==i){++n;continue}s+=t.substring(r,n),r=n+1}}return 0==r?t:(s+=t.substring(r),s)},wordWrap:pe,splitIntoLines:Se,configure:function(t={}){void 0!==t.fg&&(he.defaultFg=t.fg),void 0!==t.bg&&(he.defaultBg=t.bg),t.colorStart&&(he.colorStart=t.colorStart),t.colorEnd&&(he.colorEnd=t.colorEnd),t.field&&(he.field=t.field)},addHelper:function(t,e){le[t]=e},options:he};class Le{constructor(t,e){this._width=t,this._height=e,this._data=new Uint32Array(t*e)}get width(){return this._width}get height(){return this._height}resize(t,e){const i=this._data;this._width=t,this._height=e,i.length<t*e?(this._data=new Uint32Array(t*e),this._data.set(i,0)):this._data=i.slice(t*e)}get(t,e){let i=e*this.width+t;const s=this._data[i]||0;return{glyph:s>>24,fg:4095&s,bg:s>>12&4095}}toGlyph(t){return"number"==typeof t?t:t&&t.length?t.charCodeAt(0):-1}draw(t,e,i=-1,s=-1,r=-1){let n=e*this.width+t;const h=this._data[n]||0;"number"!=typeof i&&(i=this.toGlyph(i)),"number"!=typeof s&&(s=Qt(s).toInt()),"number"!=typeof r&&(r=Qt(r).toInt());const l=((i=i>=0?255&i:h>>24)<<24)+((r=r>=0?4095&r:h>>12&4095)<<12)+(s=s>=0?4095&s:4095&h);return this._data[n]=l,this}drawSprite(t,e,i){const s=null===i.ch?-1:i.ch,r=null===i.fg?-1:i.fg,n=null===i.bg?-1:i.bg;return this.draw(t,e,s,r,n)}blackOut(...t){return 0==t.length?this.fill(0,0,0):this.draw(t[0],t[1],0,0,0)}fill(t=0,e=4095,i=0){"string"==typeof t&&(t=this.toGlyph(t));const s=((t&=255)<<24)+((i&=4095)<<12)+(e&=4095);return this._data.fill(s),this}copy(t){return this._data.set(t._data),this}drawText(t,e,i,s=4095,r=-1){return"number"!=typeof s&&(s=Qt(s)),"number"!=typeof r&&(r=Qt(r)),ue(i,((i,s,r,n)=>{t+n>=this.width||this.draw(n+t,e,i,s,r)}),s,r),++e}wrapText(t,e,i,s,r=4095,n=-1,h=0){"number"!=typeof r&&(r=Qt(r)),"number"!=typeof n&&(n=Qt(n)),s=pe(s,i=Math.min(i,this.width-t),h);let l=t;for(ue(s,((s,r,n)=>{if("\n"==s){for(;l<t+i;)this.draw(l++,e,0,0,n);return++e,void(l=t+h)}this.draw(l++,e,s,r,n)}),r,n);l<t+i;)this.draw(l++,e,0,0,n);return++e}fillRect(t,e,i,s,r=-1,n=-1,h=-1){null===r&&(r=-1),"number"!=typeof r&&(r=this.toGlyph(r)),"number"!=typeof n&&(n=Qt(n).toInt()),"number"!=typeof h&&(h=Qt(h).toInt());for(let l=t;l<t+i;++l)for(let t=e;t<e+s;++t)this.draw(l,t,r,n,h);return this}blackOutRect(t,e,i,s,r=0){return"number"!=typeof r&&(r=Qt(r)),this.fillRect(t,e,i,s,0,0,r)}highlight(t,e,i,s){"number"!=typeof i&&(i=Qt(i));const r=new ne,n=this.get(t,e);return r.drawSprite(n),r.fg.add(i,s),r.bg.add(i,s),this.drawSprite(t,e,r),this}mix(t,e){"number"!=typeof t&&(t=Qt(t));const i=new ne;for(let s=0;s<this.width;++s)for(let r=0;r<this.height;++r){const n=this.get(s,r);i.drawSprite(n),i.fg.mix(t,e),i.bg.mix(t,e),this.drawSprite(s,r,i)}return this}dump(){const t=[];let e="    ";for(let t=0;t<this.width;++t)t%10==0&&(e+=" "),e+=t%10;t.push(e),t.push("");for(let e=0;e<this.height;++e){let i=`${(""+e).padStart(2)}] `;for(let t=0;t<this.width;++t){t%10==0&&(i+=" ");const s=this.get(t,e).glyph;i+=String.fromCharCode(s||32)}t.push(i)}console.log(t.join("\n"))}}class Ie extends Le{constructor(t){super(t.width,t.height),this._target=t,t.copyTo(this._data)}toGlyph(t){return this._target.toGlyph(t)}render(){return this._target.copy(this._data),this}load(){return this._target.copyTo(this._data),this}}class me extends Error{constructor(...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,me),this.name="NotSupportedError"}}class Re{constructor(t,e,i){this.mouse={x:-1,y:-1},this._renderRequested=!1,this._width=50,this._height=25,this._node=this._createNode(),this._createContext(),this._configure(t,e,i),this._buffer=new Ie(this)}get node(){return this._node}get width(){return this._width}get height(){return this._height}get tileWidth(){return this._glyphs.tileWidth}get tileHeight(){return this._glyphs.tileHeight}get pxWidth(){return this.node.clientWidth}get pxHeight(){return this.node.clientHeight}get glyphs(){return this._glyphs}set glyphs(t){this._setGlyphs(t)}toGlyph(t){return"number"==typeof t?t:this._glyphs.forChar(t)}get buffer(){return this._buffer}_createNode(){return document.createElement("canvas")}_configure(t,e,i){this._width=t,this._height=e,this._setGlyphs(i)}_setGlyphs(t){return t!==this._glyphs&&(this._glyphs=t,this.resize(this._width,this._height),!0)}resize(t,e){this._width=t,this._height=e,this._buffer&&this._buffer.resize(t,e);const i=this.node;i.width=this._width*this.tileWidth,i.height=this._height*this.tileHeight}_requestRender(){this._renderRequested||(this._renderRequested=!0,requestAnimationFrame((()=>this._render())))}copy(t){this._data.set(t),this._requestRender()}copyTo(t){t.set(this._data)}render(){this.buffer.render()}hasXY(t,e){return t>=0&&e>=0&&t<this.width&&e<this.height}set onclick(t){this.node.onclick=t?e=>{const i=_t(e,this._toX(e.offsetX),this._toY(e.offsetY));t(i)}:null}set onmousemove(t){this.node.onmousemove=t?e=>{const i=this._toX(e.offsetX),s=this._toY(e.offsetY);if(i==this.mouse.x&&s==this.mouse.y)return;this.mouse.x=i,this.mouse.y=s;const r=_t(e,i,s);t(r)}:null}set onmouseup(t){this.node.onmouseup=t?e=>{const i=_t(e,this._toX(e.offsetX),this._toY(e.offsetY));t(i)}:null}_toX(t){return f(Math.floor(this.width*(t/this.node.clientWidth)),0,this.width-1)}_toY(t){return f(Math.floor(this.height*(t/this.node.clientHeight)),0,this.height-1)}}class ye extends Re{constructor(t,e,i){super(t,e,i)}_createContext(){let t=this.node.getContext("webgl2");if(!t)throw new me("WebGL 2 not supported");this._gl=t,this._buffers={},this._attribs={},this._uniforms={};const e=function(t,...e){const i=t.createProgram();if([t.VERTEX_SHADER,t.FRAGMENT_SHADER].forEach(((s,r)=>{const n=t.createShader(s);if(t.shaderSource(n,e[r]),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n));t.attachShader(i,n)})),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(i));return i}(t,Ht,Yt);t.useProgram(e);const i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let s=0;s<i;s++){t.enableVertexAttribArray(s);let i=t.getActiveAttrib(e,s);this._attribs[i.name]=s}const s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<s;i++){let s=t.getActiveUniform(e,i);this._uniforms[s.name]=t.getUniformLocation(e,s.name)}t.uniform1i(this._uniforms.font,0),this._texture=function(t){let e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),e}(t)}_createGeometry(){const t=this._gl;this._buffers.position&&t.deleteBuffer(this._buffers.position),this._buffers.uv&&t.deleteBuffer(this._buffers.uv);let e=function(t,e,i,s){let r=i*s,n=new Uint16Array(r*Oe.length),h=new Uint8Array(r*Oe.length),l=0;for(let t=0;t<s;t++)for(let e=0;e<i;e++)Oe.forEach((i=>{n[l]=(l%2?t:e)+i,h[l]=i,l++}));const o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.vertexAttribIPointer(e.position,2,t.UNSIGNED_SHORT,0,0),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW);const a=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,a),t.vertexAttribIPointer(e.uv,2,t.UNSIGNED_BYTE,0,0),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),{position:o,uv:a}}(t,this._attribs,this.width,this.height);Object.assign(this._buffers,e)}_createData(){const t=this._gl,e=this._attribs,i=this.width*this.height;this._buffers.style&&t.deleteBuffer(this._buffers.style),this._data=new Uint32Array(6*i);const s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.vertexAttribIPointer(e.style,1,t.UNSIGNED_INT,0,0),Object.assign(this._buffers,{style:s})}_setGlyphs(t){if(!super._setGlyphs(t))return!1;const e=this._gl,i=this._uniforms;return e.uniform2uiv(i.tileSize,[this.tileWidth,this.tileHeight]),this._uploadGlyphs(),!0}_uploadGlyphs(){if(!this._glyphs.needsUpdate)return;const t=this._gl;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this._glyphs.node),this._requestRender(),this._glyphs.needsUpdate=!1}resize(t,e){super.resize(t,e);const i=this._gl,s=this._uniforms;i.viewport(0,0,this.node.width,this.node.height),i.uniform2ui(s.viewportSize,this.node.width,this.node.height),this._createGeometry(),this._createData()}copy(t){t.forEach(((t,e)=>{const i=6*e;this._data[i+2]=t,this._data[i+5]=t})),this._requestRender()}copyTo(t){const e=this.width*this.height;for(let i=0;i<e;++i){const e=6*i;t[i]=this._data[e+2]}}_render(){const t=this._gl;if(this._glyphs.needsUpdate)this._uploadGlyphs();else if(!this._renderRequested)return;this._renderRequested=!1,t.bindBuffer(t.ARRAY_BUFFER,this._buffers.style),t.bufferData(t.ARRAY_BUFFER,this._data,t.DYNAMIC_DRAW),t.drawArrays(t.TRIANGLES,0,this._width*this._height*6)}}class Ce extends Re{constructor(t,e,i){super(t,e,i)}_createContext(){const t=this.node.getContext("2d");if(!t)throw new me("2d context not supported!");this._ctx=t}resize(t,e){super.resize(t,e),this._data=new Uint32Array(t*e),this._changed=new Int8Array(t*e)}copy(t){for(let e=0;e<this._data.length;++e)this._data[e]!==t[e]&&(this._data[e]=t[e],this._changed[e]=1);this._requestRender()}_render(){this._renderRequested=!1;for(let t=0;t<this._changed.length;++t)this._changed[t]&&this._renderCell(t),this._changed[t]=0}_renderCell(t){const e=t%this.width,i=Math.floor(t/this.width),s=this._data[t],r=s/(1<<24)>>0,n=s>>12&4095,h=4095&s,l=e*this.tileWidth,o=i*this.tileHeight,a=r%16*this.tileWidth,c=Math.floor(r/16)*this.tileHeight,u=this.glyphs.ctx.getImageData(a,c,this.tileWidth,this.tileHeight);for(let t=0;t<u.width*u.height;++t){const e=u.data[4*t]/255,i=1-e;u.data[4*t+0]=e*(17*((3840&h)>>8))+i*(17*((3840&n)>>8)),u.data[4*t+1]=e*(17*((240&h)>>4))+i*(17*((240&n)>>4)),u.data[4*t+2]=e*(17*(15&h))+i*(17*(15&n)),u.data[4*t+3]=255}this._ctx.putImageData(u,l,o)}}const Oe=[0,0,1,0,0,1,0,1,1,0,1,1];var be={__proto__:null,NotSupportedError:me,BaseCanvas:Re,Canvas:ye,Canvas2D:Ce,make:function(...t){let e,i,s=t[0],r=t[1],n=t[2];1==t.length&&(n=t[0],r=n.height||34,s=n.width||80),n=n||{font:"monospace"},e=n.image?kt.fromImage(n.image):kt.fromFont(n);try{i=new ye(s,r,e)}catch(t){if(!(t instanceof me))throw t}if(i||(i=new Ce(s,r,e)),n.div){let t;"string"==typeof n.div?(t=document.getElementById(n.div),t||console.warn("Failed to find parent element by ID: "+n.div)):t=n.div,t&&t.appendChild&&t.appendChild(i.node)}if(n.io||n.loop){let t=n.loop||Et;i.onclick=e=>t.pushEvent(e),i.onmousemove=e=>t.pushEvent(e),i.onmouseup=e=>t.pushEvent(e)}return i},Glyphs:kt,DataBuffer:Le,makeDataBuffer:function(t,e){return new Le(t,e)},Buffer:Ie,makeBuffer:function(...t){return 1==t.length?new Ie(t[0]):new Le(t[0],t[1])}};class Ne{constructor(t,e,i,s=100){t||(t=null),this.ch=t,this.fg=Qt(e),this.bg=Qt(i),this.opacity=s>=0?s:100}clone(){return new Ne(this.ch,this.fg,this.bg,this.opacity)}toString(){return`{ ch: ${this.ch}, fg: ${this.fg.toString(!0)}, bg: ${this.bg.toString(!0)}, opacity: ${this.opacity} }`}}const we={};function ve(...t){let e,i=null,s=-1,r=-1;if(0==t.length)return new Ne(null,-1,-1);if(1==t.length&&Array.isArray(t[0])&&(t=t[0]),t.length>3?(e=t[3],t.pop()):2==t.length&&"number"==typeof t[1]&&t[0].length>1&&(e=t.pop()),t.length>1)i=t[0]||null,s=t[1],r=t[2];else if("string"==typeof t[0]&&1==t[0].length)i=t[0],s="white";else if("string"==typeof t[0]&&t[0].length>1||"number"==typeof t[0])r=t[0];else if(t[0]instanceof Gt)r=t[0];else{const n=t[0];i=n.ch||null,s=n.fg||-1,r=n.bg||-1,e=n.opacity}return"string"==typeof s?s=Qt(s):Array.isArray(s)?s=qt(s):null==s&&(s=-1),"string"==typeof r?r=Qt(r):Array.isArray(r)?r=qt(r):null==r&&(r=-1),new Ne(i,s,r,e)}var Me={__proto__:null,Sprite:Ne,sprites:we,make:ve,from:function(...t){if(1==t.length&&"string"==typeof t[0]){const e=we[t[0]];if(!e)throw new Error("Failed to find sprite: "+t[0]);return e}return ve(t)},install:function(t,...e){let i;return i=ve(...e),i.name=t,we[t]=i,i},Mixer:ne,makeMixer:function(t){return new ne(t)}};const De={},xe={},Fe={};function Pe(t,e){const i=oe(e);Fe[t]=i}xe.message=xe.message||{};const Be=[],Ue=[];var Ve=30,He=80,Ye=0,ke=!1;let We=null;function Ke(t,e){const i=Fe[t];i?t=i(e):e&&(t=ae(t,e)),je(),Ge(t)}function Ge(t){var e;const i=Se(t=_e(t),He);(null===(e=xe.message)||void 0===e?void 0:e.reverseMultiLine)&&i.reverse(),i.forEach((t=>function(t){fe(t)&&(Be[Ye]=t,Ue[Ye]=!1,Ye=(Ye+1)%Ve)}(t))),ke=!0}function je(){return!!We&&(Ge(We+"."),We=null,!0)}var Xe,ze={__proto__:null,templates:Fe,install:Pe,installAll:function(t){Object.entries(t).forEach((([t,e])=>Pe(t,e)))},needsUpdate:function(t){return t&&(ke=!0),ke},configure:function(t){t||(t={}),Ve=t.length||30,He=t.width||80;for(let t=0;t<Ve;++t)Be[t]=null,Ue[t]=!1},add:Ke,fromActor:function(t,e,i){(t.isPlayer()||t.isVisible())&&Ke(e,i)},forPlayer:function(t,e,i){t.isPlayer()&&Ke(e,i)},addCombat:function(t,e,i){if(t.isPlayer()||t.isVisible()){const t=Fe[e];t?e=t(i):i&&(e=ae(e,i)),function(t){We?We+=", "+_e(t):We=t;ke=!0}(e)}},confirmAll:function(){for(let t=0;t<Ue.length;t++)Ue[t]=!0;ke=!0},forEach:function(t){je();for(let e=0;e<Ve;++e){const i=(Ve-e+Ye-1)%Ve,s=Be[i];if(!s)return;if(!1===t(s,Ue[i],e))return}}};function $e(t){var e;if(!t)throw new Error("opts required to make effect.");if("string"==typeof t)throw new Error("Cannot make effect from string: "+t);"function"==typeof t&&(t={fn:t});const i={flags:H(Xe,t.flags),chance:null!==(e=t.chance)&&void 0!==e?e:0,next:null,id:t.id||"n/a"};return t.next&&("string"==typeof t.next?i.next=t.next:i.next=$e(t.next)),Object.values(ti).forEach((e=>e.make(t,i))),i}function qe(t){if(!t)throw new Error("Cannot make effect from null | undefined");if("string"==typeof t){const e=Je[t];if(e)return e;throw new Error("Unknown effect - "+t)}return $e(t)}function Qe(t){t.flags&=~Xe.E_FIRED}!function(t){t[t.E_NEXT_ALWAYS=V(0)]="E_NEXT_ALWAYS",t[t.E_NEXT_EVERYWHERE=V(1)]="E_NEXT_EVERYWHERE",t[t.E_FIRED=V(2)]="E_FIRED",t[t.E_NO_MARK_FIRED=V(3)]="E_NO_MARK_FIRED",t[t.E_PROTECTED=V(4)]="E_PROTECTED",t[t.E_TREAT_AS_BLOCKING=V(5)]="E_TREAT_AS_BLOCKING",t[t.E_PERMIT_BLOCKING=V(6)]="E_PERMIT_BLOCKING",t[t.E_ABORT_IF_BLOCKS_MAP=V(7)]="E_ABORT_IF_BLOCKS_MAP",t[t.E_BLOCKED_BY_ITEMS=V(8)]="E_BLOCKED_BY_ITEMS",t[t.E_BLOCKED_BY_ACTORS=V(9)]="E_BLOCKED_BY_ACTORS",t[t.E_BLOCKED_BY_OTHER_LAYERS=V(10)]="E_BLOCKED_BY_OTHER_LAYERS",t[t.E_SUPERPRIORITY=V(11)]="E_SUPERPRIORITY",t[t.E_SPREAD_CIRCLE=V(13)]="E_SPREAD_CIRCLE",t[t.E_SPREAD_LINE=V(14)]="E_SPREAD_LINE",t[t.E_EVACUATE_CREATURES=V(15)]="E_EVACUATE_CREATURES",t[t.E_EVACUATE_ITEMS=V(16)]="E_EVACUATE_ITEMS",t[t.E_BUILD_IN_WALLS=V(17)]="E_BUILD_IN_WALLS",t[t.E_MUST_TOUCH_WALLS=V(18)]="E_MUST_TOUCH_WALLS",t[t.E_NO_TOUCH_WALLS=V(19)]="E_NO_TOUCH_WALLS",t[t.E_CLEAR_GROUND=V(21)]="E_CLEAR_GROUND",t[t.E_CLEAR_SURFACE=V(22)]="E_CLEAR_SURFACE",t[t.E_CLEAR_LIQUID=V(23)]="E_CLEAR_LIQUID",t[t.E_CLEAR_GAS=V(24)]="E_CLEAR_GAS",t[t.E_CLEAR_TILE=V(25)]="E_CLEAR_TILE",t[t.E_CLEAR_CELL=t.E_CLEAR_GROUND|t.E_CLEAR_SURFACE|t.E_CLEAR_LIQUID|t.E_CLEAR_GAS]="E_CLEAR_CELL",t[t.E_ONLY_IF_EMPTY=t.E_BLOCKED_BY_ITEMS|t.E_BLOCKED_BY_ACTORS]="E_ONLY_IF_EMPTY",t[t.E_ACTIVATE_DORMANT_MONSTER=V(27)]="E_ACTIVATE_DORMANT_MONSTER",t[t.E_AGGRAVATES_MONSTERS=V(28)]="E_AGGRAVATES_MONSTERS",t[t.E_RESURRECT_ALLY=V(29)]="E_RESURRECT_ALLY"}(Xe||(Xe={}));const Je={};function Ze(t,e){const i=$e(e);return Je[t]=i,i.id=t,i}const ti={};function ei(t,e){ti[t]=e}async function ii(t,e,i,s,r={}){if(!t)return!1;if("string"==typeof t){const e=t;if(!(t=qe(e)))throw new Error("Failed to find effect: "+e)}const n=r;if(!n.force&&t.chance&&!D.chance(t.chance,1e4))return!1;const h=n.grid=z(e.width,e.height);let l=!0;const o=Object.values(ti);for(let r of o)await r.fire(t,e,i,s,n)&&(l=!0);if(!l||!e.isVisible(i,s)||t.flags&Xe.E_NO_MARK_FIRED||(t.flags|=Xe.E_FIRED),t.next&&(l||t.flags&Xe.E_NEXT_ALWAYS)&&!De.gameHasEnded){const r="string"==typeof t.next?qe(t.next):t.next;t.flags&Xe.E_NEXT_EVERYWHERE?await h.forEachAsync((async(t,i,s)=>{t&&await ii(r,e,i,s,n)})):await ii(r,e,i,s,n)}return $(h),l}class si{make(t,e){if(!t.message)return!0;if("string"!=typeof t.message)throw new Error("Emit must be configured with name of event to emit");return e.message=t.message,!0}async fire(t,e,i,s,r){if(!t.message)return!1;const n=!!(t.flags&Xe.E_FIRED);return!(!t.message||!t.message.length||n||!e.isVisible(i,s))&&(Ke(t.message,r),!0)}fireSync(t,e,i,s,r){if(!t.message)return!1;throw new Error('Cannot use "message" effects in build steps.')}}ei("message",new si);class ri{make(t,e){if(!t.emit)return!0;if("string"!=typeof t.emit)throw new Error('emit effects must be string name to emit: { emit: "EVENT" }');return e.emit=t.emit,!0}async fire(t,e,i,s,r){return!!t.emit&&await Pt(t.emit,i,s,r)}fireSync(t,e,i,s,r){if(!t.emit)return!1;throw new Error('Cannot use "emit" effects in build steps.')}}ei("emit",new ri);ei("fn",new class{make(t,e){if(!t.fn)return!0;if("function"!=typeof t.fn)throw new Error("fn effects must be functions.");return e.fn=t.fn,!0}async fire(t,e,i,s,r){return!!t.fn&&await t.fn(t,e,i,s,r)}fireSync(t,e,i,s,r){if(t.fn){const n=t.fn(t,e,i,s,r);if(!0===n||!1===n)return n;throw new Error("Cannot use async function effects in build steps.")}return!1}});var ni={__proto__:null,get Flags(){return Xe},reset:Qe,resetAll:function(){Object.values(Je).forEach((t=>Qe(t)))},effects:Je,install:Ze,installAll:function(t){Object.entries(t).forEach((([t,e])=>{Ze(t,e)}))},effectTypes:ti,installType:ei,make:$e,from:qe,fire:ii,fireSync:function t(e,i,s,r,n={}){if(!e)return!1;if("string"==typeof e){const t=e;if(!(e=qe(t)))throw new Error("Failed to find effect: "+t)}const h=n;if(!h.force&&e.chance&&!D.chance(e.chance,1e4))return!1;const l=h.grid=z(i.width,i.height);let o=!0;const a=Object.values(ti);for(let t of a)t.fireSync(e,i,s,r,h)&&(o=!0);if(!o||!i.isVisible(s,r)||e.flags&Xe.E_NO_MARK_FIRED||(e.flags|=Xe.E_FIRED),e.next&&(o||e.flags&Xe.E_NEXT_ALWAYS)&&!De.gameHasEnded){const n="string"==typeof e.next?qe(e.next):e.next;e.flags&Xe.E_NEXT_EVERYWHERE?l.forEach((async(e,s,r)=>{e&&t(n,i,s,r,h)})):t(n,i,s,r,h)}return $(l),o},MessageEffect:si,EmitEffect:ri};class hi{constructor(t={}){this.options={rounds:5,minWidth:10,minHeight:10,maxWidth:40,maxHeight:20,percentSeeded:50,birthParameters:"ffffffttt",survivalParameters:"ffffttttt"},Object.assign(this.options,t),this.options.birthParameters=this.options.birthParameters.toLowerCase(),this.options.survivalParameters=this.options.survivalParameters.toLowerCase(),this.options.minWidth>=this.options.maxWidth&&(this.options.minWidth=Math.round(.75*this.options.maxWidth),this.options.maxWidth=Math.round(1.25*this.options.maxWidth)),this.options.minHeight>=this.options.maxHeight&&(this.options.minHeight=Math.round(.75*this.options.maxHeight),this.options.maxHeight=Math.round(1.25*this.options.maxHeight))}carve(t,e,i){let s,r,n,h,l,o,a,c=new d(0,0,0,0);const u=z(t,e),f=Math.floor((u.width-this.options.maxWidth)/2),_=Math.floor((u.height-this.options.maxHeight)/2);let g=10;do{for(u.fill(0),s=0;s<this.options.maxWidth;s++)for(r=0;r<this.options.maxHeight;r++)u[s+f][r+_]=D.chance(this.options.percentSeeded)?1:0;for(n=0;n<this.options.rounds;n++)this._cellularAutomataRound(u)||(n=this.options.rounds);for(a=0,o=0,h=2,s=0;s<u.width;s++)for(r=0;r<u.height;r++)1==u[s][r]&&(l=u.floodFill(s,r,1,h),l>a&&(a=l,o=h),h++);u.valueBounds(o,c)}while((c.width<this.options.minWidth||c.height<this.options.minHeight||0==o)&&--g);for(s=0;s<u.width;s++)for(r=0;r<u.height;r++)u[s][r]==o&&i(s,r);return $(u),c}_cellularAutomataRound(t){let e,i,s,r,n,h,l;l=z(t.width,t.height),l.copy(t);let a=!1;for(e=0;e<t.width;e++)for(i=0;i<t.height;i++){for(s=0,h=0;h<o.length;h++)r=e+o[h][0],n=i+o[h][1],t.hasXY(r,n)&&l[r][n]&&s++;l[e][i]||"t"!=this.options.birthParameters[s]?l[e][i]&&"t"==this.options.survivalParameters[s]||(t[e][i]=0,a=!0):(t[e][i]=1,a=!0)}return $(l),a}}var li={__proto__:null,Blob:hi,fillBlob:function(t,e={}){return new hi(e).carve(t.width,t.height,((e,i)=>t[e][i]=1))},make:function(t={}){return new hi(t)}};const oi=xe.light={INTENSITY_DARK:20,INTENSITY_SHADOW:50},ai=qt();class ci{constructor(t,e,i,s=!1){this.fadeTo=0,this.passThroughActors=!1,this.id=null,this.color=Qt(t)||null,this.radius=P(e||1),this.fadeTo=i||0,this.passThroughActors=s}copy(t){this.color=t.color,this.radius.copy(t.radius),this.fadeTo=t.fadeTo,this.passThroughActors=t.passThroughActors}get intensity(){return ui(this.color)}paint(t,e,i,s=!1,r=!1){if(!t)return!1;let n,h=0,l=this.radius.value(),o=Math.ceil(l);if(o<1)return!1;ai.copy(this.color).bake();const a=!r&&!s&&!fi(ai),c=this.fadeTo,u=z(t.width,t.height,0);t.calcFov(e,i,o,this.passThroughActors,((t,e)=>{u[t][e]=1}));const f=[0,0,0];return u.forCircle(e,i,o,((s,r,o)=>{if(s){for(h=Math.floor(100-(100-c)*(p(e,i,r,o)/l)),n=0;n<3;++n)f[n]=Math.floor(ai[n]*h/100);t.addCellLight(r,o,f,a)}})),$(u),!0}}function ui(t){return Math.max(t[0],t[1],t[2])}function fi(t,e){var i;return e=null!=e?e:null===(i=xe.light)||void 0===i?void 0:i.INTENSITY_DARK,ui(t)<=(e||20)}function _i(t,e){var i;return e=null!=e?e:null===(i=xe.light)||void 0===i?void 0:i.INTENSITY_SHADOW,ui(t)<=(e||20)}function gi(...t){if(1==t.length){const e=t[0];if("string"==typeof e){const t=di[e];if(t)return t;const[i,s,r,n]=e.split(/[,|]/).map((t=>t.trim()));return new ci(Qt(i),B(s||1),Number.parseInt(r||"0"),!!n&&"false"!==n)}if(Array.isArray(e)){const[t,i,s,r]=e;return new ci(t,i,s,r)}if(e&&e.color)return new ci(Qt(e.color),B(e.radius),Number.parseInt(e.fadeTo||"0"),e.pass);throw new Error("Unknown Light config - "+e)}{const[e,i,s,r]=t;return new ci(e,i,s,r)}}const di={};function Ei(...t){1!=t.length&&I("Unknown Light config: "+JSON.stringify(t));const e=t[0];if("string"==typeof e){const t=di[e];if(t)return t}return e&&e.paint?e:gi(e)}function pi(t,...e){let i;return i=1==e.length?gi(e[0]):gi(e[0],e[1],e[2],e[3]),di[t]=i,i&&(i.id=t),i}var Ai;!function(t){t[t.LIT=V(0)]="LIT",t[t.IN_SHADOW=V(1)]="IN_SHADOW",t[t.DARK=V(2)]="DARK",t[t.CHANGED=V(4)]="CHANGED"}(Ai||(Ai={}));class Si{constructor(t,e={}){this.staticLights=null,this.site=t,this.ambient=Qt(e.ambient||"white").toLight(),this._changed=!1,this.glowLightChanged=!1,this.dynamicLightChanged=!1,this.light=q(t.width,t.height,(()=>this.ambient.slice())),this.glowLight=q(t.width,t.height,(()=>this.ambient.slice())),this.oldLight=q(t.width,t.height,(()=>this.ambient.slice())),this.flags=q(t.width,t.height),this.finishLightUpdate()}getAmbient(){return this.ambient}setAmbient(t){t instanceof Gt&&(t=t.toLight());for(let e=0;e<3;++e)this.ambient[e]=t[e];this.glowLightChanged=!0}get anyLightChanged(){return this.glowLightChanged||this.dynamicLightChanged}get changed(){return this._changed}getLight(t,e){return this.light[t][e]}isLit(t,e){return!!(this.flags[t][e]&Ai.LIT)}isDark(t,e){return!!(this.flags[t][e]&Ai.DARK)}isInShadow(t,e){return!!(this.flags[t][e]&Ai.IN_SHADOW)}lightChanged(t,e){return!!(this.flags[t][e]&Ai.CHANGED)}get width(){return this.site.width}get height(){return this.site.height}addStatic(t,e,i){const s={x:t,y:e,light:Ei(i),next:this.staticLights};return this.staticLights=s,this.glowLightChanged=!0,s}removeStatic(t,e,i){let s=this.staticLights;if(!s)return;function r(s){return s.x==t&&s.y==e&&(!i||i===s.light)}for(this.glowLightChanged=!0;s&&r(s);)s=this.staticLights=s.next;if(!s)return;let n=s.next;for(;n;)r(n)?s.next=n.next:s=n,n=n.next}eachStaticLight(t){r(this.staticLights,(e=>t(e.x,e.y,e.light))),this.site.eachGlowLight(((e,i,s)=>{t(e,i,s)}))}eachDynamicLight(t){this.site.eachDynamicLight(t)}update(t=!1){if(this._changed=!1,!t&&!this.anyLightChanged)return!1;this.startLightUpdate(),this.glowLightChanged?(this.eachStaticLight(((t,e,i)=>{i.paint(this,t,e)})),this.recordGlowLights(),this.glowLightChanged=!1):this.restoreGlowLights(),this.eachDynamicLight(((t,e,i)=>i.paint(this,t,e))),this.finishLightUpdate();const e=De.player;if(e){const t=di.PLAYERS_LIGHT;t&&t.radius&&t.paint(this,e.x,e.y,!0,!0)}return this.dynamicLightChanged=!1,this._changed=!0,!0}startLightUpdate(){let t=0;const e=_i(this.ambient)?Ai.IN_SHADOW:0;this.light.forEach(((i,s,r)=>{for(t=0;t<3;++t)this.oldLight[s][r][t]=i[t],i[t]=this.ambient[t];this.flags[s][r]=e}))}finishLightUpdate(){b(this.width,this.height,((t,e)=>{const i=this.oldLight[t][e],s=this.light[t][e];s.some(((t,e)=>t!==i[e]))&&(this.flags[t][e]|=Ai.CHANGED),fi(s)?this.flags[t][e]|=Ai.DARK:_i(s)||(this.flags[t][e]|=Ai.LIT)}))}recordGlowLights(){let t=0;this.light.forEach(((e,i,s)=>{const r=this.glowLight[i][s];for(t=0;t<3;++t)r[t]=e[t]}))}restoreGlowLights(){let t=0;this.light.forEach(((e,i,s)=>{const r=this.glowLight[i][s];for(t=0;t<3;++t)e[t]=r[t]}))}calcFov(t,e,i,s,r){const n=this.site;new St({isBlocked:(t,e)=>!(!s&&n.hasActor(t,e))&&n.blocksVision(t,e),hasXY:(t,e)=>n.hasXY(t,e)}).calculate(t,e,i,r)}addCellLight(t,e,i,s){const r=this.light[t][e];for(let t=0;t<3;++t)r[t]+=i[t];s&&!_i(i)&&(this.flags[t][e]&=~Ai.IN_SHADOW)}}var Ti,Li,Ii={__proto__:null,config:oi,Light:ci,intensity:ui,isDarkLight:fi,isShadowLight:_i,make:gi,lights:di,from:Ei,install:pi,installAll:function(t={}){Object.entries(t).forEach((([t,e])=>{pi(t,e)}))},LightSystem:Si};!function(t){t[t.L_SUPERPRIORITY=V(1)]="L_SUPERPRIORITY",t[t.L_SECRETLY_PASSABLE=V(2)]="L_SECRETLY_PASSABLE",t[t.L_BLOCKS_MOVE=V(3)]="L_BLOCKS_MOVE",t[t.L_BLOCKS_VISION=V(4)]="L_BLOCKS_VISION",t[t.L_BLOCKS_SURFACE=V(6)]="L_BLOCKS_SURFACE",t[t.L_BLOCKS_LIQUID=V(8)]="L_BLOCKS_LIQUID",t[t.L_BLOCKS_GAS=V(7)]="L_BLOCKS_GAS",t[t.L_BLOCKS_ITEMS=V(5)]="L_BLOCKS_ITEMS",t[t.L_BLOCKS_ACTORS=V(11)]="L_BLOCKS_ACTORS",t[t.L_BLOCKS_EFFECTS=V(9)]="L_BLOCKS_EFFECTS",t[t.L_BLOCKS_DIAGONAL=V(10)]="L_BLOCKS_DIAGONAL",t[t.L_INTERRUPT_WHEN_SEEN=V(12)]="L_INTERRUPT_WHEN_SEEN",t[t.L_LIST_IN_SIDEBAR=V(13)]="L_LIST_IN_SIDEBAR",t[t.L_VISUALLY_DISTINCT=V(14)]="L_VISUALLY_DISTINCT",t[t.L_BRIGHT_MEMORY=V(15)]="L_BRIGHT_MEMORY",t[t.L_INVERT_WHEN_HIGHLIGHTED=V(16)]="L_INVERT_WHEN_HIGHLIGHTED",t[t.L_BLOCKED_BY_STAIRS=t.L_BLOCKS_ITEMS|t.L_BLOCKS_SURFACE|t.L_BLOCKS_GAS|t.L_BLOCKS_LIQUID|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_ACTORS]="L_BLOCKED_BY_STAIRS",t[t.L_BLOCKS_SCENT=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION]="L_BLOCKS_SCENT",t[t.L_DIVIDES_LEVEL=t.L_BLOCKS_MOVE]="L_DIVIDES_LEVEL",t[t.L_WAYPOINT_BLOCKER=t.L_BLOCKS_MOVE]="L_WAYPOINT_BLOCKER",t[t.L_WALL_FLAGS=t.L_BLOCKS_MOVE|t.L_BLOCKS_VISION|t.L_BLOCKS_LIQUID|t.L_BLOCKS_GAS|t.L_BLOCKS_EFFECTS|t.L_BLOCKS_DIAGONAL]="L_WALL_FLAGS",t[t.L_BLOCKS_EVERYTHING=t.L_WALL_FLAGS|t.L_BLOCKS_ITEMS|t.L_BLOCKS_ACTORS|t.L_BLOCKS_SURFACE]="L_BLOCKS_EVERYTHING"}(Ti||(Ti={})),function(t){t[t.ALL_LAYERS=-1]="ALL_LAYERS",t[t.GROUND=0]="GROUND",t[t.SURFACE=1]="SURFACE",t[t.ITEM=2]="ITEM",t[t.ACTOR=3]="ACTOR",t[t.LIQUID=4]="LIQUID",t[t.GAS=5]="GAS",t[t.FX=6]="FX",t[t.UI=7]="UI"}(Li||(Li={}));var mi={__proto__:null,get GameObject(){return Ti},get Depth(){return Li}};class Ri{constructor(){this.sprite=new Ne,this.depth=1,this.light=null,this.flags={object:0},this.next=null,this.x=-1,this.y=-1}hasObjectFlag(t){return!!(this.flags.object&t)}hasAllObjectFlags(t){return(this.flags.object&t)===t}blocksMove(){return this.hasObjectFlag(Ti.L_BLOCKS_MOVE)}blocksVision(){return this.hasObjectFlag(Ti.L_BLOCKS_VISION)}blocksPathing(){return this.hasObjectFlag(Ti.L_BLOCKS_MOVE)}blocksEffects(){return this.hasObjectFlag(Ti.L_BLOCKS_EFFECTS)}itemFlags(){return 0}actorFlags(){return 0}}var yi={__proto__:null,flags:mi,GameObject:Ri};class Ci extends Ri{constructor(){super(),this.quantity=1,this.next=null,this.flags=this.flags||{},this.flags.item=0,this.depth=Li.ITEM}itemFlags(){return this.flags.item}hasItemFlag(t){return!!(this.flags.item&t)}hasAllItemFlags(t){return(this.flags.item&t)===t}forbidsCell(t){return!1}}var Oi,bi={__proto__:null,Item:Ci};!function(t){t[t.IS_PLAYER=V(0)]="IS_PLAYER"}(Oi||(Oi={}));var Ni={__proto__:null,get Actor(){return Oi},get GameObject(){return Ti},get Depth(){return Li}};class wi extends Ri{constructor(){super(),this.next=null,this.flags=this.flags||{},this.flags.actor=0,this.depth=Li.ACTOR}hasActorFlag(t){return!!(this.flags.actor&t)}hasAllActorFlags(t){return(this.flags.actor&t)===t}actorFlags(){return this.flags.actor}isPlayer(){return this.hasActorFlag(Oi.IS_PLAYER)}isVisible(){return!0}forbidsCell(t){return!1}}var vi,Mi,Di={__proto__:null,flags:Ni,Actor:wi};!function(t){t[t.T_BRIDGE=V(0)]="T_BRIDGE",t[t.T_AUTO_DESCENT=V(1)]="T_AUTO_DESCENT",t[t.T_LAVA=V(2)]="T_LAVA",t[t.T_DEEP_WATER=V(3)]="T_DEEP_WATER",t[t.T_IS_FLAMMABLE=V(5)]="T_IS_FLAMMABLE",t[t.T_SPONTANEOUSLY_IGNITES=V(6)]="T_SPONTANEOUSLY_IGNITES",t[t.T_IS_FIRE=V(7)]="T_IS_FIRE",t[t.T_EXTINGUISHES_FIRE=V(8)]="T_EXTINGUISHES_FIRE",t[t.T_IS_SECRET=V(9)]="T_IS_SECRET",t[t.T_IS_TRAP=V(10)]="T_IS_TRAP",t[t.T_SACRED=V(11)]="T_SACRED",t[t.T_UP_STAIRS=V(12)]="T_UP_STAIRS",t[t.T_DOWN_STAIRS=V(13)]="T_DOWN_STAIRS",t[t.T_PORTAL=V(14)]="T_PORTAL",t[t.T_IS_DOOR=V(15)]="T_IS_DOOR",t[t.T_ALLOWS_SUBMERGING=V(16)]="T_ALLOWS_SUBMERGING",t[t.T_ENTANGLES=V(17)]="T_ENTANGLES",t[t.T_REFLECTS=V(18)]="T_REFLECTS",t[t.T_STAND_IN_TILE=V(19)]="T_STAND_IN_TILE",t[t.T_CONNECTS_LEVEL=V(20)]="T_CONNECTS_LEVEL",t[t.T_BLOCKS_OTHER_LAYERS=V(21)]="T_BLOCKS_OTHER_LAYERS",t[t.T_HAS_STAIRS=t.T_UP_STAIRS|t.T_DOWN_STAIRS|t.T_PORTAL]="T_HAS_STAIRS",t[t.T_OBSTRUCTS_SCENT=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES|t.T_HAS_STAIRS]="T_OBSTRUCTS_SCENT",t[t.T_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_IS_FIRE|t.T_SPONTANEOUSLY_IGNITES|t.T_ENTANGLES]="T_PATHING_BLOCKER",t[t.T_LAKE_PATHING_BLOCKER=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_LAKE_PATHING_BLOCKER",t[t.T_WAYPOINT_BLOCKER=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER|t.T_SPONTANEOUSLY_IGNITES]="T_WAYPOINT_BLOCKER",t[t.T_DIVIDES_LEVEL=t.T_AUTO_DESCENT|t.T_IS_TRAP|t.T_LAVA|t.T_DEEP_WATER]="T_DIVIDES_LEVEL",t[t.T_MOVES_ITEMS=t.T_DEEP_WATER|t.T_LAVA]="T_MOVES_ITEMS",t[t.T_CAN_BE_BRIDGED=t.T_AUTO_DESCENT|t.T_LAVA|t.T_DEEP_WATER]="T_CAN_BE_BRIDGED",t[t.T_IS_DEEP_LIQUID=t.T_LAVA|t.T_AUTO_DESCENT|t.T_DEEP_WATER]="T_IS_DEEP_LIQUID"}(vi||(vi={})),function(t){t[t.TM_IS_WIRED=V(9)]="TM_IS_WIRED",t[t.TM_IS_CIRCUIT_BREAKER=V(10)]="TM_IS_CIRCUIT_BREAKER",t[t.TM_VANISHES_UPON_PROMOTION=V(15)]="TM_VANISHES_UPON_PROMOTION",t[t.TM_EXPLOSIVE_PROMOTE=V(21)]="TM_EXPLOSIVE_PROMOTE",t[t.TM_SWAP_ENCHANTS_ACTIVATION=V(25)]="TM_SWAP_ENCHANTS_ACTIVATION"}(Mi||(Mi={}));class xi{constructor(t){var e,i,s,r;this.index=-1,this.dissipate=2e3,this.effects={},this.priority=50,this.depth=0,this.light=null,this.groundTile=null,this.id=t.id||"n/a",this.dissipate=null!==(e=t.dissipate)&&void 0!==e?e:this.dissipate,this.priority=null!==(i=t.priority)&&void 0!==i?i:this.priority,this.depth=null!==(s=t.depth)&&void 0!==s?s:this.depth,this.light=t.light||null,this.groundTile=t.groundTile||null,this.sprite=ve(t),this.name=t.name||"tile",this.description=t.description||this.name,this.flavor=t.flavor||this.name,this.article=null!==(r=t.article)&&void 0!==r?r:null,this.flags=t.flags||{object:0,tile:0,tileMech:0},t.effects&&Object.assign(this.effects,t.effects)}hasObjectFlag(t){return!!(this.flags.object&t)}hasTileFlag(t){return!!(this.flags.tile&t)}hasTileMechFlag(t){return!!(this.flags.tileMech&t)}hasAllObjectFlags(t){return(this.flags.object&t)===t}hasAllTileFlags(t){return(this.flags.tile&t)===t}hasAllTileMechFlags(t){return(this.flags.tileMech&t)===t}blocksVision(){return!!(this.flags.object&Ti.L_BLOCKS_VISION)}blocksMove(){return!!(this.flags.object&Ti.L_BLOCKS_MOVE)}blocksPathing(){return this.blocksMove()||this.hasTileFlag(vi.T_PATHING_BLOCKER)}blocksEffects(){return!!(this.flags.object&Ti.L_BLOCKS_EFFECTS)}hasEffect(t){return t in this.effects}getName(t){let e={};if(!0===t||!1===t||"string"==typeof t?e.article=t:t&&(e=t),!e.article&&!e.color)return this.name;let i=this.name;if(e.color){let t=e.color;!0===e.color&&(t=this.sprite.fg||"white"),"string"!=typeof t&&(t=Qt(t).toString()),i=`Ω${t}Ω${this.name}∆`}if(e.article){i=("string"==typeof e.article?e.article:this.article||"a")+" "+i}return i}getDescription(){return this.description||this.getName()}getFlavor(){return this.flavor||this.getName()}}function Fi(t){var e,i,s,r,n,h,l;let o={effects:{},flags:{},sprite:{}};if(t.extends&&(o=Pi[t.extends],!o))throw new Error("Failed to find base tile: "+t.extends);const a={};Object.assign(a,o.effects),t.effects&&Object.entries(t.effects).forEach((([t,e])=>{null!==e?a[t]="string"!=typeof e?$e(e):e:delete a[t]}));const c={object:H(Ti,o.flags.object,t.flags),tile:H(vi,o.flags.tile,t.flags),tileMech:H(Mi,o.flags.tileMech,t.flags)};let u=o.depth||0;t.depth&&(u="string"==typeof t.depth?Li[t.depth]:t.depth);let f=o.light;t.light?f=gi(t.light):null===t.light&&(f=null);const _={id:t.id,flags:c,dissipate:null!==(e=t.dissipate)&&void 0!==e?e:o.dissipate,effects:a,priority:null!==(i=t.priority)&&void 0!==i?i:o.priority,depth:u,light:f,groundTile:t.groundTile||null,ch:null!==(s=t.ch)&&void 0!==s?s:o.sprite.ch,fg:null!==(r=t.fg)&&void 0!==r?r:o.sprite.fg,bg:null!==(n=t.bg)&&void 0!==n?n:o.sprite.bg,opacity:null!==(h=t.opacity)&&void 0!==h?h:o.sprite.opacity,name:t.name||o.name,description:t.description||o.description,flavor:t.flavor||o.flavor,article:null!==(l=t.article)&&void 0!==l?l:o.article};return new xi(_)}const Pi={},Bi=[];function Ui(t){return t instanceof xi?t:"string"==typeof t?Pi[t]||null:Bi[t]||null}function Vi(t,...e){let i=e[0];2==e.length&&(i=e[1],i.extends=e[0]),i.id=t;const s=Fi(i);return s.index=Bi.length,Bi.push(s),Pi[t]=s,s}Vi("NULL",{ch:"∅",fg:"white",bg:"black",flags:"L_BLOCKS_MOVE",name:"eerie nothingness",article:"an",priority:0}),Vi("FLOOR",{ch:"·",fg:[30,30,30,20,0,0,0],bg:[2,2,10,0,2,2,0],priority:10,article:"the"}),Vi("DOOR",{ch:"+",fg:[100,40,40],bg:[30,60,60],priority:30,flags:"T_IS_DOOR, L_BLOCKS_EFFECTS, L_BLOCKS_ITEMS, L_BLOCKS_VISION, L_VISUALLY_DISTINCT",article:"a",effects:{enter:{tile:"DOOR_OPEN"},open:{tile:"DOOR_OPEN_ALWAYS"}}}),Vi("DOOR_OPEN","DOOR",{ch:"'",fg:[100,40,40],bg:[30,60,60],priority:40,flags:"!L_BLOCKS_ITEMS, !L_BLOCKS_VISION",name:"open door",article:"an",effects:{tick:{chance:1e4,tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"},enter:null,open:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}}}),Vi("DOOR_OPEN_ALWAYS","DOOR_OPEN",{effects:{tick:null,close:{tile:"DOOR",flags:"E_SUPERPRIORITY, E_ONLY_IF_EMPTY"}}}),Vi("UP_STAIRS",{ch:"<",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_UP_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"upward staircase",article:"an",effects:{player:{emit:"UP_STAIRS"}}}),Vi("DOWN_STAIRS",{ch:">",fg:[100,50,50],bg:[40,20,20],priority:200,flags:"T_DOWN_STAIRS, L_BLOCKED_BY_STAIRS, L_VISUALLY_DISTINCT, L_LIST_IN_SIDEBAR",name:"downward staircase",article:"a",effects:{player:{emit:"DOWN_STAIRS"}}}),Vi("WALL",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_WALL_FLAGS",article:"a",name:"stone wall",description:"A wall made from rough cut stone.",flavor:"a rough stone wall"}),Vi("IMPREGNABLE",{ch:"#",fg:[7,7,7,0,3,3,3],bg:[40,40,40,10,10,0,5],priority:100,flags:"L_WALL_FLAGS, IMPREGNABLE",article:"a",name:"impregnable wall",description:"A wall made from very hard stone.",flavor:"an impregnable wall"}),Vi("LAKE",{ch:"~",fg:[5,8,20,10,0,4,15,!0],bg:[10,15,41,6,5,5,5,!0],priority:50,flags:"T_DEEP_WATER",name:"deep water",article:"the"}),Vi("SHALLOW",{ch:"·",fg:[5,8,10,10,0,4,15,!0],bg:[10,30,30,6,0,10,10,!0],priority:20,name:"shallow water",article:"the",depth:"SURFACE"}),Vi("BRIDGE",{ch:"=",fg:[100,40,40],priority:40,depth:"SURFACE",flags:"T_BRIDGE, L_VISUALLY_DISTINCT",article:"a",groundTile:"LAKE"});const Hi={Tile:vi,TileMech:Mi};var Yi,ki,Wi={__proto__:null,flags:Hi,Tile:xi,make:Fi,tiles:Pi,all:Bi,get:Ui,install:Vi,installAll:function(t){Object.entries(t).forEach((([t,e])=>{Vi(t,e)}))}};!function(t){t[t.SEARCHED_FROM_HERE=V(0)]="SEARCHED_FROM_HERE",t[t.PRESSURE_PLATE_DEPRESSED=V(1)]="PRESSURE_PLATE_DEPRESSED",t[t.KNOWN_TO_BE_TRAP_FREE=V(2)]="KNOWN_TO_BE_TRAP_FREE",t[t.CAUGHT_FIRE_THIS_TURN=V(3)]="CAUGHT_FIRE_THIS_TURN",t[t.EVENT_FIRED_THIS_TURN=V(4)]="EVENT_FIRED_THIS_TURN",t[t.EVENT_PROTECTED=V(5)]="EVENT_PROTECTED",t[t.IS_IN_LOOP=V(6)]="IS_IN_LOOP",t[t.IS_CHOKEPOINT=V(7)]="IS_CHOKEPOINT",t[t.IS_GATE_SITE=V(8)]="IS_GATE_SITE",t[t.IS_IN_ROOM_MACHINE=V(9)]="IS_IN_ROOM_MACHINE",t[t.IS_IN_AREA_MACHINE=V(10)]="IS_IN_AREA_MACHINE",t[t.IS_POWERED=V(11)]="IS_POWERED",t[t.IMPREGNABLE=V(12)]="IMPREGNABLE",t[t.NEEDS_REDRAW=V(14)]="NEEDS_REDRAW",t[t.CELL_CHANGED=V(15)]="CELL_CHANGED",t[t.HAS_SURFACE=V(16)]="HAS_SURFACE",t[t.HAS_LIQUID=V(17)]="HAS_LIQUID",t[t.HAS_GAS=V(18)]="HAS_GAS",t[t.HAS_PLAYER=V(19)]="HAS_PLAYER",t[t.HAS_ACTOR=V(20)]="HAS_ACTOR",t[t.HAS_DORMANT_MONSTER=V(21)]="HAS_DORMANT_MONSTER",t[t.HAS_ITEM=V(22)]="HAS_ITEM",t[t.IS_IN_PATH=V(23)]="IS_IN_PATH",t[t.IS_CURSOR=V(24)]="IS_CURSOR",t[t.STABLE_MEMORY=V(25)]="STABLE_MEMORY",t[t.IS_WIRED=V(26)]="IS_WIRED",t[t.IS_CIRCUIT_BREAKER=V(27)]="IS_CIRCUIT_BREAKER",t[t.COLORS_DANCE=V(30)]="COLORS_DANCE",t[t.IS_IN_MACHINE=t.IS_IN_ROOM_MACHINE|t.IS_IN_AREA_MACHINE]="IS_IN_MACHINE",t[t.PERMANENT_CELL_FLAGS=t.HAS_ITEM|t.HAS_DORMANT_MONSTER|t.STABLE_MEMORY|t.SEARCHED_FROM_HERE|t.PRESSURE_PLATE_DEPRESSED|t.KNOWN_TO_BE_TRAP_FREE|t.IS_IN_LOOP|t.IS_CHOKEPOINT|t.IS_GATE_SITE|t.IS_IN_MACHINE|t.IMPREGNABLE]="PERMANENT_CELL_FLAGS",t[t.HAS_ANY_ACTOR=t.HAS_PLAYER|t.HAS_ACTOR]="HAS_ANY_ACTOR",t[t.HAS_ANY_OBJECT=t.HAS_ITEM|t.HAS_ANY_ACTOR]="HAS_ANY_OBJECT",t[t.CELL_DEFAULT=t.NEEDS_REDRAW|t.CELL_CHANGED]="CELL_DEFAULT"}(Yi||(Yi={})),function(t){t[t.MAP_CHANGED=V(0)]="MAP_CHANGED",t[t.MAP_ALWAYS_LIT=V(3)]="MAP_ALWAYS_LIT",t[t.MAP_SAW_WELCOME=V(4)]="MAP_SAW_WELCOME",t[t.MAP_NO_LIQUID=V(5)]="MAP_NO_LIQUID",t[t.MAP_NO_GAS=V(6)]="MAP_NO_GAS",t[t.MAP_CALC_FOV=V(7)]="MAP_CALC_FOV",t[t.MAP_FOV_CHANGED=V(8)]="MAP_FOV_CHANGED",t[t.MAP_DANCES=V(9)]="MAP_DANCES",t[t.MAP_DEFAULT=0]="MAP_DEFAULT"}(ki||(ki={}));class Ki{constructor(t){this.cell=t}forEach(t){let e=this.cell._item;for(;e;)t(e),e=e.next;for(e=this.cell._actor;e;)t(e),e=e.next}some(t){let e=this.cell._item;for(;e;){if(t(e))return!0;e=e.next}for(e=this.cell._actor;e;){if(t(e))return!0;e=e.next}return!1}reduce(t,e){let i=this.cell._item;for(;i;)e=void 0===e?i:t(e,i),i=i.next;for(i=this.cell._actor;i;)e=void 0===e?i:t(e,i),i=i.next;return e}}class Gi{constructor(t){if(this.chokeCount=0,this._actor=null,this._item=null,this._objects=new Ki(this),this.flags={cell:0},this.tiles=[Pi.NULL],t){const e=Ui(t);this.setTile(e)}}copy(t){Object.assign(this.flags,t.flags),this.chokeCount=t.chokeCount,this.tiles=t.tiles.slice(),this._actor=t._actor,this._item=t._item}hasCellFlag(t){return!!(this.flags.cell&t)}setCellFlag(t){this.flags.cell|=t}clearCellFlag(t){this.flags.cell&=~t}hasObjectFlag(t){return this.tiles.some((e=>e&&e.flags.object&t))||this._objects.some((e=>!!(e.flags.object&t)))}hasAllObjectFlags(t){return(this.objectFlags()&t)==t}hasTileFlag(t){return this.tiles.some((e=>e&&e.flags.tile&t))}hasAllTileFlags(t){return(this.tileFlags()&t)==t}hasTileMechFlag(t){return this.tiles.some((e=>e&&e.flags.tileMech&t))}hasAllTileMechFlags(t){return(this.tileMechFlags()&t)==t}cellFlags(){return this.flags.cell}objectFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.object:0)),0)|this._objects.reduce(((t,e)=>t|e.flags.object),0)}tileFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tile:0)),0)}tileMechFlags(){return this.tiles.reduce(((t,e)=>t|(e?e.flags.tileMech:0)),0)}itemFlags(){return this._objects.reduce(((t,e)=>t|e.itemFlags()),0)}actorFlags(){return this._objects.reduce(((t,e)=>t|e.actorFlags()),0)}get needsRedraw(){return!!(this.flags.cell&Yi.NEEDS_REDRAW)}set needsRedraw(t){t?this.flags.cell|=Yi.NEEDS_REDRAW:this.flags.cell&=~Yi.NEEDS_REDRAW}depthPriority(t){const e=this.tiles[t];return e?e.priority:Pi.NULL.priority}highestPriority(){return this.tiles.reduce(((t,e)=>Math.max(t,e?e.priority:0)),Pi.NULL.priority)}depthTile(t){return this.tiles[t]||null}hasTile(t){return t?(t instanceof xi||(t=Ui(t)),this.tiles.includes(t)):this.tiles.some((t=>t))}hasDepthTile(t){const e=this.tiles[t];return!!e&&e!==Pi.NULL}highestPriorityTile(){return this.tiles.reduce(((t,e)=>e&&e.priority>=t.priority?e:t),Pi.NULL)}get tile(){return this.highestPriorityTile()}eachTile(t){this.tiles.forEach((e=>e&&t(e)))}tileWithObjectFlag(t){return this.tiles.find((e=>e&&e.flags.object&t))||null}tileWithFlag(t){return this.tiles.find((e=>e&&e.flags.tile&t))||null}tileWithMechFlag(t){return this.tiles.find((e=>e&&e.flags.tileMech&t))||null}blocksVision(){return this.tiles.some((t=>t&&t.blocksVision()))||this._objects.some((t=>t.blocksVision()))}blocksPathing(){return this.tiles.some((t=>t&&t.blocksPathing()))||this._objects.some((t=>t.blocksPathing()))}blocksMove(){return this.tiles.some((t=>t&&t.blocksMove()))||this._objects.some((t=>t.blocksMove()))}blocksEffects(){return this.tiles.some((t=>t&&t.blocksEffects()))||this._objects.some((t=>t.blocksEffects()))}blocksLayer(t){return this.tiles.some((e=>e&&!!(e.flags.tile&Hi.Tile.T_BLOCKS_OTHER_LAYERS)&&e.depth!=t))}isEmpty(){return this.tiles.every((t=>!t||t===Pi.NULL))&&null==this._actor&&null==this._item}isPassable(){return!this.blocksMove()}isWall(){return this.hasAllObjectFlags(Ti.L_WALL_FLAGS)}isStairs(){return this.hasTileFlag(vi.T_HAS_STAIRS)}hasKey(){return!1}setTile(t){return!!(t instanceof xi||(t=Ui(t)))&&(this.tiles[t.depth]=t,this.needsRedraw=!0,!0)}clear(){this.tiles=[Pi.NULL],this.needsRedraw=!0}clearDepth(t){return 0==t?(this.tiles[0]=Pi.NULL,this.needsRedraw=!0,!0):null!==this.tiles[t]&&(this.tiles[t]=null,this.needsRedraw=!0,!0)}clearDepthsWithFlags(t,e=0){for(let i=0;i<this.tiles.length;++i){const s=this.tiles[i];s&&(s.hasTileFlag(t)&&(e&&!s.hasTileMechFlag(e)||this.clearDepth(i)))}}eachGlowLight(t){this.tiles.forEach((e=>{e&&e.light&&t(e.light)}))}async activate(t,e,i,s,r={}){r.cell=this;let n=!1;if(void 0!==r.depth){const h=r.tile=this.depthTile(r.depth);if(h&&h.effects){const l=h.effects[t];n=await this._fire(l,e,i,s,r)}}else for(r.tile of this.tiles){if(!r.tile||!r.tile.effects)continue;const h=r.tile.effects[t];if(await this._fire(h,e,i,s,r)){n=!0;break}}return n}async _fire(t,e,i,s,r){"string"==typeof t&&(t=Je[t]);let n=!1;return t&&(n=await ii(t,e,i,s,r)),n}hasEffect(t){for(let e of this.tiles)if(e&&e.hasEffect(t))return!0;return!1}hasItem(){return this.hasCellFlag(Yi.HAS_ITEM)}get item(){return this._item}set item(t){this._item=t,t?this.setCellFlag(Yi.HAS_ITEM):this.clearCellFlag(Yi.HAS_ITEM),this.needsRedraw=!0}hasActor(){return this.hasCellFlag(Yi.HAS_ACTOR)}hasPlayer(){return this.hasCellFlag(Yi.HAS_PLAYER)}get actor(){return this._actor}set actor(t){this._actor=t,t?this.setCellFlag(Yi.HAS_ACTOR):this.clearCellFlag(Yi.HAS_ACTOR),this.needsRedraw=!0}getDescription(){return this.highestPriorityTile().description}getFlavor(){return this.highestPriorityTile().flavor}getName(t={}){return this.highestPriorityTile().getName(t)}dump(){var t,e,i,s;return(null===(e=null===(t=this._actor)||void 0===t?void 0:t.sprite)||void 0===e?void 0:e.ch)?this._actor.sprite.ch:(null===(s=null===(i=this._item)||void 0===i?void 0:i.sprite)||void 0===s?void 0:s.ch)?this._item.sprite.ch:this.highestPriorityTile().sprite.ch||" "}}class ji{constructor(t,e="layer"){this.map=t,this.depth=-1,this.properties={},this.name=e}copy(t){}async tick(t){return!1}}class Xi extends ji{constructor(t,e="actor"){super(t,e)}add(t,e,i,s){const r=this.map.cell(t,e);return!i.forbidsCell(r)&&(n(r,"actor",i),i.isPlayer()&&r.setCellFlag(Yi.HAS_PLAYER),i.x=t,i.y=e,!0)}remove(t){const e=this.map.cell(t.x,t.y);return!!h(e,"actor",t)&&(t.isPlayer()&&e.clearCellFlag(Yi.HAS_PLAYER),!0)}putAppearance(t,e,i){const s=this.map.cell(e,i);s.actor&&t.drawSprite(s.actor.sprite)}}class zi extends ji{constructor(t,e="item"){super(t,e)}add(t,e,i,s){const r=this.map.cell(t,e);return!i.forbidsCell(r)&&(n(r,"item",i),i.x=t,i.y=e,!0)}remove(t){return!!h(this.map.cell(t.x,t.y),"item",t)}putAppearance(t,e,i){const s=this.map.cell(e,i);s.item&&t.drawSprite(s.item.sprite)}}class $i extends ji{constructor(t,e="tile"){super(t,e)}set(t,e,i,s={}){const r=this.map.cell(t,e),n=r.depthTile(i.depth)||Pi.NULL;if(!s.superpriority&&n.priority>i.priority)return!1;if(r.blocksLayer(i.depth))return!1;if(s.blockedByItems&&r.hasItem())return!1;if(s.blockedByActors&&r.hasActor())return!1;if(s.blockedByOtherLayers&&r.highestPriority()>i.priority)return!1;if(i.depth>Li.GROUND&&i.groundTile){const s=r.depthTile(Li.GROUND);s&&s!==Pi.NULL||this.set(t,e,Ui(i.groundTile))}return!!r.setTile(i)&&(n.light!==i.light&&(this.map.light.glowLightChanged=!0),i.hasTileFlag(vi.T_IS_FIRE)&&r.setCellFlag(Yi.CAUGHT_FIRE_THIS_TURN),!0)}clear(t,e){return this.map.cell(t,e).clearDepth(this.depth)}async tick(t){for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){const i=this.map.cell(t,e);!i.hasCellFlag(Yi.HAS_ANY_ACTOR|Yi.HAS_ITEM)&&i.hasCellFlag(Yi.PRESSURE_PLATE_DEPRESSED)&&i.clearCellFlag(Yi.PRESSURE_PLATE_DEPRESSED),i.hasEffect("noKey")&&!i.hasKey()&&await i.activate("noKey",this.map,t,e)}return!0}putAppearance(t,e,i){const s=this.map.cell(e,i).depthTile(this.depth);s&&s!==Pi.NULL&&t.drawSprite(s.sprite)}}class qi{constructor(){this.chokeCount=0,this.flags={cell:0,item:0,actor:0,tile:0,tileMech:0,object:0},this.blocks={vision:!1,effects:!1,move:!1,pathing:!1},this._tile=Pi.NULL,this._item=null,this._actor=null,this._hasKey=!1,this.snapshot=new ne}clear(){this.snapshot.blackOut(),this._item=null,this._actor=null,this._tile=Pi.NULL,this.flags.cell=0,this.flags.object=0,this.flags.tile=0,this.flags.tileMech=0,this.blocks.effects=!1,this.blocks.move=!1,this.blocks.pathing=!1,this.blocks.vision=!1,this._hasKey=!1}store(t){this._item=null,t.hasItem()&&(this._item=t.item),this._actor=null,t.hasActor()&&(this._actor=t.actor),this._tile=t.tile,this.flags.cell=t.cellFlags(),this.flags.tile=t.tileFlags(),this.flags.tileMech=t.tileMechFlags(),this.flags.object=t.objectFlags(),this.flags.item=t.itemFlags(),this.flags.actor=t.actorFlags(),this.blocks.effects=t.blocksEffects(),this.blocks.move=t.blocksMove(),this.blocks.pathing=t.blocksPathing(),this.blocks.vision=t.blocksVision(),this._hasKey=t.hasKey()}getSnapshot(t){t.copy(this.snapshot)}putSnapshot(t){this.snapshot.copy(t)}hasCellFlag(t){return!!(this.flags.cell&t)}hasTileFlag(t){return!!(this.flags.tile&t)}hasAllTileFlags(t){return(this.flags.tile&t)==t}hasObjectFlag(t){return!!(this.flags.object&t)}hasAllObjectFlags(t){return(this.flags.object&t)==t}hasTileMechFlag(t){return!!(this.flags.tileMech&t)}cellFlags(){return this.flags.cell}objectFlags(){return this.flags.object}tileFlags(){return this.flags.tile}tileMechFlags(){return this.flags.tileMech}itemFlags(){return this.flags.item}actorFlags(){return this.flags.actor}blocksVision(){return this.blocks.vision}blocksPathing(){return this.blocks.pathing}blocksMove(){return this.blocks.move}blocksEffects(){return this.blocks.effects}isWall(){return this.blocksVision()&&this.blocksMove()}isStairs(){return this.hasTileFlag(vi.T_HAS_STAIRS)}hasKey(){return this._hasKey}get tile(){return this._tile}hasTile(t){return t instanceof xi||(t=Ui(t)),this._tile===t}hasItem(){return!!this._item}get item(){return this._item}hasActor(){return!!this._actor}hasPlayer(){return!!(this.flags.cell&Yi.HAS_PLAYER)}get actor(){return this._actor}getDescription(){throw new Error("Method not implemented.")}getFlavor(){throw new Error("Method not implemented.")}getName(t){throw new Error("Method not implemented.")}}const Qi=Li,Ji=Ti,Zi=vi,ts=Mi,es=Yi;class is extends $i{constructor(t,e="tile"){super(t,e)}async tick(t){for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){this.map.cell(t,e).clearCellFlag(es.CAUGHT_FIRE_THIS_TURN)}for(let t=0;t<this.map.width;++t)for(let e=0;e<this.map.height;++e){const i=this.map.cell(t,e);if(i.hasTileFlag(Zi.T_IS_FIRE)&&!(i.flags.cell&es.CAUGHT_FIRE_THIS_TURN)){await this.exposeToFire(t,e,!1);for(let i=0;i<4;++i){const s=o[i];await this.exposeToFire(t+s[0],e+s[1])}}}return!0}async exposeToFire(t,e,i=!1){let s=0,r=0,n=0,h=!1,l=!1;const o=this.map.cell(t,e);if(!o.hasTileFlag(Zi.T_IS_FLAMMABLE))return!1;if(o.eachTile((t=>{t.hasTileFlag(Zi.T_EXTINGUISHES_FIRE)&&t.priority>r&&(r=t.priority)})),o.eachTile((t=>{if(t.flags.tile&Zi.T_IS_FLAMMABLE&&(t.depth===Qi.GAS||t.priority>=r)){const e=qe(t.effects.fire);e&&e.chance>s&&(s=e.chance)}})),i||s&&D.chance(s,1e4)){h=!0,o.hasTileMechFlag(ts.TM_EXPLOSIVE_PROMOTE)&&(E(t,e,((t,e)=>{const i=this.map.cell(t,e);(i.hasObjectFlag(Ji.L_BLOCKS_GAS)||i.hasTileFlag(Zi.T_IS_FIRE)||i.hasTileMechFlag(ts.TM_EXPLOSIVE_PROMOTE))&&++n})),n>=8&&(l=!0));let i="fire";l&&o.hasEffect("explode")&&(i="explode"),await o.activate(i,this.map,t,e,{force:!0}),o.needsRedraw=!0}return h}}const ss=Ti;class rs extends $i{constructor(t,e="gas"){super(t,e),this.needsUpdate=!1,this.volume=z(t.width,t.height,0)}set(t,e,i,s={}){if(!s.volume)return!1;return this.map.cell(t,e).depthTile(i.depth)===i?(this.volume[t][e]+=s.volume,!0):!!super.set(t,e,i,s)&&(this.volume[t][e]=s.volume,this.needsUpdate=!0,!0)}clear(t,e){return!!this.map.cell(t,e).clearDepth(this.depth)&&(this.volume[t][e]=0,!0)}copy(t){this.volume.copy(t.volume)}async tick(t){if(!this.needsUpdate)return!1;this.needsUpdate=!1;const e=this.volume;return this.volume=z(this.map.width,this.map.height),this.dissipate(e),this.spread(e),$(e),!0}dissipate(t){t.update(((t,e,i)=>{if(!t)return 0;const s=this.map.cell(e,i).depthTile(this.depth);if(s&&s.dissipate){let e=Math.max(.5,t*s.dissipate/1e4);t=Math.max(0,t-e)}return t?this.needsUpdate=!0:this.clear(e,i),t}))}calcOpacity(t){return Math.floor(10*Math.min(t,10))}updateCellVolume(t,e,i){let s=0,r=0,n=0;const h=this.map.cell(t,e);let l=h.depthTile(this.depth),o=l;if(h.hasObjectFlag(ss.L_BLOCKS_GAS))return this.volume[t][e]=0,void(i[t][e]&&this.clear(t,e));for(let l=Math.max(0,t-1);l<Math.min(t+2,i.width);++l)for(let t=Math.max(0,e-1);t<Math.min(e+2,i.height);++t){const e=i[l][t];h.hasObjectFlag(ss.L_BLOCKS_GAS)||(++r,e>n&&(n=e,o=this.map.cell(l,t).depthTile(this.depth))),s+=e}const a=Math.floor(10*s/r)/10;this.volume[t][e]=a,a>0&&o&&(l&&l===o||h.setTile(o)),a>0&&(h.needsRedraw=!0)}spread(t){for(let e=0;e<t.width;++e)for(let i=0;i<t.height;++i)this.updateCellVolume(e,i,t)}putAppearance(t,e,i){const s=this.volume[e][i];if(!s)return;const r=this.map.cell(e,i).depthTile(this.depth);if(r){const e=this.calcOpacity(s);t.drawSprite(r.sprite,e)}}}class ns{constructor(t,e,i={}){this.width=t,this.height=e,this.flags={map:0},this.layers=[],this.cells=q(t,e,(()=>new Gi)),this.memory=q(t,e,(()=>new qi)),this.light=new Si(this,i),this.fov=new Tt(this,i),this.properties={},this.initLayers()}cellInfo(t,e,i=!1){return i?this.memory[t][e]:this.cell(t,e)}initLayers(){this.addLayer(Li.GROUND,new $i(this,"ground")),this.addLayer(Li.SURFACE,new is(this,"surface")),this.addLayer(Li.GAS,new rs(this,"gas")),this.addLayer(Li.ITEM,new zi(this,"item")),this.addLayer(Li.ACTOR,new Xi(this,"actor"))}addLayer(t,e){"number"!=typeof t&&(t=Li[t]),e.depth=t,this.layers[t]=e}removeLayer(t){if("number"!=typeof t&&(t=Li[t]),!t)throw new Error("Cannot remove layer with depth=0.");delete this.layers[t]}getLayer(t){return"number"!=typeof t&&(t=Li[t]),this.layers[t]||null}hasXY(t,e){return this.cells.hasXY(t,e)}isBoundaryXY(t,e){return 0==t||0==e||t==this.width-1||e==this.height-1}cell(t,e){return this.cells[t][e]}get(t,e){return this.cells.get(t,e)}eachCell(t){this.cells.forEach(((e,i,s)=>t(e,i,s,this)))}drawInto(t,e={}){const i=t instanceof ye?t.buffer:t;"boolean"==typeof e&&(e={force:e});const s=new ne;for(let t=0;t<i.width;++t)for(let e=0;e<i.height;++e)this.getAppearanceAt(t,e,s),i.drawSprite(t,e,s)}itemAt(t,e){return this.cell(t,e).item}eachItem(t){this.cells.forEach((e=>{r(e.item,t)}))}addItem(t,e,i){return this.layers[i.depth].add(t,e,i)}removeItem(t){return this.layers[t.depth].remove(t)}moveItem(t,e,i){const s=this.layers[t.depth];return!!s.remove(t)&&s.add(e,i,t)}hasPlayer(t,e){return this.cell(t,e).hasPlayer()}actorAt(t,e){return this.cell(t,e).actor}eachActor(t){this.cells.forEach((e=>{r(e.actor,t)}))}addActor(t,e,i){return this.layers[i.depth].add(t,e,i)}removeActor(t){return this.layers[t.depth].remove(t)}moveActor(t,e,i){const s=this.layers[t.depth];return!!s.remove(t)&&s.add(e,i,t)}isVisible(t,e){return this.fov.isAnyKindOfVisible(t,e)}count(t){return this.cells.count(((e,i,s)=>t(e,i,s,this)))}dump(t,e=console.log){this.cells.dump(t||(t=>t.dump()),e)}hasMapFlag(t){return!!(this.flags.map&t)}setMapFlag(t){this.flags.map|=t}clearMapFlag(t){this.flags.map&=~t}setCellFlag(t,e,i){this.cell(t,e).setCellFlag(i)}clearCellFlag(t,e,i){this.cell(t,e).clearCellFlag(i)}fill(t,e){let i,s;for(t=Ui(t),e=Ui(e||t),i=0;i<this.width;++i)for(s=0;s<this.height;++s){const r=this.cell(i,s);r.clear(),r.setTile(this.isBoundaryXY(i,s)?e:t)}}hasTile(t,e,i,s=!1){return this.cellInfo(t,e,s).hasTile(i)}setTile(t,e,i,s){if(!(i instanceof xi||(i=Ui(i))))return!1;!0===s&&(s={superpriority:!0});const r=i.depth||0,n=this.layers[r]||this.layers[0];return n instanceof $i&&n.set(t,e,i,s)}async tick(t){let e=await this.fireAll("tick");for(let i of this.layers)i&&await i.tick(t)&&(e=!0);return e}copy(t){if(this.constructor!==t.constructor)throw new Error("Maps must be same type to copy.");if(this.width!==t.width||this.height!==t.height)throw new Error("Maps must be same size to copy");this.cells.forEach(((e,i,s)=>{e.copy(t.cells[i][s])})),this.layers.forEach(((e,i)=>{e.copy(t.layers[i])})),this.flags.map=t.flags.map,this.light.setAmbient(t.light.getAmbient())}clone(){const t=new this.constructor(this.width,this.height);return t.copy(this),t}async fire(t,e,i,s){return this.cell(e,i).activate(t,this,e,i,s)}async fireAll(t,e={}){const i=z(this.width,this.height);return this.cells.forEach(((e,s,r)=>{e.clearCellFlag(Yi.EVENT_FIRED_THIS_TURN|Yi.EVENT_PROTECTED),e.eachTile((n=>{const h=n.effects[t];if(!h)return;const l=qe(h);if(!l)return;let o=0;l.chance<0?(o=0,E(s,r,((t,i)=>{const s=this.cell(t,i);s.hasObjectFlag(Ti.L_BLOCKS_EFFECTS)||s.depthTile(n.depth)==e.depthTile(n.depth)||s.hasCellFlag(Yi.CAUGHT_FIRE_THIS_TURN)||(o+=-1*l.chance)}),!0)):o=l.chance||1e4,!e.hasCellFlag(Yi.CAUGHT_FIRE_THIS_TURN)&&D.chance(o,1e4)&&(i[s][r]|=V(n.depth))}))})),e.force=!0,await i.forEachAsync((async(e,i,s)=>{if(!e)return;const r=this.cell(i,s);if(!r.hasCellFlag(Yi.EVENT_FIRED_THIS_TURN))for(let n=0;n<=Li.GAS;++n)e&V(n)&&await r.activate(t,this,i,s,{force:!0,depth:n})})),$(i),!1}getAppearanceAt(t,e,i){i.blackOut();const s=this.cell(t,e),r=this.fov.isAnyKindOfVisible(t,e);if(s.needsRedraw&&r?(this.layers.forEach((s=>s.putAppearance(i,t,e))),i.dances?s.setCellFlag(Yi.COLORS_DANCE):s.clearCellFlag(Yi.COLORS_DANCE),i.bake(),this.memory[t][e].putSnapshot(i),s.needsRedraw=!1):this.memory[t][e].getSnapshot(i),r){const s=this.light.getLight(t,e);i.multiply(s)}else this.fov.isRevealed(t,e)?i.scale(50):i.blackOut();s.hasObjectFlag(Ti.L_VISUALLY_DISTINCT)&&Jt(i.fg,i.bg)}hasActor(t,e){return this.cell(t,e).hasActor()}eachGlowLight(t){this.cells.forEach(((e,i,s)=>{e.eachGlowLight((e=>t(i,s,e)))}))}eachDynamicLight(t){}eachViewport(t){}lightingChanged(){return this.light.changed}hasVisibleLight(t,e){return!this.light.isDark(t,e)}blocksVision(t,e){return this.cell(t,e).blocksVision()}onCellRevealed(t,e){}redrawCell(t,e,i){i&&this.clearMemory(t,e),this.cells[t][e].needsRedraw=!0}clearMemory(t,e){this.memory[t][e].clear()}storeMemory(t,e){const i=this.cell(t,e);this.memory[t][e].store(i)}}function hs(t,e,i={},s){"string"==typeof i&&(i={tile:i}),s&&(i.boundary=s),!0===i.tile&&(i.tile="FLOOR"),!0===i.boundary&&(i.boundary="WALL");const r=new ns(t,e,i);return i.tile&&r.fill(i.tile,i.boundary),r.light.update(),r}function ls(t,e){const i=z(t.width,t.height),s=z(t.width,t.height);for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++){const r=t.cell(e,s);!r.blocksPathing()&&!r.blocksMove()||r.hasObjectFlag(Ti.L_SECRETLY_PASSABLE)?i[e][s]=1:i[e][s]=0}let r;for(let e=1;e<i.width-1;e++)for(let s=1;s<i.height-1;s++)if(t.cell(e,s).flags.cell&=~Yi.IS_CHOKEPOINT,i[e][s]&&!(t.cell(e,s).flags.cell&Yi.IS_IN_LOOP)){r=0;for(let n=0;n<8;n++){const h=e+a[(n+7)%8][0],l=s+a[(n+7)%8][1],o=e+a[n][0],c=s+a[n][1];if((t.hasXY(o,c)&&i[o][c])!=(t.hasXY(h,l)&&i[h][l])&&++r>2){(i[e-1][s]||i[e+1][s])&&(i[e][s-1]||i[e][s+1])||(t.cell(e,s).flags.cell|=Yi.IS_CHOKEPOINT);break}}}if(e){for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++)t.cell(e,s).chokeCount=3e4,t.cell(e,s).flags.cell&Yi.IS_IN_ROOM_MACHINE&&(i[e][s]=0);for(let e=0;e<t.width;e++)for(let r=0;r<t.height;r++){const n=t.cell(e,r);if(i[e][r]&&n.flags.cell&Yi.IS_CHOKEPOINT)for(let h=0;h<4;h++){const l=e+o[h][0],a=r+o[h][1];if(t.hasXY(l,a)&&i[l][a]&&!(t.cell(l,a).flags.cell&Yi.IS_CHOKEPOINT)){s.fill(0),i[e][r]=0;let h=os(t,s,i,l,a);if(i[e][r]=1,h>=4){for(let e=0;e<s.width;e++)for(let i=0;i<s.height;i++)s[e][i]&&h<t.cell(e,i).chokeCount&&(t.cell(e,i).chokeCount=h,t.cell(e,i).flags.cell&=~Yi.IS_GATE_SITE);h<n.chokeCount&&(n.chokeCount=h,n.flags.cell|=Yi.IS_GATE_SITE)}}}}}$(i),$(s)}function os(t,e,i,s,r){let n=2==i[s][r]?5e3:1;t.cell(s,r).flags.cell&Yi.IS_IN_AREA_MACHINE&&(n=1e4),e[s][r]=1;for(let h=0;h<4;h++){const l=s+o[h][0],a=r+o[h][1];t.hasXY(l,a)&&i[l][a]&&!e[l][a]&&(n+=os(t,e,i,l,a))}return Math.min(n,1e4)}function as(t){t.eachCell(cs),t.eachCell(us),_s(t)}function cs(t,e,i,s){!t.blocksPathing()&&!t.blocksMove()||t.hasObjectFlag(Ti.L_SECRETLY_PASSABLE)?t.flags.cell|=Yi.IS_IN_LOOP:t.flags.cell&=~Yi.IS_IN_LOOP}function us(t,e,i,s){let r,n,h,l,o,c,u,f;if(!(t&&t.flags.cell&Yi.IS_IN_LOOP))return!1;for(o=0;o<8;o++){if(n=e+a[o][0],h=i+a[o][1],!s.hasXY(n,h))continue;const t=s.get(n,h);if(!(t&&t.flags.cell&Yi.IS_IN_LOOP))break}if(8==o)return!1;for(c=u=f=0,r=!1,l=o;l<o+8;l++){if(n=e+a[l%8][0],h=i+a[l%8][1],!s.hasXY(n,h))continue;const t=s.get(n,h);if(t&&t.flags.cell&Yi.IS_IN_LOOP){if(f++,!r){if(c>0)return!1;c++,r=!0}}else r&&(f>u&&(u=f),f=0,r=!1)}if(r&&f>u&&(u=f),1==c&&u<=4){for(t.flags.cell&=~Yi.IS_IN_LOOP,l=0;l<8;l++){const t=e+a[l][0],r=i+a[l][1];if(s.hasXY(t,r)){us(s.cell(t,r),t,r,s)}}return!0}return!1}function fs(t,e){for(let i=0;i<t.width;++i)for(let s=0;s<t.height;++s){if(t.cell(i,s).flags.cell&Yi.IS_IN_LOOP)e[i][s]=1;else if(i>0&&s>0){const r=t.cell(i,s-1),n=t.cell(i-1,s);r.flags.cell&Yi.IS_IN_LOOP&&n.flags.cell&Yi.IS_IN_LOOP&&(e[i][s]=1)}}}function _s(t){const e=z(t.width,t.height);let i;fs(t,e);for(let s=0;s<e.width;s++)for(let r=0;r<e.height;r++){if(t.cell(s,r).flags.cell&Yi.IS_IN_LOOP){i=!1;for(let n=0;n<8;n++){let h=s+a[n][0],l=r+a[n][1];if(t.hasXY(h,l)&&!e[h][l]&&!(t.cell(h,l).flags.cell&Yi.IS_IN_LOOP)){i=!0;break}}i||(e[s][r]=1,t.cell(s,r).flags.cell&=~Yi.IS_IN_LOOP)}}$(e)}class gs{make(t,e){var i,s,r,n,h,l,o;if(!t.tile)return!0;let a=t.tile;if("string"==typeof a){const t=a.split(/[,|]/).map((t=>t.trim()));a={tile:t[0],grow:Number.parseInt(t[1]||"0"),decrement:Number.parseInt(t[2]||"0")}}const c={grow:null!==(s=null!==(i=a.grow)&&void 0!==i?i:a.spread)&&void 0!==s?s:0,decrement:null!==(r=a.decrement)&&void 0!==r?r:0,flags:H(Xe,a.flags),volume:null!==(n=a.volume)&&void 0!==n?n:0,next:null!==(h=a.next)&&void 0!==h?h:null},u=null!==(l=a.tile)&&void 0!==l?l:a.id;if("string"!=typeof u)throw new Error("Invalid tile spawn config: "+u);if(c.tile=u,!c.tile)throw new Error("Must have tile.");const f=null!==(o=a.matchTile)&&void 0!==o?o:a.match;if("string"==typeof f)c.matchTile=f;else if(f)throw new Error("Invalid tile spawn match tile: "+a.matchTile);return e.tile=c,!0}async fire(t,e,i,s,r){let n=!1;return this.fireSync(t,e,i,s,r)&&(n=!0),n}fireSync(t,e,i,s,r){if(!t.tile)return!1;const n=t.tile.tile,h=Pi[n]||null;if(!h)throw new Error("Failed to find tile for effect: "+n);const l=!!(t.flags&Xe.E_ABORT_IF_BLOCKS_MAP),o=!(!l||t.flags&Xe.E_PERMIT_BLOCKING||!(h.blocksPathing()||t.flags&Xe.E_TREAT_AS_BLOCKING));let a=!1;if(a=ps(t,e,i,s,r),!a)return!1;if(l&&o&&this.mapDisruptedBy(e,t.grid))return!1;t.flags&Xe.E_EVACUATE_CREATURES&&Ss(e,r.grid)&&(a=!0),t.flags&Xe.E_EVACUATE_ITEMS&&Ts(e,r.grid)&&(a=!0),t.flags&Xe.E_CLEAR_CELL&&As(e,r.grid,t.flags)&&(a=!0);return ds(t.flags,r.grid,e,h,t.tile.volume)}mapDisruptedBy(t,e,i=0,s=0){const r=z(t.width,t.height);let n=!1;b(t.width,t.height,((h,l)=>{const o=h+i,a=l+s;e.get(o,a)?t.cellInfo(h,l).isStairs()&&(n=!0):t.cellInfo(h,l).blocksMove()||(r[h][l]=1)}));let h=!0;for(let t=0;t<r.width&&!n;++t)for(let e=0;e<r.height&&!n;++e)1==r[t][e]&&(h?(r.floodFill(t,e,1,2),h=!1):n=!0);return $(r),n}}function ds(t,e,i,s,r=0){let n,h,l;l=!1;const o=!!(t&Xe.E_BLOCKED_BY_OTHER_LAYERS),a=!!(t&Xe.E_SUPERPRIORITY),c=!!(t&Xe.E_BLOCKED_BY_ACTORS),u=!!(t&Xe.E_BLOCKED_BY_ITEMS);for(r=r||0,n=0;n<e.width;n++)for(h=0;h<e.height;h++){if(!e[n][h])continue;e[n][h]=0;const f=i.cell(n,h);f.hasTile(s)||i.setTile(n,h,s,{volume:r,superpriority:a,blockedByOtherLayers:o,blockedByActors:c,blockedByItems:u})&&(e[n][h]=1,f.flags.cell|=Yi.EVENT_FIRED_THIS_TURN,t&Xe.E_PROTECTED&&(f.flags.cell|=Yi.EVENT_PROTECTED),l=!0)}return l&&i.setMapFlag(ki.MAP_CHANGED),l}function Es(t,e,i,s,r){if(!e.hasXY(i,s))return!1;const n=e.cell(i,s);if(n.hasCellFlag(Yi.EVENT_PROTECTED))return!1;if(n.blocksEffects()&&!t.tile.matchTile&&!r)return!1;if(t.flags&Xe.E_BUILD_IN_WALLS){if(!e.cellInfo(i,s).isWall())return!1}else if(t.flags&Xe.E_MUST_TOUCH_WALLS){let t=!1;if(E(i,s,((i,s)=>{e.cellInfo(i,s).isWall()&&(t=!0)}),!0),!t)return!1}else if(t.flags&Xe.E_NO_TOUCH_WALLS){let t=!0;if(e.cellInfo(i,s).isWall())return!1;if(E(i,s,((i,s)=>{e.cellInfo(i,s).isWall()&&(t=!1)}),!0),!t)return!1}return!(t.tile.matchTile&&!r&&!n.hasTile(t.tile.matchTile))}function ps(t,e,i,s,r){let n,h,l,a,c,u,f;const _=t.tile;let g=_.grow||0,d=_.decrement||0;const E=r.grid;if(E.fill(0),!Es(t,e,i,s,!0))return!1;E[i][s]=a=1;let p=1;if(g)for(f=!0,g>=100&&(d=d||100),d<=0&&(d=g);f&&g>0;){for(f=!1,a++,n=0;n<e.width;n++)for(h=0;h<e.height;h++)if(E[n][h]==a-1)for(l=0;l<4;l++)c=n+o[l][0],u=h+o[l][1],E.hasXY(c,u)&&!E[c][u]&&D.chance(g)&&Es(t,e,c,u,!1)&&(E[c][u]=a,f=!0,++p);g-=d}return p>0}function As(t,e,i=0){let s=!1;const r=(i&Xe.E_CLEAR_CELL)===Xe.E_CLEAR_CELL;return e.forEach(((e,n,h)=>{if(!e)return;const l=t.cell(n,h);r?l.clear():(i&Xe.E_CLEAR_GAS&&l.clearDepth(Li.GAS),i&Xe.E_CLEAR_LIQUID&&l.clearDepth(Li.LIQUID),i&Xe.E_CLEAR_SURFACE&&l.clearDepth(Li.SURFACE),i&Xe.E_CLEAR_GROUND&&l.clearDepth(Li.GROUND)),s=!0})),s}function Ss(t,e){let i=0,s=0,n=!1;for(i=0;i<t.width;i++)for(s=0;s<t.height;s++){if(!e[i][s])continue;const h=t.cell(i,s);h.hasActor()&&r(h.actor,(r=>{if(!(r instanceof wi))return;const h=r,l=D.matchingLocNear(i,s,((i,s)=>{if(!t.hasXY(i,s))return!1;if(e[i][s])return!1;const r=t.cell(i,s);return!h.forbidsCell(r)}));l&&l[0]>=0&&l[1]>=0&&(t.moveActor(h,l[0],l[1]),n=!0)}))}return n}function Ts(t,e){let i=!1;return e.forEach(((s,n,h)=>{if(!s)return;const l=t.cell(n,h);l.hasItem()&&r(l.item,(s=>{if(!(s instanceof Ci))return;const r=s,l=D.matchingLocNear(n,h,((i,s)=>{if(!t.hasXY(i,s))return!1;if(e[i][s])return!1;const n=t.cell(i,s);return!r.forbidsCell(n)}));l&&l[0]>=0&&l[1]>=0&&(t.moveItem(r,l[0],l[1]),i=!0)}))})),i}ei("tile",new gs);ei("clear",new class{make(t,e){if(!t.clear)return!0;let i=t.clear,s=0;if("string"==typeof i&&(i=i.split(/[,|]/).map((t=>t.trim()))),!0===i)s=Li.ALL_LAYERS;else if("number"==typeof i)s=i;else{if(!Array.isArray(i))throw new Error("clear effect must have number or string config.");s=i.reduce(((t,e)=>{if("number"==typeof e)return t|e;return t|(Li[e]||0)}),0)}return e.clear=s,s>0}fire(t,e,i,s,r){return this.fireSync(t,e,i,s,r)}fireSync(t,e,i,s,r){if(!t.clear)return!1;if(!e)return!1;return e.cell(i,s).clearDepth(t.clear)}});var Ls={__proto__:null,flags:{Cell:Yi,Map:ki,GameObject:Ti,Depth:Li,Tile:vi},Cell:Gi,Map:ns,make:hs,from:function(t,e,i={}){let s,r=0,n=0;return"string"==typeof t&&(t=t.split("\n")),!function(t){return Array.isArray(t)&&"string"==typeof t[0]}(t)?(r=t.height,n=t.width,s=hs(n,r,i),t.forEach(((t,i,r)=>{const n=e[t]||"FLOOR";s.setTile(i,r,n)}))):(r=t.length,n=t.reduce(((t,e)=>Math.max(t,e.length)),0),s=hs(n,r,i),t.forEach(((t,i)=>{for(let r=0;r<n;++r){const n=t[r]||".",h=e[n]||"FLOOR";s.setTile(r,i,h)}}))),s.light.update(),s},analyze:function(t,e=!0){as(t),ls(t,e)},updateChokepoints:ls,floodFillCount:os,updateLoopiness:as,resetLoopiness:cs,checkLoopiness:us,fillInnerLoopGrid:fs,cleanLoopiness:_s,SpawnEffect:gs,spawnTiles:ds,computeSpawnMap:ps,clearCells:As,evacuateCreatures:Ss,evacuateItems:Ts,CellMemory:qi,MapLayer:ji,ActorLayer:Xi,ItemLayer:zi,TileLayer:$i,GasLayer:rs,FireLayer:is};t.Random=M,t.actor=Di,t.blob=li,t.canvas=be,t.color=re,t.colors=Kt,t.config=xe,t.cosmetic=x,t.data=De,t.effect=ni,t.events=Bt,t.flag=Y,t.fov=Lt,t.frequency=Ut,t.gameObject=yi,t.grid=Q,t.io=At,t.item=bi,t.light=Ii,t.loop=Et,t.map=Ls,t.message=ze,t.path=wt,t.random=D,t.range=U,t.scheduler=Vt,t.sprite=Me,t.sprites=we,t.text=Te,t.tile=Wi,t.types={__proto__:null},t.utils=w,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-utils.min.js.map

!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,i){"use strict";class o{constructor(t,o,e,r=1){this.width=1,this.doors=[],this.x=t[0],this.y=t[1];const n=i.utils.DIRS[o];this.length=e,this.width=r,o===i.utils.UP||o===i.utils.DOWN?(this.x2=this.x+(r-1),this.y2=this.y+(e-1)*n[1]):(this.x2=this.x+(e-1)*n[0],this.y2=this.y+(r-1)),this.dir=o}translate(t,i){this.x+=t,this.y+=i,this.x2+=t,this.y2+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))}))}}class e{constructor(t,i,o,e,r){this.doors=[],this.hall=null,this.digger=t,this.x=i,this.y=o,this.width=e,this.height=r}get cx(){return this.x+Math.floor(this.width/2)}get cy(){return this.y+Math.floor(this.height/2)}translate(t,i){this.x+=t,this.y+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))})),this.hall&&this.hall.translate(t,i)}}var r={};function n(t,o){return t=t||{},o=o||{},Object.entries(o).forEach((([o,e])=>{let r=t[o];if("tile"===o)return void(void 0===r&&(t[o]=e));if(!0===e){if(!r)return void i.utils.WARN("Missing required config for digger: "+o)}else if("number"==typeof e)r=r||e;else{if(!Array.isArray(e))return void i.utils.WARN("Unexpected digger configuration parameter: ",o,""+e);r=r||e}const n=i.range.make(r);n||i.utils.ERROR("Invalid configuration for digger: "+o),t[o]=n})),t}var l={__proto__:null,Hall:o,Room:e,rooms:r,install:function(t,i,o){return(o=i(o||{})).fn=i,o.id=t,r[t]=o,o},checkConfig:n,cavern:function(t,o){if(t=n(t,{width:12,height:8}),!o)return t;let r,l,h;const a=t.width.value(),f=t.height.value(),s=t.tile||1;h=i.grid.alloc(o.width,o.height,0);const c=Math.floor(.5*a),u=a,d=Math.floor(.5*f),g=f;o.fill(0);const M=h.fillBlob(5,c,d,u,g,55,"ffffffttt","ffffttttt");return r=Math.floor((o.width-M.width)/2),l=Math.floor((o.height-M.height)/2),i.grid.offsetZip(o,h,r-M.x,l-M.y,s),i.grid.free(h),new e(t.id,r,l,M.width,M.height)},choiceRoom:function(t,o){let e;if(t=t||{},Array.isArray(t.choices))e=i.random.item.bind(i.random,t.choices);else{if("object"!=typeof t.choices)return i.utils.ERROR("Expected choices to be either array of choices or map { digger: weight }");e=i.random.weighted.bind(i.random,t.choices)}if(!o)return t;let n=e();const l=r[n];if(!l)return i.utils.ERROR("Missing digger choice: "+n);let h=l;return t.opts&&(h=Object.assign({},l,t.opts)),l.fn(h,o)},entrance:function(t,i){if(t=n(t,{width:20,height:10}),!i)return t;const o=t.width.value(),r=t.height.value(),l=t.tile||1,h=Math.floor(.4*o),a=r,f=o,s=Math.floor(.5*r),c=Math.floor(i.width/2-h/2-1),u=i.height-a-2,d=Math.floor(i.width/2-f/2-1),g=i.height-s-2;return i.fill(0),i.fillRect(c,u,h,a,l),i.fillRect(d,g,f,s,l),new e(t.id,Math.min(c,d),Math.min(u,g),Math.max(h,f),Math.max(a,s))},cross:function(t,o){if(t=n(t,{width:12,height:20}),!o)return t;const r=t.width.value(),l=t.height.value(),h=t.tile||1,a=r,f=Math.max(3,Math.floor(r*i.random.range(25,75)/100)),s=Math.max(3,Math.floor(l*i.random.range(25,75)/100)),c=l,u=Math.floor((o.width-a)/2),d=u+i.random.range(2,Math.max(2,a-f-2)),g=Math.floor((o.height-c)/2),M=g+i.random.range(2,Math.max(2,c-s-2));return o.fill(0),o.fillRect(u,M,a,s,h),o.fillRect(d,g,f,c,h),new e(t.id,u,g,Math.max(a,f),Math.max(s,c))},symmetricalCross:function(t,o){if(t=n(t,{width:7,height:7}),!o)return t;const r=t.width.value(),l=t.height.value(),h=t.tile||1;let a=Math.max(3,Math.floor(r*i.random.range(25,50)/100));l%2==0&&a>2&&(a-=1);let f=Math.max(3,Math.floor(l*i.random.range(25,50)/100));o.fill(0);const s=Math.floor((o.width-r)/2),c=Math.floor((o.height-f)/2);o.fillRect(s,c,r,f,h);const u=Math.floor((o.width-a)/2),d=Math.floor((o.height-l)/2);return o.fillRect(u,d,a,l,h),new e(t.id,Math.min(s,u),Math.min(c,d),Math.max(r,a),Math.max(l,f))},rectangular:function(t,i){if(t=n(t,{width:[3,6],height:[3,6]}),!i)return t;const o=t.width.value(),r=t.height.value(),l=t.tile||1;i.fill(0);const h=Math.floor((i.width-o)/2),a=Math.floor((i.height-r)/2);return i.fillRect(h,a,o,r,l),new e(t.id,h,a,o,r)},circular:function(t,i){if(t=n(t,{radius:[3,4]}),!i)return t;const o=t.radius.value(),r=t.tile||1;i.fill(0);const l=Math.floor(i.width/2),h=Math.floor(i.height/2);return o>1&&i.fillCircle(l,h,o,r),new e(t.id,l,h,2*o,2*o)},brogueDonut:function(t,o){if(t=n(t,{radius:[5,10],ringMinWidth:3,holeMinSize:3,holeChance:50}),!o)return t;const r=t.radius.value(),l=t.ringMinWidth.value(),h=t.holeMinSize.value(),a=t.tile||1;o.fill(0);const f=Math.floor(o.width/2),s=Math.floor(o.height/2);return o.fillCircle(f,s,r,a),r>l+h&&i.random.chance(t.holeChance.value())&&o.fillCircle(f,s,i.random.range(h,r-h),0),new e(t.id,f-r,s-r,2*r+1,2*r+1)},chunkyRoom:function(t,o){if(t=n(t,{count:[2,12],width:[5,20],height:[5,20]}),!o)return t;let r,l,h,a,f,s,c,u=t.count.value();const d=t.width.value(),g=t.height.value(),M=t.tile||1;for(a=Math.floor(o.width/2)-Math.floor(d/2),f=Math.floor(o.width/2)+Math.floor(d/2),s=Math.floor(o.height/2)-Math.floor(g/2),c=Math.floor(o.height/2)+Math.floor(g/2),o.fill(0),o.fillCircle(Math.floor(o.width/2),Math.floor(o.height/2),2,M),r=0;r<u;)if(l=i.random.range(a,f),h=i.random.range(s,c),o[l][h]){if(l-2<a)continue;if(l+2>f)continue;if(h-2<s)continue;if(h+2>c)continue;o.fillCircle(l,h,2,M),r++}const m=o.valueBounds(M);return new e(t.id,m.x,m.y,m.width,m.height)}};const h=i.utils.DIRS;function a(t,o){const e=i.utils.firstOpt("horizontalHallLength",o,[9,15]),r=i.utils.firstOpt("verticalHallLength",o,[2,9]);return t==i.utils.UP||t==i.utils.DOWN?r:e}function f(t,e,r,n,l){const a=n.doors[e],f=h[e];let s=a[0],c=a[1];const u=l.tile||1;for(let i=0;i<r;i++)t[s][c]=u,s+=f[0],c+=f[1];s-=f[0],c-=f[1];const d=new o(a,e,r);return d.doors=function(t,o,e,r,n){let l,a;const f=i.utils.firstOpt("obliqueChance",n,15),s=i.random.chance(f),c=[];for(let i=0;i<4;i++)l=o+h[i][0],a=e+h[i][1],i!=r&&!s||!t.hasXY(l,a)||t[l][a]||(c[i]=[l,a]);return c}(t,s,c,e,l),d}function s(t,e,r){const n=function(t,o,e){const r=o.doors;let n=e.dir||i.utils.NO_DIRECTION;if(n==i.utils.NO_DIRECTION){const o=i.random.sequence(4);for(let l=0;l<4;l++){n=o[l];const f=a(n,e)[1],s=r[n];if(s&&-1!=s[0]&&-1!=s[1]){const i=s[0]+Math.floor(h[n][0]*f),o=s[1]+Math.floor(h[n][1]*f);if(t.hasXY(i,o))break}n=i.utils.NO_DIRECTION}}return n}(t,e,r=r||{});if(n===i.utils.NO_DIRECTION)return null;console.log("dir",n);const l=i.random.range(...a(n,r));console.log("length",l);const s=r.width||1;return console.log("width",s),s>1?function(t,e,r,n,l){const h=n.doors[e],a=l.tile||1,f=[];let s,c,u;if(e===i.utils.UP){s=Math.max(h[0]-1,n.x),c=h[1]-r+1;for(let i=s;i<s+2;++i)for(let o=c;o<c+r;++o)t[i][o]=a;f[e]=[s,c-1],u=new o([s,h[1]],e,r,2)}else if(e===i.utils.DOWN){s=Math.max(h[0]-1,n.x),c=h[1]+r-1;for(let i=s;i<s+2;++i)for(let o=c;o>c-r;--o)t[i][o]=a;f[e]=[s,c+1],u=new o([s,h[1]],e,r,2)}else if(e===i.utils.LEFT){s=h[0]-r+1,c=Math.max(h[1]-1,n.y);for(let i=s;i<s+r;++i)for(let o=c;o<c+2;++o)t[i][o]=a;f[e]=[s-1,c],u=new o([h[0],c],e,r,2)}else{s=h[0]+r-1,c=Math.max(h[1]-1,n.y);for(let i=s;i>s-r;--i)for(let o=c;o<c+2;++o)t[i][o]=a;f[e]=[s+1,c],u=new o([h[0],c],e,r,2)}return u.doors=f,u.width=2,u}(t,n,l,e,r):f(t,n,l,e,r)}const c=i.utils.DIRS;var u;function d(t,o,e,r={}){const n=e.hall?e.hall.doors:e.doors;for(let l=0;l<u.length;l++){const h=Math.floor(u[l]/t.height),a=u[l]%t.height;if(0!=t.get(h,a))continue;const f=i.grid.directionOfDoorSite(t,h,a,1);if(f!=i.utils.NO_DIRECTION){const l=(f+2)%4,s=h-n[l][0],c=a-n[l][1];if(-1!=n[l][0]&&g(t,o,s,c))return i.grid.offsetZip(t,o,s,c,((i,o,e,n)=>{t[e][n]=r.tile||1})),(r.door||!1!==r.placeDoor)&&(t[h][a]=r.door||2),e.translate(s,c),!0}}return!1}function g(t,i,o,e){let r,n,l,h,a,f;for(r=0;r<i.width;r++)for(n=0;n<i.height;n++)if(i[r][n])for(l=r+o,h=n+e,a=l-1;a<=l+1;a++)for(f=h-1;f<=h+1;f++)if(!t.hasXY(a,f)||t.isBoundaryXY(a,f)||0!==t.get(a,f))return!1;return!0}function M(t,o,e,r,n={}){const l=i.random.sequence(o.length);for(let i=0;i<l.length;i++){const h=o[l[i]];if(!h)continue;if(m(t,h[0],h[1],e,r,n))return!0}return!1}function m(t,o,e,r,n,l={}){const h=n.hall?n.hall.doors:n.doors,a=i.random.sequence(4);for(let f of a){const a=h[(f+2)%4];if(a&&(-1!=a[0]&&g(t,r,o-a[0],e-a[1]))){const h=o-a[0],f=e-a[1];return i.grid.offsetZip(t,r,h,f,((i,o,e,r)=>{t[e][r]=l.tile||1})),(l.door||!1!==l.placeDoor)&&(t[o][e]=l.door||2),n.translate(h,f),!0}}return!1}function w(t){let o,e,r,n,l,h,a;const f=i.grid.alloc(t.width,t.height);for(f.copy(t),o=0;o<f.width;o++)for(e=0;e<f.height;e++)if(!f[o][e]&&(h=i.grid.directionOfDoorSite(f,o,e,1),h!=i.utils.NO_DIRECTION)){for(n=o+c[h][0],l=e+c[h][1],a=!1,r=0;r<10&&f.hasXY(n,l)&&!a;r++)f[n][l]&&(a=!0),n+=c[h][0],l+=c[h][1];a||(f[o][e]=h+200)}let s=[];for(h=0;h<4;h++){const t=f.randomMatchingLoc(h+200)||[-1,-1];s[h]=[t[0],t[1]]}return i.grid.free(f),s}function R(t,i,o){const e=t.get(i,o);return 1===e||2===e||5===e}function O(t,i,o){const e=t.get(i,o);return 0===e||3===e}function y(t){let o,e,r,n,l,h;do{for(h=!1,o=0;o<t.width-1;o++)for(e=0;e<t.height-1;e++)for(r=0;r<=1;r++)R(t,o+r,e)&&!R(t,o+(1-r),e)&&O(t,o+(1-r),e)&&!R(t,o+r,e+1)&&O(t,o+r,e+1)&&R(t,o+(1-r),e+1)&&(i.random.chance(50)?(n=o+(1-r),l=e):(n=o+r,l=e+1),h=!0,t[n][l]=1)}while(1==h)}function x(t){t.forEach(((i,o,e)=>{t.isBoundaryXY(o,e)||2==i&&(1!=t.get(o+1,e)&&1!=t.get(o-1,e)||1!=t.get(o,e+1)&&1!=t.get(o,e-1)?(1!==t.get(o+1,e)?1:0)+(1!==t.get(o-1,e)?1:0)+(1!==t.get(o,e+1)?1:0)+(1!==t.get(o,e-1)?1:0)>=3&&(t[o][e]=1):t[o][e]=1)}))}function p(t){t.forEach(((i,o,e)=>{0==i&&(t[o][e]=3)}))}var v={__proto__:null,room:l,Room:e,Hall:o,start:function(t){u=i.random.sequence(t.width*t.height),t.fill(0)},finish:function(t){y(t),p(t),x(t)},dig:function(t,o={}){"string"==typeof o&&(o={digger:o});const e=o.digger||o.id||"SMALL",n=r[e];n||i.utils.ERROR("Failed to find digger: "+e);let l=o.locs||o.loc||null;if(l&&Array.isArray(l))l&&l.length&&2==l.length&&"number"==typeof l[0]?l=[l]:0==l.length&&(l=null);else if(l=null,0===t.count(1)){l=[[Math.floor(t.width/2),t.height-2]]}const h=Object.assign({},n,o),a=i.grid.alloc(t.width,t.height),f=h.hallChance||h.hallway||0,c=i.random.chance(f);let u,g=!1,m=h.tries||10;for(;--m>=0&&!g;)a.fill(0),u=n.fn(h,a),u.doors=w(a),c&&(u.hall=s(a,u,h)),g=l?M(t,l,a,u,h):d(t,a,u,h);return i.grid.free(a),u&&g?u:null},attachRoom:d,roomFitsAt:g,forceRoomAtMapLoc:function(t,o,e,r,n={}){for(let l=0;l<u.length;l++){const h=Math.floor(u[l]/t.height),a=u[l]%t.height;if(e[h][a])continue;if(i.grid.directionOfDoorSite(e,h,a,1)!=i.utils.NO_DIRECTION){const l=o[0]-h,f=o[1]-a;if(g(t,e,l,f))return i.grid.offsetZip(t,e,l,f,((i,o,e,r)=>{t[e][r]=n.tile||1})),(n.door||!1!==n.placeDoor)&&(t[o[0]][o[1]]=n.door||2),r.translate(l,f),!0}}return!1},chooseRandomDoorSites:w,isPassable:R,isObstruction:O,removeDiagonalOpenings:y,finishDoors:x,finishWalls:p,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,LAKE:4,BRIDGE:5};t.dig=v,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-dig.min.js.map

!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,i){"use strict";class o{constructor(t,o,e,r=1){this.width=1,this.doors=[],this.x=t[0],this.y=t[1];const n=i.utils.DIRS[o];this.length=e,this.width=r,o===i.utils.UP||o===i.utils.DOWN?(this.x2=this.x+(r-1),this.y2=this.y+(e-1)*n[1]):(this.x2=this.x+(e-1)*n[0],this.y2=this.y+(r-1)),this.dir=o}translate(t,i){this.x+=t,this.y+=i,this.x2+=t,this.y2+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))}))}}class e{constructor(t,i,o,e,r){this.doors=[],this.hall=null,this.digger=t,this.x=i,this.y=o,this.width=e,this.height=r}get cx(){return this.x+Math.floor(this.width/2)}get cy(){return this.y+Math.floor(this.height/2)}translate(t,i){this.x+=t,this.y+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))})),this.hall&&this.hall.translate(t,i)}}var r={};function n(t,o){return t=t||{},o=o||{},Object.entries(o).forEach((([o,e])=>{let r=t[o];if("tile"===o)return void(void 0===r&&(t[o]=e));if(!0===e){if(!r)return void i.utils.WARN("Missing required config for digger: "+o)}else if("number"==typeof e)r=r||e;else{if(!Array.isArray(e))return void i.utils.WARN("Unexpected digger configuration parameter: ",o,""+e);r=r||e}const n=i.range.make(r);n||i.utils.ERROR("Invalid configuration for digger: "+o),t[o]=n})),t}var h={__proto__:null,Hall:o,Room:e,rooms:r,install:function(t,i,o){return(o=i(o||{})).fn=i,o.id=t,r[t]=o,o},checkConfig:n,cavern:function(t,o){if(t=n(t,{width:12,height:8}),!o)return t;let r,h,l;const a=t.width.value(),f=t.height.value(),s=t.tile||1;l=i.grid.alloc(o.width,o.height,0);const c=Math.floor(.5*a),u=a,d=Math.floor(.5*f),g=f;o.fill(0);const M=l.fillBlob(5,c,d,u,g,55,"ffffffttt","ffffttttt");return r=Math.floor((o.width-M.width)/2),h=Math.floor((o.height-M.height)/2),i.grid.offsetZip(o,l,r-M.x,h-M.y,s),i.grid.free(l),new e(t.id,r,h,M.width,M.height)},choiceRoom:function(t,o){let e;if(t=t||{},Array.isArray(t.choices))e=i.random.item.bind(i.random,t.choices);else{if("object"!=typeof t.choices)return i.utils.ERROR("Expected choices to be either array of choices or map { digger: weight }");e=i.random.weighted.bind(i.random,t.choices)}if(!o)return t;let n=e();const h=r[n];if(!h)return i.utils.ERROR("Missing digger choice: "+n);let l=h;return t.opts&&(l=Object.assign({},h,t.opts)),h.fn(l,o)},entrance:function(t,i){if(t=n(t,{width:20,height:10}),!i)return t;const o=t.width.value(),r=t.height.value(),h=t.tile||1,l=Math.floor(.4*o),a=r,f=o,s=Math.floor(.5*r),c=Math.floor(i.width/2-l/2-1),u=i.height-a-2,d=Math.floor(i.width/2-f/2-1),g=i.height-s-2;return i.fill(0),i.fillRect(c,u,l,a,h),i.fillRect(d,g,f,s,h),new e(t.id,Math.min(c,d),Math.min(u,g),Math.max(l,f),Math.max(a,s))},cross:function(t,o){if(t=n(t,{width:12,height:20}),!o)return t;const r=t.width.value(),h=t.height.value(),l=t.tile||1,a=r,f=Math.max(3,Math.floor(r*i.random.range(25,75)/100)),s=Math.max(3,Math.floor(h*i.random.range(25,75)/100)),c=h,u=Math.floor((o.width-a)/2),d=u+i.random.range(2,Math.max(2,a-f-2)),g=Math.floor((o.height-c)/2),M=g+i.random.range(2,Math.max(2,c-s-2));return o.fill(0),o.fillRect(u,M,a,s,l),o.fillRect(d,g,f,c,l),new e(t.id,u,g,Math.max(a,f),Math.max(s,c))},symmetricalCross:function(t,o){if(t=n(t,{width:7,height:7}),!o)return t;const r=t.width.value(),h=t.height.value(),l=t.tile||1;let a=Math.max(3,Math.floor(r*i.random.range(25,50)/100));h%2==0&&a>2&&(a-=1);let f=Math.max(3,Math.floor(h*i.random.range(25,50)/100));o.fill(0);const s=Math.floor((o.width-r)/2),c=Math.floor((o.height-f)/2);o.fillRect(s,c,r,f,l);const u=Math.floor((o.width-a)/2),d=Math.floor((o.height-h)/2);return o.fillRect(u,d,a,h,l),new e(t.id,Math.min(s,u),Math.min(c,d),Math.max(r,a),Math.max(h,f))},rectangular:function(t,i){if(t=n(t,{width:[3,6],height:[3,6]}),!i)return t;const o=t.width.value(),r=t.height.value(),h=t.tile||1;i.fill(0);const l=Math.floor((i.width-o)/2),a=Math.floor((i.height-r)/2);return i.fillRect(l,a,o,r,h),new e(t.id,l,a,o,r)},circular:function(t,i){if(t=n(t,{radius:[3,4]}),!i)return t;const o=t.radius.value(),r=t.tile||1;i.fill(0);const h=Math.floor(i.width/2),l=Math.floor(i.height/2);return o>1&&i.fillCircle(h,l,o,r),new e(t.id,h,l,2*o,2*o)},brogueDonut:function(t,o){if(t=n(t,{radius:[5,10],ringMinWidth:3,holeMinSize:3,holeChance:50}),!o)return t;const r=t.radius.value(),h=t.ringMinWidth.value(),l=t.holeMinSize.value(),a=t.tile||1;o.fill(0);const f=Math.floor(o.width/2),s=Math.floor(o.height/2);return o.fillCircle(f,s,r,a),r>h+l&&i.random.chance(t.holeChance.value())&&o.fillCircle(f,s,i.random.range(l,r-l),0),new e(t.id,f-r,s-r,2*r+1,2*r+1)},chunkyRoom:function(t,o){if(t=n(t,{count:[2,12],width:[5,20],height:[5,20]}),!o)return t;let r,h,l,a,f,s,c,u=t.count.value();const d=t.width.value(),g=t.height.value(),M=t.tile||1;for(a=Math.floor(o.width/2)-Math.floor(d/2),f=Math.floor(o.width/2)+Math.floor(d/2),s=Math.floor(o.height/2)-Math.floor(g/2),c=Math.floor(o.height/2)+Math.floor(g/2),o.fill(0),o.fillCircle(Math.floor(o.width/2),Math.floor(o.height/2),2,M),r=0;r<u;)if(h=i.random.range(a,f),l=i.random.range(s,c),o[h][l]){if(h-2<a)continue;if(h+2>f)continue;if(l-2<s)continue;if(l+2>c)continue;o.fillCircle(h,l,2,M),r++}const m=o.valueBounds(M);return new e(t.id,m.x,m.y,m.width,m.height)}};const l=i.utils.DIRS;function a(t,o){return t==i.utils.UP||t==i.utils.DOWN?i.range.make(o.yLength||o.length||[2,9]):i.range.make(o.xLength||o.length||[9,15])}function f(t,e,r){const n=function(t,o,e){const r=o.doors;let n=e.dir||i.utils.NO_DIRECTION;if(n==i.utils.NO_DIRECTION){const o=i.random.sequence(4);for(let h=0;h<4;h++){n=o[h];const f=a(n,e).hi,s=r[n];if(s&&-1!=s[0]&&-1!=s[1]){const i=s[0]+Math.floor(l[n][0]*f),o=s[1]+Math.floor(l[n][1]*f);if(t.hasXY(i,o))break}n=i.utils.NO_DIRECTION}}return n}(t,e,r=r||{});if(n===i.utils.NO_DIRECTION)return null;console.log("dir",n);const h=a(n,r).value();console.log("length",h);const f=e.doors[n],s=l[n];let c=f[0],u=f[1];const d=r.tile||1;for(let i=0;i<h;i++)t[c][u]=d,c+=s[0],u+=s[1];c-=s[0],u-=s[1];const g=new o(f,n,h);return g.doors=function(t,o,e,r,n){let h,a;const f=i.utils.firstOpt("obliqueChance",n,15),s=i.random.chance(f),c=[];for(let i=0;i<4;i++)h=o+l[i][0],a=e+l[i][1],i!=r&&!s||!t.hasXY(h,a)||t[h][a]||(c[i]=[h,a]);return c}(t,c,u,n,r),g}const s=i.utils.DIRS;var c;function u(t,o,e,r={}){const n=e.hall?e.hall.doors:e.doors;for(let h=0;h<c.length;h++){const l=Math.floor(c[h]/t.height),a=c[h]%t.height;if(0!=t.get(l,a))continue;const f=i.grid.directionOfDoorSite(t,l,a,1);if(f!=i.utils.NO_DIRECTION){const h=(f+2)%4,s=l-n[h][0],c=a-n[h][1];if(-1!=n[h][0]&&d(t,o,s,c))return i.grid.offsetZip(t,o,s,c,((i,o,e,n)=>{t[e][n]=r.tile||1})),(r.door||!1!==r.placeDoor)&&(t[l][a]=r.door||2),e.translate(s,c),!0}}return!1}function d(t,i,o,e){let r,n,h,l,a,f;for(r=0;r<i.width;r++)for(n=0;n<i.height;n++)if(i[r][n])for(h=r+o,l=n+e,a=h-1;a<=h+1;a++)for(f=l-1;f<=l+1;f++)if(!t.hasXY(a,f)||t.isBoundaryXY(a,f)||0!==t.get(a,f))return!1;return!0}function g(t,o,e,r,n={}){const h=i.random.sequence(o.length);for(let i=0;i<h.length;i++){const l=o[h[i]];if(!l)continue;if(M(t,l[0],l[1],e,r,n))return!0}return!1}function M(t,o,e,r,n,h={}){const l=n.hall?n.hall.doors:n.doors,a=i.random.sequence(4);for(let f of a){const a=l[(f+2)%4];if(a&&(-1!=a[0]&&d(t,r,o-a[0],e-a[1]))){const l=o-a[0],f=e-a[1];return i.grid.offsetZip(t,r,l,f,((i,o,e,r)=>{t[e][r]=h.tile||1})),(h.door||!1!==h.placeDoor)&&(t[o][e]=h.door||2),n.translate(l,f),!0}}return!1}function m(t){let o,e,r,n,h,l,a;const f=i.grid.alloc(t.width,t.height);for(f.copy(t),o=0;o<f.width;o++)for(e=0;e<f.height;e++)if(!f[o][e]&&(l=i.grid.directionOfDoorSite(f,o,e,1),l!=i.utils.NO_DIRECTION)){for(n=o+s[l][0],h=e+s[l][1],a=!1,r=0;r<10&&f.hasXY(n,h)&&!a;r++)f[n][h]&&(a=!0),n+=s[l][0],h+=s[l][1];a||(f[o][e]=l+200)}let c=[];for(l=0;l<4;l++){const t=f.randomMatchingLoc(l+200)||[-1,-1];c[l]=[t[0],t[1]]}return i.grid.free(f),c}function w(t,i,o){const e=t.get(i,o);return 1===e||2===e||5===e}function R(t,i,o){const e=t.get(i,o);return 0===e||3===e}function y(t){let o,e,r,n,h,l;do{for(l=!1,o=0;o<t.width-1;o++)for(e=0;e<t.height-1;e++)for(r=0;r<=1;r++)w(t,o+r,e)&&!w(t,o+(1-r),e)&&R(t,o+(1-r),e)&&!w(t,o+r,e+1)&&R(t,o+r,e+1)&&w(t,o+(1-r),e+1)&&(i.random.chance(50)?(n=o+(1-r),h=e):(n=o+r,h=e+1),l=!0,t[n][h]=1)}while(1==l)}function O(t){t.forEach(((i,o,e)=>{t.isBoundaryXY(o,e)||2==i&&(1!=t.get(o+1,e)&&1!=t.get(o-1,e)||1!=t.get(o,e+1)&&1!=t.get(o,e-1)?(1!==t.get(o+1,e)?1:0)+(1!==t.get(o-1,e)?1:0)+(1!==t.get(o,e+1)?1:0)+(1!==t.get(o,e-1)?1:0)>=3&&(t[o][e]=1):t[o][e]=1)}))}function v(t){t.forEach(((i,o,e)=>{0==i&&(t[o][e]=3)}))}var p={__proto__:null,room:h,Room:e,Hall:o,start:function(t){c=i.random.sequence(t.width*t.height),t.fill(0)},finish:function(t){y(t),v(t),O(t)},dig:function(t,o={}){"string"==typeof o&&(o={digger:o});const e=o.digger||o.id||"SMALL",n=r[e];n||i.utils.ERROR("Failed to find digger: "+e);let h=o.locs||o.loc||null;if(h&&Array.isArray(h))h&&h.length&&2==h.length&&"number"==typeof h[0]?h=[h]:0==h.length&&(h=null);else if(h=null,0===t.count(1)){h=[[Math.floor(t.width/2),t.height-2]]}const l=Object.assign({},n,o),a=i.grid.alloc(t.width,t.height),s=l.hallChance||l.hallway||0,c=i.random.chance(s);let d,M=!1,w=l.tries||10;for(;--w>=0&&!M;)a.fill(0),d=n.fn(l,a),d.doors=m(a),c&&(d.hall=f(a,d,l)),M=h?g(t,h,a,d,l):u(t,a,d,l);return i.grid.free(a),d&&M?d:null},attachRoom:u,roomFitsAt:d,forceRoomAtMapLoc:function(t,o,e,r,n={}){for(let h=0;h<c.length;h++){const l=Math.floor(c[h]/t.height),a=c[h]%t.height;if(e[l][a])continue;if(i.grid.directionOfDoorSite(e,l,a,1)!=i.utils.NO_DIRECTION){const h=o[0]-l,f=o[1]-a;if(d(t,e,h,f))return i.grid.offsetZip(t,e,h,f,((i,o,e,r)=>{t[e][r]=n.tile||1})),(n.door||!1!==n.placeDoor)&&(t[o[0]][o[1]]=n.door||2),r.translate(h,f),!0}}return!1},chooseRandomDoorSites:m,isPassable:w,isObstruction:R,removeDiagonalOpenings:y,finishDoors:O,finishWalls:v,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,LAKE:4,BRIDGE:5};t.dig=p,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-dig.min.js.map

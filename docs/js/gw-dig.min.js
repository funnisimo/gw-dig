!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,i){"use strict";const o={0:"NULL",1:"FLOOR",2:"DOOR",3:"WALL",8:"IMPREGNABLE",4:"LAKE",5:"SHALLOW",6:"BRIDGE",7:"UP_STAIRS",17:"DOWN_STAIRS"},e=[];function r(t){e.length=t;for(let i=0;i<t;++i)e[i]=i;i.random.shuffle(e)}function n(t,o){t.forEach(((e,r,n)=>{o[r][n]=l(t,r,n)?1:i.path.OBSTRUCTION}))}function l(t,i,o){return s(t,i,o)||a(t,i,o)||f(t,i,o)||d(t,i,o)||m(t,i,o)}function h(t,i,o){return 0===t.get(i,o)}function s(t,i,o){return 1==t.get(i,o)}function a(t,i,o){return 2===t.get(i,o)}function f(t,i,o){return 6===t.get(i,o)}function u(t,i,o){const e=t.get(i,o);return 3===e||8===e}function c(t,i,o){return h(t,i,o)||u(t,i,o)}function d(t,i,o){const e=t.get(i,o);return 7===e||17===e}function g(t,i,o){return 4===t.get(i,o)}function m(t,i,o){return 5===t.get(i,o)}function w(t,i,o){return g(t,i,o)||m(t,i,o)}function M(t,i,o,e){t.hasXY(i,o)&&(t[i][o]=e)}var p={__proto__:null,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,DEEP:4,SHALLOW:5,BRIDGE:6,UP_STAIRS:7,DOWN_STAIRS:17,IMPREGNABLE:8,TILEMAP:o,SEQ:e,initSeqence:r,fillCostGrid:n,isPassable:l,isNothing:h,isFloor:s,isDoor:a,isBridge:f,isWall:u,isObstruction:c,isStairs:d,isDeep:g,isShallow:m,isAnyWater:w,setGrid:M};const R=i.utils.DIRS;function O(t,o,r,n){const l=r.hall?r.hall.doors:r.doors;for(let h=0;h<e.length;h++){const s=Math.floor(e[h]/t.height),a=e[h]%t.height;if(0!=t.get(s,a))continue;const f=_(t,s,a);if(f!=i.utils.NO_DIRECTION){const e=(f+2)%4,h=l[e];if(!h)continue;const u=s-h[0],c=a-h[1];if(-1!=h[0]&&D(t,o,u,c))return i.grid.offsetZip(t,o,u,c,((i,o,e,r)=>{t[e][r]=n.room.tile||1})),y(t,r,n,s,a,e),r.translate(u,c),!0}}return!1}function y(t,o,e,r,n,l){if(0===e.door)return;const h=e.door||2;if(t[r][n]=h,o.hall&&o.hall.width>1&&o.hall.dir===l)if(l===i.utils.UP||l===i.utils.DOWN){let i=!0,o=1;for(;i;)i=!1,0===t.get(r-o,n)&&t.get(r-o,n-1)&&t.get(r-o,n+1)&&(t[r-o][n]=h,i=!0),0===t.get(r+o,n)&&t.get(r+o,n-1)&&t.get(r+o,n+1)&&(t[r+o][n]=h,i=!0),++o}else{let i=!0,o=1;for(;i;)i=!1,0===t.get(r,n-o)&&t.get(r-1,n-o)&&t.get(r+1,n-o)&&(t[r][n-o]=e.door,i=!0),0===t.get(r,n+o)&&t.get(r-1,n+o)&&t.get(r+1,n+o)&&(t[r][n+o]=e.door,i=!0),++o}}function D(t,i,o,e){let r,n,l,h,s,a;for(r=0;r<i.width;r++)for(n=0;n<i.height;n++)if(i[r][n])for(l=r+o,h=n+e,s=l-1;s<=l+1;s++)for(a=h-1;a<=h+1;a++)if(!t.hasXY(s,a)||t.isBoundaryXY(s,a)||0!==t.get(s,a))return!1;return!0}function _(t,o,e){let r,n,l,h,a,f;for(n=i.utils.NO_DIRECTION,r=0;r<4;r++)if(l=o+R[r][0],h=e+R[r][1],a=o-R[r][0],f=e-R[r][1],t.hasXY(a,f)&&t.hasXY(l,h)&&s(t,a,f)){if(n!=i.utils.NO_DIRECTION)return i.utils.NO_DIRECTION;n=r}return n}function E(t,o,e,r,n){const l=i.random.sequence(o.length);for(let i=0;i<l.length;i++){const h=o[l[i]];if(!h)continue;if(L(t,h[0],h[1],e,r,n))return!0}return!1}function L(t,o,e,r,n,l){const h=n.hall?n.hall.doors:n.doors,s=i.random.sequence(4);for(let a of s){const s=(a+2)%4,f=h[s];if(f&&(-1!=f[0]&&D(t,r,o-f[0],e-f[1]))){const h=o-f[0],a=e-f[1];return i.grid.offsetZip(t,r,h,a,((i,o,e,r)=>{t[e][r]=l.room.tile||1})),y(t,n,l,o,e,s),n.translate(h,a),!0}}return!1}function I(t,o){let e,r,n,l,h,s,a;const f=[[],[],[],[]],u=t.height,c=t.width;for(e=0;e<c;e++)for(r=0;r<u;r++)if(!t[e][r]&&(s=_(t,e,r),s!=i.utils.NO_DIRECTION)){for(l=e+R[s][0],h=r+R[s][1],a=!1,n=0;n<10&&t.hasXY(l,h)&&!a;n++)t[l][h]&&(a=!0),l+=R[s][0],h+=R[s][1];a||f[s].push([e,r])}let d=[];for(s=0;s<4;s++){const t=i.random.item(f[s])||[-1,-1];d[s]=[t[0],t[1]]}return d}var N={__proto__:null,attachRoom:O,attachDoor:y,roomFitsAt:D,directionOfDoorSite:_,forceRoomAtMapLoc:function(t,o,r,n,l){for(let h=0;h<e.length;h++){const s=Math.floor(e[h]/t.height),a=e[h]%t.height;if(r[s][a])continue;if(_(r,s,a)!=i.utils.NO_DIRECTION){const e=o[0]-s,h=o[1]-a;if(D(t,r,e,h)){if(i.grid.offsetZip(t,r,e,h,((i,o,e,r)=>{t[e][r]=l.room.tile||1})),!1!==l.room.door){const i=!0!==l.room.door&&l.room.door?l.room.door:2;t[o[0]][o[1]]=i}return n.translate(e,h),!0}}}return!1},attachRoomAtMapDoor:E,chooseRandomDoorSites:I};class x{constructor(t,o,e,r=1){this.width=1,this.doors=[],this.x=t[0],this.y=t[1];const n=i.utils.DIRS[o];this.length=e,this.width=r,o===i.utils.UP||o===i.utils.DOWN?(this.x2=this.x+(r-1),this.y2=this.y+(e-1)*n[1]):(this.x2=this.x+(e-1)*n[0],this.y2=this.y+(r-1)),this.dir=o}translate(t,i){this.x+=t,this.y+=i,this.x2+=t,this.y2+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))}))}}class A{constructor(t,i,o,e,r){this.doors=[],this.hall=null,this.digger=t,this.x=i,this.y=o,this.width=e,this.height=r}get cx(){return this.x+Math.floor(this.width/2)}get cy(){return this.y+Math.floor(this.height/2)}translate(t,i){this.x+=t,this.y+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))})),this.hall&&this.hall.translate(t,i)}}const S=i.utils.DIRS;var T={};function b(t,i,o={}){const e=i(o||{});return e.fn=i,e.id=t,T[t]=e,e}function v(t={}){return i.utils.clamp(function(t){if(!t)return 1;if("number"==typeof t)return t;if(void 0===t.width)return 1;let o=t.width;if("number"==typeof o)return o;o=Array.isArray(o)?i.random.weighted(o)+1:"string"==typeof o?i.range.make(o).value():Number.parseInt(i.random.weighted(o));return o}(t),1,3)}function C(t,o){return o.length||(o.length=[]),Array.isArray(o.length)?t==i.utils.UP||t==i.utils.DOWN?i.range.make(o.length[1]||[2,9]):i.range.make(o.length[0]||[9,15]):i.range.make(o.length)}function W(t,o,e){const r=o.doors;let n=e.dir||i.utils.NO_DIRECTION;if(n==i.utils.NO_DIRECTION){const o=i.random.sequence(4);for(let l=0;l<4;l++){n=o[l];const h=C(n,e).hi,s=r[n];if(s&&-1!=s[0]&&-1!=s[1]){const i=s[0]+Math.floor(S[n][0]*h),o=s[1]+Math.floor(S[n][1]*h);if(t.hasXY(i,o))break}n=i.utils.NO_DIRECTION}}return n}function X(t,o,e,r,n){let l,h;const s=i.utils.firstOpt("obliqueChance",n,15),a=i.random.chance(s),f=[];for(let i=0;i<4;i++)l=o+S[i][0],h=e+S[i][1],i!=r&&!a||!t.hasXY(l,h)||t[l][h]||(f[i]=[l,h]);return f}function Y(t,o,e){if((t=t||{}).width=1,!o)return t;const r=W(o,e,t);if(r===i.utils.NO_DIRECTION)return null;const n=C(r,t).value(),l=e.doors[r],h=S[r];let s=l[0],a=l[1];const f=t.tile||1;for(let t=0;t<n;t++)o[s][a]=f,s+=h[0],a+=h[1];s-=h[0],a-=h[1];const u=new x(l,r,n);return u.doors=X(o,s,a,r,t),u}b("DEFAULT",Y,{chance:15});var F={__proto__:null,halls:T,install:b,pickWidth:v,pickLengthRange:C,pickHallDirection:W,pickHallExits:X,digWide:function(t,o,e){if((t=t||{}).width||(t.width=2),!o)return t;const r=W(o,e,t);if(r===i.utils.NO_DIRECTION)return null;const n=C(r,t).value(),l=v(t)||2,h=e.doors[r],s=t.tile||1,a=[];let f,u,c;if(r===i.utils.UP){f=i.utils.clamp(h[0],e.x,e.x+e.width-l),u=h[1]-n+1;for(let t=f;t<f+l;++t)for(let i=u;i<u+n;++i)o[t][i]=s;a[r]=[f,u-1],c=new x([f,h[1]],r,n,2)}else if(r===i.utils.DOWN){f=i.utils.clamp(h[0],e.x,e.x+e.width-l),u=h[1]+n-1;for(let t=f;t<f+l;++t)for(let i=u;i>u-n;--i)o[t][i]=s;a[r]=[f,u+1],c=new x([f,h[1]],r,n,2)}else if(r===i.utils.LEFT){f=h[0]-n+1,u=i.utils.clamp(h[1],e.y,e.y+e.height-l);for(let t=f;t<f+n;++t)for(let i=u;i<u+l;++i)o[t][i]=s;a[r]=[f-1,u],c=new x([h[0],u],r,n,2)}else{f=h[0]+n-1,u=i.utils.clamp(h[1],e.y,e.y+e.height-l);for(let t=f;t>f-n;--t)for(let i=u;i<u+l;++i)o[t][i]=s;a[r]=[f+1,u],c=new x([h[0],u],r,n,l)}return c.doors=a,c.width=l,c},dig:Y},B={};function k(t,i,o){const e=i(o||{});return e.fn=i,e.id=t,B[t]=e,e}function P(t,o){return t=t||{},o=o||{},Object.entries(o).forEach((([o,e])=>{let r=t[o];if("tile"===o)return void(void 0===r&&(t[o]=e));if(!0===e){if(!r)return i.utils.ERROR("Missing required config for digger: "+o)}else r=("number"==typeof e||Array.isArray(e),r||e);const n=i.range.make(r);t[o]=n})),t}function U(t,i){if(t=P(t,{width:[3,6],height:[3,6]}),!i)return t;const o=t.width.value(),e=t.height.value(),r=t.tile||1;i.fill(0);const n=Math.floor((i.width-o)/2),l=Math.floor((i.height-e)/2);return i.fillRect(n,l,o,e,r),new A(t.id,n,l,o,e)}k("DEFAULT",U);var G={__proto__:null,rooms:B,install:k,checkConfig:P,cavern:function(t,o){if(t=P(t,{width:12,height:8}),!o)return t;let e,r,n;const l=t.width.value(),h=t.height.value(),s=t.tile||1;n=i.grid.alloc(o.width,o.height,0);const a=Math.floor(.5*l),f=l,u=Math.floor(.5*h),c=h;o.fill(0);const d=n.fillBlob(5,a,u,f,c,55,"ffffffttt","ffffttttt");return e=Math.floor((o.width-d.width)/2),r=Math.floor((o.height-d.height)/2),i.grid.offsetZip(o,n,e-d.x,r-d.y,s),i.grid.free(n),new A(t.id,e,r,d.width,d.height)},choiceRoom:function(t,o){let e;if(t=t||{},Array.isArray(t.choices)?e=i.random.item.bind(i.random,t.choices):"object"==typeof t.choices?e=i.random.weighted.bind(i.random,t.choices):i.utils.ERROR("Expected choices to be either array of room ids or map - ex: { ROOM_ID: weight }"),!o)return t;let r=e();const n=B[r];n||i.utils.ERROR("Missing digger choice: "+r);let l=n;return t.opts&&(l=Object.assign({},n,t.opts)),n.fn(l,o)},entrance:function(t,i){if(t=P(t,{width:20,height:10}),!i)return t;const o=t.width.value(),e=t.height.value(),r=t.tile||1,n=Math.floor(.4*o),l=e,h=o,s=Math.floor(.5*e),a=Math.floor(i.width/2-n/2-1),f=i.height-l-2,u=Math.floor(i.width/2-h/2-1),c=i.height-s-2;return i.fill(0),i.fillRect(a,f,n,l,r),i.fillRect(u,c,h,s,r),new A(t.id,Math.min(a,u),Math.min(f,c),Math.max(n,h),Math.max(l,s))},cross:function(t,o){if(t=P(t,{width:12,height:20}),!o)return t;const e=t.width.value(),r=t.height.value(),n=t.tile||1,l=e,h=Math.max(3,Math.floor(e*i.random.range(25,75)/100)),s=Math.max(3,Math.floor(r*i.random.range(25,75)/100)),a=r,f=Math.floor((o.width-l)/2),u=f+i.random.range(2,Math.max(2,l-h-2)),c=Math.floor((o.height-a)/2),d=c+i.random.range(2,Math.max(2,a-s-2));return o.fill(0),o.fillRect(f,d,l,s,n),o.fillRect(u,c,h,a,n),new A(t.id,f,c,Math.max(l,h),Math.max(s,a))},symmetricalCross:function(t,o){if(t=P(t,{width:7,height:7}),!o)return t;const e=t.width.value(),r=t.height.value(),n=t.tile||1;let l=Math.max(3,Math.floor(e*i.random.range(25,50)/100)),h=Math.max(3,Math.floor(r*i.random.range(25,50)/100));o.fill(0);const s=Math.floor((o.width-e)/2),a=Math.floor((o.height-h)/2);o.fillRect(s,a,e,h,n);const f=Math.floor((o.width-l)/2),u=Math.floor((o.height-r)/2);return o.fillRect(f,u,l,r,n),new A(t.id,Math.min(s,f),Math.min(a,u),Math.max(e,l),Math.max(r,h))},rectangular:U,circular:function(t,i){if(t=P(t,{radius:[3,4]}),!i)return t;const o=t.radius.value(),e=t.tile||1;i.fill(0);const r=Math.floor(i.width/2),n=Math.floor(i.height/2);return o>1&&i.fillCircle(r,n,o,e),new A(t.id,r-o,n-o,2*o+1,2*o+1)},brogueDonut:function(t,o){if(t=P(t,{radius:[5,10],ringMinWidth:3,holeMinSize:3,holeChance:50}),!o)return t;const e=t.radius.value(),r=t.ringMinWidth.value(),n=t.holeMinSize.value(),l=t.tile||1;o.fill(0);const h=Math.floor(o.width/2),s=Math.floor(o.height/2);return o.fillCircle(h,s,e,l),e>r+n&&i.random.chance(t.holeChance.value())&&o.fillCircle(h,s,i.random.range(n,e-n),0),new A(t.id,h-e,s-e,2*e+1,2*e+1)},chunkyRoom:function(t,o){if(t=P(t,{count:[2,12],width:[5,20],height:[5,20]}),!o)return t;let e,r,n,l,h,s,a,f=t.count.value();const u=t.width.value(),c=t.height.value(),d=t.tile||1;for(l=Math.floor(o.width/2)-Math.floor(u/2),h=Math.floor(o.width/2)+Math.floor(u/2),s=Math.floor(o.height/2)-Math.floor(c/2),a=Math.floor(o.height/2)+Math.floor(c/2),o.fill(0),o.fillCircle(Math.floor(o.width/2),Math.floor(o.height/2),2,d),e=0;e<f;)if(r=i.random.range(l,h),n=i.random.range(s,a),o[r][n]){if(r-2<l)continue;if(r+2>h)continue;if(n-2<s)continue;if(n+2>a)continue;o.fillCircle(r,n,2,d),e++}const g=o.valueBounds(d);return new A(t.id,g.x,g.y,g.width,g.height)}};class q{constructor(t,i,o,e){this.width=t,this.height=i,this.disruptsFn=o,this.passableFn=e}create(t,o={}){let e,r,n,l,h,s,a,f,u,c,d,g=0;s=o.height||15,a=o.width||30,f=o.minSize||5,u=o.tries||20,c=o.count||1,d=o.canDisrupt||!1;const m=o.wreath||0,w=o.wreathTile||5,M=o.tile||4,p=i.grid.alloc(this.width,this.height,0);let R=0;for(;R<c&&g<c;){const o=Math.round((a-f)*(c-R)/c)+f,O=Math.round((s-f)*(c-R)/c)+f;p.fill(0);const y=p.fillBlob(5,4,4,o,O,55,"ffffftttt","ffffttttt");let D=!1;for(n=0;n<u&&!D;n++)if(l=i.random.range(1-y.x,p.width-y.width-y.x-2),h=i.random.range(1-y.y,p.height-y.height-y.y-2),d||!this.isDisruptedBy(p,-l,-h)){for(D=!0,e=0;e<y.width;e++)for(r=0;r<y.height;r++)if(p[e+y.x][r+y.y]){const o=e+y.x+l,n=r+y.y+h;t(o,n,M),m&&i.utils.forCircle(o,n,m,((i,o)=>{this.passableFn(i,o)&&t(i,o,w)}))}break}D?++g:++R}return i.grid.free(p),g}isDisruptedBy(t,o=0,e=0){const r=i.grid.alloc(this.width,this.height);let n=!1;i.utils.forRect(this.width,this.height,((i,l)=>{const h=i+o,s=l+e;t.get(h,s)?this.disruptsFn(i,l)&&(n=!0):this.passableFn(i,l)&&(r[i][l]=1)}));let l=!0;for(let t=0;t<r.width&&!n;++t)for(let i=0;i<r.height&&!n;++i)1==r[t][i]&&(l?(r.floodFill(t,i,1,2),l=!1):n=!0);return i.grid.free(r),n}}function H(t,i={}){return new q(t.width,t.height,d.bind(p,t),l.bind(p,t)).create(M.bind(p,t),i)}function j(t,i,o,e){return 6===t.get(i,o)||!!w(t,i,o)&&(!!w(t,i+e[1],o+e[0])&&!!w(t,i-e[1],o-e[0]))}function K(t,o,e){let r,h,s,a,f,u,c;e=e||1;const d=t,g=i.grid.alloc(t.width,t.height),m=i.grid.alloc(t.width,t.height),M=[[1,0],[0,1]];n(t,m);const p=i.random.sequence(t.width*t.height);for(s=0;s<p.length;s++)if(u=Math.floor(p[s]/d.height),c=p[s]%d.height,t.hasXY(u,c)&&t.get(u,c)&&l(t,u,c)&&!w(t,u,c))for(f=0;f<=1;f++){const n=M[f];if(r=u+n[0],h=c+n[1],a=e,t.hasXY(r,h)){if(w(t,r,h))for(a=0;a<e&&(r+=n[0],h+=n[1],w(t,r,h));++a);if(t.get(r,h)&&l(t,r,h)&&a<e&&(i.path.calculateDistances(g,r,h,m,!1),g[u][c]>o&&g[u][c]<i.path.NO_PATH)){for(;u!==r||c!==h;)j(t,u,c,n)?(t[u][c]=6,m[u][c]=1):(t[u][c]=1,m[u][c]=1),u+=n[0],c+=n[1];break}}}i.grid.free(g),i.grid.free(m)}function Z(t,o,e,r){let n=0;if(!c(r,o,e))return!1;for(let t=0;t<4;++t){const l=i.utils.DIRS[t];if(!r.hasXY(o+l[0],e+l[1]))return!1;if(!r.hasXY(o-l[0],e-l[1]))return!1;if(s(r,o+l[0],e+l[1])){if(n+=1,!c(r,o-l[0]+l[1],e-l[1]+l[0]))return!1;if(!c(r,o-l[0]-l[1],e-l[1]-l[0]))return!1}else if(!c(r,o+l[0],e+l[1]))return!1}return 1==n}function z(t,o,e,r){const n=i.random.sequence(4);let l=null;for(let r=0;r<n.length;++r){l=i.utils.DIRS[r];if(s(t,o+l[0],e+l[1])&&c(t,o-l[0],e-l[1]))break;l=null}l||i.utils.ERROR("No stair direction found!"),t.set(o,e,r);const h=i.utils.CLOCK_DIRS.findIndex((t=>t[0]==l[0]&&t[1]==l[1]));for(let r=0;r<i.utils.CLOCK_DIRS.length;++r){const n=r?r-1:7,l=(r+1)%8;if(r==h||n==h||l==h)continue;const s=i.utils.CLOCK_DIRS[r];t.set(o+s[0],e+s[1],3)}return!0}function Q(t,o={}){let e=!1!==o.up,r=!1!==o.down;const n=o.minDistance||Math.floor(Math.max(t.width,t.height)/2),l=o.isValid||Z,h=o.setup||z;let s=Array.isArray(o.up)?o.up:null,a=Array.isArray(o.down)?o.down:null;const f={};if(o.start&&"string"!=typeof o.start){let e=o.start;e=!0===e?t.randomMatchingLoc(l):t.matchingLocNear(i.utils.x(e),i.utils.y(e),l),f.start=e}return s&&a?(s=t.matchingLocNear(i.utils.x(s),i.utils.y(s),l),a=t.matchingLocNear(i.utils.x(a),i.utils.y(a),l)):s&&!a?(s=t.matchingLocNear(i.utils.x(s),i.utils.y(s),l),r&&(a=t.randomMatchingLoc(((o,e,r)=>!(i.utils.distanceBetween(e,r,s[0],s[1])<n)&&l(o,e,r,t))))):a&&!s?(a=t.matchingLocNear(i.utils.x(a),i.utils.y(a),l),e&&(s=t.randomMatchingLoc(((o,e,r)=>!(i.utils.distanceBetween(e,r,a[0],a[1])<n)&&Z(0,e,r,t))))):e?(s=t.randomMatchingLoc(l),r&&(a=t.randomMatchingLoc(((o,e,r)=>!(i.utils.distanceBetween(e,r,s[0],s[1])<n)&&Z(0,e,r,t))))):r&&(a=t.randomMatchingLoc(l)),s&&(f.up=s.slice(),h(t,s[0],s[1],o.upTile||7),"up"===o.start&&(f.start=f.up)),a&&(f.down=a.slice(),h(t,a[0],a[1],o.downTile||17),"down"===o.start&&(f.start=f.down)),s||a?f:null}function V(t){let o,e,r,n,h,s;do{for(s=!1,o=0;o<t.width-1;o++)for(e=0;e<t.height-1;e++)for(r=0;r<=1;r++)l(t,o+r,e)&&!l(t,o+(1-r),e)&&c(t,o+(1-r),e)&&!l(t,o+r,e+1)&&c(t,o+r,e+1)&&l(t,o+(1-r),e+1)&&(i.random.chance(50)?(n=o+(1-r),h=e):(n=o+r,h=e+1),s=!0,t[n][h]=1)}while(1==s)}function J(t){t.forEach(((i,o,e)=>{t.isBoundaryXY(o,e)||2==i&&(1!=t.get(o+1,e)&&1!=t.get(o-1,e)||1!=t.get(o,e+1)&&1!=t.get(o,e-1)?(1!==t.get(o+1,e)?1:0)+(1!==t.get(o-1,e)?1:0)+(1!==t.get(o,e+1)?1:0)+(1!==t.get(o,e-1)?1:0)>=3&&(t[o][e]=1):t[o][e]=1)}))}function $(t,i=3){t.forEach(((o,e,r)=>{0==o&&(t[e][r]=i)}))}var tt={__proto__:null,room:G,hall:F,lake:{__proto__:null,digLakes:H,digBridges:K},stairs:{__proto__:null,isValidStairLoc:Z,setupStairs:z,addStairs:Q},utils:N,start:function(t){r(t.width*t.height),t.fill(0)},finish:function(t){V(t),$(t),J(t)},addRoom:function(t,o){if("string"==typeof(o=o||{room:"DEFAULT",hall:"DEFAULT",tries:10})&&(o={room:o}),o.loc&&(o.locs=[o.loc]),o.room||(o.room="DEFAULT"),"function"==typeof o.room&&(o.room={fn:o.room}),"string"==typeof o.room){const t=o.room;o.room=B[t],o.room||i.utils.ERROR("Failed to find room: "+t)}const e=o.room;let r=null;if(!0===o.hall&&(o.hall="DEFAULT"),!1===o.hall||o.hall||(o.hall="DEFAULT"),"function"==typeof o.hall&&(o.hall={fn:o.hall}),"string"==typeof o.hall){const t=o.hall;if(o.hall=T[t],!o.hall)return i.utils.ERROR("Failed to find hall: "+t),null;r=o.hall}else o.hall&&o.hall.fn&&(r=o.hall);!1===o.door?o.door=0:!0===o.door?o.door=2:"number"==typeof o.door?o.door=i.random.chance(o.door)?2:1:o.door=1;let n=o.locs||null;if(n&&n.doors&&(n=n.doors),n&&Array.isArray(n))n&&n.length&&2==n.length&&"number"==typeof n[0]?n=[n]:0==n.length&&(n=null);else if(n=null,0===t.count(1)){n=[[Math.floor(t.width/2),t.height-2]]}const l=o.room,h=i.grid.alloc(t.width,t.height);let s=!1;if(r){let t=void 0!==r.chance?r.chance:15;s=i.random.chance(t)}let a,f=!1,u=o.tries||10;for(;--u>=0&&!f;)h.fill(0),a=l.fn(e,h),a.doors=I(h),s&&r&&(a.hall=r.fn(r,h,a)),f=n?E(t,n,h,a,o):O(t,h,a,o);return i.grid.free(h),a&&f?a:null},addLoops:function(t,o,r){let h,s,f,u,c,d,g,m,w;o=o||Math.floor(Math.min(t.width,t.height)/2),r=r||1;const M=t,p=i.grid.alloc(t.width,t.height),R=i.grid.alloc(t.width,t.height),O=[[1,0],[0,1]];function y(i,o,e){return!!t.hasXY(i,o)&&(!!t.hasXY(i+e[1],o+e[0])&&(!!t.hasXY(i-e[1],o-e[0])&&(!t.get(i,o)&&(!t.get(i+e[1],o+e[0])&&!t.get(i-e[1],o-e[0])))))}function D(i,o,e){return!!t.hasXY(i,o)&&(!!t.hasXY(i+e[1],o+e[0])&&(!!t.hasXY(i-e[1],o-e[0])&&(!!t.get(i,o)||(!!t.get(i+e[1],o+e[0])||!!t.get(i-e[1],o-e[0])))))}for(n(t,R),c=0;c<e.length;c++){m=Math.floor(e[c]/M.height),w=e[c]%M.height;if(!M[m][w])for(g=0;g<=1;g++){let e=O[g];if(y(m,w,e)){if(d=r,t.hasXY(m+e[0],w+e[1])&&l(t,m+e[0],w+e[1])){if(!t.hasXY(m-e[0],w-e[1])||a(t,m-e[0],w-e[1]))continue}else{if(!t.hasXY(m-e[0],w-e[1])||!l(t,m-e[0],w-e[1]))continue;if(!t.hasXY(m+e[0],w+e[1])||a(t,m+e[0],w+e[1]))continue;e=e.map((t=>-1*t))}for(h=m+e[0],s=w+e[1],f=m,u=w,d=0;d<r&&(f-=e[0],u-=e[1],!D(f,u,e));++d);if(d<r&&(i.path.calculateDistances(p,h,s,R,!1),p[f][u]>o&&p[f][u]<3e4)){for(;f!==h||u!==s;)0==t.get(f,u)&&(t[f][u]=1,R[f][u]=1),f+=e[0],u+=e[1];t[m][w]=2;break}}}}i.grid.free(p),i.grid.free(R)},addLakes:function(t,i){return H(t,i)},addBridges:function(t,i,o){return K(t,i,o)},addStairs:function(t,i={}){return Q(t,i)},removeDiagonalOpenings:V,finishDoors:J,finishWalls:$,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,DEEP:4,SHALLOW:5,BRIDGE:6,UP_STAIRS:7,DOWN_STAIRS:17,IMPREGNABLE:8,TILEMAP:o,SEQ:e,initSeqence:r,fillCostGrid:n,isPassable:l,isNothing:h,isFloor:s,isDoor:a,isBridge:f,isWall:u,isObstruction:c,isStairs:d,isDeep:g,isShallow:m,isAnyWater:w,setGrid:M,Hall:x,Room:A};t.dig=tt,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-dig.min.js.map

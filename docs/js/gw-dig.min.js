!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,i){"use strict";const o={0:"NULL",1:"FLOOR",2:"DOOR",3:"WALL",8:"IMPREGNABLE",4:"LAKE",5:"SHALLOW",6:"BRIDGE",7:"UP_STAIRS",17:"DOWN_STAIRS"},e=[];function r(t){e.length=t;for(let i=0;i<t;++i)e[i]=i;i.random.shuffle(e)}function n(t,o){t.forEach(((e,r,n)=>{o[r][n]=l(t,r,n)?1:i.path.OBSTRUCTION}))}function l(t,i,o){return a(t,i,o)||f(t,i,o)||s(t,i,o)||d(t,i,o)||m(t,i,o)}function h(t,i,o){return 0===t.get(i,o)}function a(t,i,o){return 1==t.get(i,o)}function f(t,i,o){return 2===t.get(i,o)}function s(t,i,o){return 6===t.get(i,o)}function u(t,i,o){const e=t.get(i,o);return 3===e||8===e}function c(t,i,o){return h(t,i,o)||u(t,i,o)}function d(t,i,o){const e=t.get(i,o);return 7===e||17===e}function g(t,i,o){return 4===t.get(i,o)}function m(t,i,o){return 5===t.get(i,o)}function w(t,i,o){return g(t,i,o)||m(t,i,o)}const M=i.utils.DIRS;function p(t,o,r,n){const l=r.hall?r.hall.doors:r.doors;for(let h=0;h<e.length;h++){const a=Math.floor(e[h]/t.height),f=e[h]%t.height;if(0!=t.get(a,f))continue;const s=O(t,a,f,1);if(s!=i.utils.NO_DIRECTION){const e=(s+2)%4,h=l[e];if(!h)continue;const u=a-h[0],c=f-h[1];if(-1!=h[0]&&y(t,o,u,c))return i.grid.offsetZip(t,o,u,c,((i,o,e,r)=>{t[e][r]=n.room.tile||1})),R(t,r,n,a,f,e),r.translate(u,c),!0}}return!1}function R(t,o,e,r,n,l){if(0===e.door)return;const h=e.door||2;if(t[r][n]=h,o.hall&&o.hall.width>1&&o.hall.dir===l)if(l===i.utils.UP||l===i.utils.DOWN){let i=!0,o=1;for(;i;)i=!1,0===t.get(r-o,n)&&t.get(r-o,n-1)&&t.get(r-o,n+1)&&(t[r-o][n]=h,i=!0),0===t.get(r+o,n)&&t.get(r+o,n-1)&&t.get(r+o,n+1)&&(t[r+o][n]=h,i=!0),++o}else{let i=!0,o=1;for(;i;)i=!1,0===t.get(r,n-o)&&t.get(r-1,n-o)&&t.get(r+1,n-o)&&(t[r][n-o]=e.door,i=!0),0===t.get(r,n+o)&&t.get(r-1,n+o)&&t.get(r+1,n+o)&&(t[r][n+o]=e.door,i=!0),++o}}function y(t,i,o,e){let r,n,l,h,a,f;for(r=0;r<i.width;r++)for(n=0;n<i.height;n++)if(i[r][n])for(l=r+o,h=n+e,a=l-1;a<=l+1;a++)for(f=h-1;f<=h+1;f++)if(!t.hasXY(a,f)||t.isBoundaryXY(a,f)||0!==t.get(a,f))return!1;return!0}function O(t,o,e,r){let n,l,h,a,f,s;const u="function"==typeof r?r:t=>t==r;for(l=i.utils.NO_DIRECTION,n=0;n<4;n++)if(h=o+M[n][0],a=e+M[n][1],f=o-M[n][0],s=e-M[n][1],t.hasXY(f,s)&&t.hasXY(h,a)&&u(t[f][s],f,s,t)){if(l!=i.utils.NO_DIRECTION)return i.utils.NO_DIRECTION;l=n}return l}function D(t,o,e,r,n){const l=i.random.sequence(o.length);for(let i=0;i<l.length;i++){const h=o[l[i]];if(!h)continue;if(x(t,h[0],h[1],e,r,n))return!0}return!1}function x(t,o,e,r,n,l){const h=n.hall?n.hall.doors:n.doors,a=i.random.sequence(4);for(let f of a){const a=(f+2)%4,s=h[a];if(s&&(-1!=s[0]&&y(t,r,o-s[0],e-s[1]))){const h=o-s[0],f=e-s[1];return i.grid.offsetZip(t,r,h,f,((i,o,e,r)=>{t[e][r]=l.room.tile||1})),R(t,n,l,o,e,a),n.translate(h,f),!0}}return!1}function _(t,o){let e,r,n,l,h,a,f;o=o||1;const s=i.grid.alloc(t.width,t.height);for(s.copy(t),e=0;e<s.width;e++)for(r=0;r<s.height;r++)if(!s[e][r]&&(a=O(s,e,r,o),a!=i.utils.NO_DIRECTION)){for(l=e+M[a][0],h=r+M[a][1],f=!1,n=0;n<10&&s.hasXY(l,h)&&!f;n++)s[l][h]&&(f=!0),l+=M[a][0],h+=M[a][1];f||(s[e][r]=a+200)}let u=[];for(a=0;a<4;a++){const t=s.randomMatchingLoc(a+200)||[-1,-1];u[a]=[t[0],t[1]]}return i.grid.free(s),u}var E={__proto__:null,attachRoom:p,attachDoor:R,roomFitsAt:y,directionOfDoorSite:O,forceRoomAtMapLoc:function(t,o,r,n,l){for(let h=0;h<e.length;h++){const a=Math.floor(e[h]/t.height),f=e[h]%t.height;if(r[a][f])continue;if(O(r,a,f,1)!=i.utils.NO_DIRECTION){const e=o[0]-a,h=o[1]-f;if(y(t,r,e,h)){if(i.grid.offsetZip(t,r,e,h,((i,o,e,r)=>{t[e][r]=l.room.tile||1})),!1!==l.room.door){const i=!0!==l.room.door&&l.room.door?l.room.door:2;t[o[0]][o[1]]=i}return n.translate(e,h),!0}}}return!1},attachRoomAtMapDoor:D,chooseRandomDoorSites:_};class L{constructor(t,o,e,r=1){this.width=1,this.doors=[],this.x=t[0],this.y=t[1];const n=i.utils.DIRS[o];this.length=e,this.width=r,o===i.utils.UP||o===i.utils.DOWN?(this.x2=this.x+(r-1),this.y2=this.y+(e-1)*n[1]):(this.x2=this.x+(e-1)*n[0],this.y2=this.y+(r-1)),this.dir=o}translate(t,i){this.x+=t,this.y+=i,this.x2+=t,this.y2+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))}))}}class I{constructor(t,i,o,e,r){this.doors=[],this.hall=null,this.digger=t,this.x=i,this.y=o,this.width=e,this.height=r}get cx(){return this.x+Math.floor(this.width/2)}get cy(){return this.y+Math.floor(this.height/2)}translate(t,i){this.x+=t,this.y+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))})),this.hall&&this.hall.translate(t,i)}}const N=i.utils.DIRS;var A={};function v(t,i,o={}){const e=i(o||{});return e.fn=i,e.id=t,A[t]=e,e}function T(t={}){return i.utils.clamp(function(t){if(!t)return 1;if("number"==typeof t)return t;if(void 0===t.width)return 1;let o=t.width;if("number"==typeof o)return o;o=Array.isArray(o)?i.random.weighted(o)+1:"string"==typeof o?i.range.make(o).value():Number.parseInt(i.random.weighted(o));return o}(t),1,3)}function S(t,o){return o.length||(o.length=[]),Array.isArray(o.length)?t==i.utils.UP||t==i.utils.DOWN?i.range.make(o.length[1]||[2,9]):i.range.make(o.length[0]||[9,15]):i.range.make(o.length)}function C(t,o,e){const r=o.doors;let n=e.dir||i.utils.NO_DIRECTION;if(n==i.utils.NO_DIRECTION){const o=i.random.sequence(4);for(let l=0;l<4;l++){n=o[l];const h=S(n,e).hi,a=r[n];if(a&&-1!=a[0]&&-1!=a[1]){const i=a[0]+Math.floor(N[n][0]*h),o=a[1]+Math.floor(N[n][1]*h);if(t.hasXY(i,o))break}n=i.utils.NO_DIRECTION}}return n}function b(t,o,e,r,n){let l,h;const a=i.utils.firstOpt("obliqueChance",n,15),f=i.random.chance(a),s=[];for(let i=0;i<4;i++)l=o+N[i][0],h=e+N[i][1],i!=r&&!f||!t.hasXY(l,h)||t[l][h]||(s[i]=[l,h]);return s}function X(t,o,e){if((t=t||{}).width=1,!o)return t;const r=C(o,e,t);if(r===i.utils.NO_DIRECTION)return null;const n=S(r,t).value(),l=e.doors[r],h=N[r];let a=l[0],f=l[1];const s=t.tile||1;for(let t=0;t<n;t++)o[a][f]=s,a+=h[0],f+=h[1];a-=h[0],f-=h[1];const u=new L(l,r,n);return u.doors=b(o,a,f,r,t),u}v("DEFAULT",X,{chance:15});var Y={__proto__:null,halls:A,install:v,pickWidth:T,pickLengthRange:S,pickHallDirection:C,pickHallExits:b,digWide:function(t,o,e){if((t=t||{}).width||(t.width=2),!o)return t;const r=C(o,e,t);if(r===i.utils.NO_DIRECTION)return null;const n=S(r,t).value(),l=T(t)||2,h=e.doors[r],a=t.tile||1,f=[];let s,u,c;if(r===i.utils.UP){s=i.utils.clamp(h[0],e.x,e.x+e.width-l),u=h[1]-n+1;for(let t=s;t<s+l;++t)for(let i=u;i<u+n;++i)o[t][i]=a;f[r]=[s,u-1],c=new L([s,h[1]],r,n,2)}else if(r===i.utils.DOWN){s=i.utils.clamp(h[0],e.x,e.x+e.width-l),u=h[1]+n-1;for(let t=s;t<s+l;++t)for(let i=u;i>u-n;--i)o[t][i]=a;f[r]=[s,u+1],c=new L([s,h[1]],r,n,2)}else if(r===i.utils.LEFT){s=h[0]-n+1,u=i.utils.clamp(h[1],e.y,e.y+e.height-l);for(let t=s;t<s+n;++t)for(let i=u;i<u+l;++i)o[t][i]=a;f[r]=[s-1,u],c=new L([h[0],u],r,n,2)}else{s=h[0]+n-1,u=i.utils.clamp(h[1],e.y,e.y+e.height-l);for(let t=s;t>s-n;--t)for(let i=u;i<u+l;++i)o[t][i]=a;f[r]=[s+1,u],c=new L([h[0],u],r,n,l)}return c.doors=f,c.width=l,c},dig:X},W={};function k(t,i,o){const e=i(o||{});return e.fn=i,e.id=t,W[t]=e,e}function B(t,o){return t=t||{},o=o||{},Object.entries(o).forEach((([o,e])=>{let r=t[o];if("tile"===o)return void(void 0===r&&(t[o]=e));if(!0===e){if(!r)return i.utils.ERROR("Missing required config for digger: "+o)}else r=("number"==typeof e||Array.isArray(e),r||e);const n=i.range.make(r);t[o]=n})),t}function F(t,i){if(t=B(t,{width:[3,6],height:[3,6]}),!i)return t;const o=t.width.value(),e=t.height.value(),r=t.tile||1;i.fill(0);const n=Math.floor((i.width-o)/2),l=Math.floor((i.height-e)/2);return i.fillRect(n,l,o,e,r),new I(t.id,n,l,o,e)}function U(t,o={}){let e,r,n,l,h,a,f,s,u,c,d,g=0;a=o.height||15,f=o.width||30,s=o.minSize||5,u=o.tries||20,c=o.count||1,d=o.canDisrupt||!1;const m=o.wreath||0,w=o.wreathTile||5,M=o.tile||4,p=i.grid.alloc(t.width,t.height,0);let R=0;for(;R<c&&g<c;){const o=Math.round((f-s)*(c-R)/c)+s,y=Math.round((a-s)*(c-R)/c)+s;p.fill(0);const O=p.fillBlob(5,4,4,o,y,55,"ffffftttt","ffffttttt");let D=!1;for(n=0;n<u&&!D;n++)if(l=i.random.range(1-O.x,p.width-O.width-O.x-2),h=i.random.range(1-O.y,p.height-O.height-O.y-2),d||!P(t,p,-l,-h)){for(D=!0,e=0;e<O.width;e++)for(r=0;r<O.height;r++)if(p[e+O.x][r+O.y]){const i=e+O.x+l,o=r+O.y+h;t[i][o]=M,m&&t.forCircle(i,o,m,((i,o,e)=>{1!==i&&2!==i||(t[o][e]=w)}))}break}D?++g:++R}return i.grid.free(p),g}function P(t,o,e=0,r=0){const n=i.grid.alloc(t.width,t.height);let h=!1;t.forEach(((i,a,f)=>{const s=a+e,u=f+r;if(i)if(d(t,a,f))o.get(s,u)?h=!0:n[a][f]=1;else if(l(t,a,f)){if(o.get(s,u))return;n[a][f]=1}}));let a=!0;for(let t=0;t<n.width&&!h;++t)for(let i=0;i<n.height&&!h;++i)1==n[t][i]&&(a?(n.floodFill(t,i,1,2),a=!1):h=!0);return i.grid.free(n),h}function q(t,i,o,e){return 6===t.get(i,o)||!!w(t,i,o)&&(!!w(t,i+e[1],o+e[0])&&!!w(t,i-e[1],o-e[0]))}function G(t,o,e){let r,h,a,f,s,u,c;e=e||1;const d=t,g=i.grid.alloc(t.width,t.height),m=i.grid.alloc(t.width,t.height),M=[[1,0],[0,1]];n(t,m);const p=i.random.sequence(t.width*t.height);for(a=0;a<p.length;a++)if(u=Math.floor(p[a]/d.height),c=p[a]%d.height,t.hasXY(u,c)&&t.get(u,c)&&l(t,u,c)&&!w(t,u,c))for(s=0;s<=1;s++){const n=M[s];if(r=u+n[0],h=c+n[1],f=e,t.hasXY(r,h)){if(w(t,r,h))for(f=0;f<e&&(r+=n[0],h+=n[1],w(t,r,h));++f);if(t.get(r,h)&&l(t,r,h)&&f<e&&(i.path.calculateDistances(g,r,h,m,!1),g[u][c]>o&&g[u][c]<i.path.NO_PATH)){for(;u!==r||c!==h;)q(t,u,c,n)?(t[u][c]=6,m[u][c]=1):(t[u][c]=1,m[u][c]=1),u+=n[0],c+=n[1];break}}}i.grid.free(g),i.grid.free(m)}function H(t,o,e,r){let n=0;if(!c(r,o,e))return!1;for(let t=0;t<4;++t){const l=i.utils.DIRS[t];if(!r.hasXY(o+l[0],e+l[1]))return!1;if(!r.hasXY(o-l[0],e-l[1]))return!1;if(a(r,o+l[0],e+l[1])){if(n+=1,!c(r,o-l[0]+l[1],e-l[1]+l[0]))return!1;if(!c(r,o-l[0]-l[1],e-l[1]-l[0]))return!1}else if(!c(r,o+l[0],e+l[1]))return!1}return 1==n}function j(t,o,e,r){const n=i.random.sequence(4);let l=null;for(let r=0;r<n.length;++r){l=i.utils.DIRS[r];if(a(t,o+l[0],e+l[1])&&c(t,o-l[0],e-l[1]))break;l=null}l||i.utils.ERROR("No stair direction found!"),t.set(o,e,r);const h=i.utils.CLOCK_DIRS.findIndex((t=>t[0]==l[0]&&t[1]==l[1]));for(let r=0;r<i.utils.CLOCK_DIRS.length;++r){const n=r?r-1:7,l=(r+1)%8;if(r==h||n==h||l==h)continue;const a=i.utils.CLOCK_DIRS[r];t.set(o+a[0],e+a[1],3)}return!0}function K(t,o={}){let e=!1!==o.up,r=!1!==o.down;const n=o.minDistance||Math.floor(Math.max(t.width,t.height)/2),l=o.isValid||H,h=o.setup||j;let a=Array.isArray(o.up)?o.up:null,f=Array.isArray(o.down)?o.down:null;const s={};if(o.start&&"string"!=typeof o.start){let e=o.start;e=!0===e?t.randomMatchingLoc(l):t.matchingLocNear(i.utils.x(e),i.utils.y(e),l),s.start=e}return a&&f?(a=t.matchingLocNear(i.utils.x(a),i.utils.y(a),l),f=t.matchingLocNear(i.utils.x(f),i.utils.y(f),l)):a&&!f?(a=t.matchingLocNear(i.utils.x(a),i.utils.y(a),l),r&&(f=t.randomMatchingLoc(((o,e,r)=>!(i.utils.distanceBetween(e,r,a[0],a[1])<n)&&l(o,e,r,t))))):f&&!a?(f=t.matchingLocNear(i.utils.x(f),i.utils.y(f),l),e&&(a=t.randomMatchingLoc(((o,e,r)=>!(i.utils.distanceBetween(e,r,f[0],f[1])<n)&&H(0,e,r,t))))):e?(a=t.randomMatchingLoc(l),r&&(f=t.randomMatchingLoc(((o,e,r)=>!(i.utils.distanceBetween(e,r,a[0],a[1])<n)&&H(0,e,r,t))))):r&&(f=t.randomMatchingLoc(l)),a&&(s.up=a.slice(),h(t,a[0],a[1],o.upTile||7),"up"===o.start&&(s.start=s.up)),f&&(s.down=f.slice(),h(t,f[0],f[1],o.downTile||17),"down"===o.start&&(s.start=s.down)),a||f?s:null}function Z(t){let o,e,r,n,h,a;do{for(a=!1,o=0;o<t.width-1;o++)for(e=0;e<t.height-1;e++)for(r=0;r<=1;r++)l(t,o+r,e)&&!l(t,o+(1-r),e)&&c(t,o+(1-r),e)&&!l(t,o+r,e+1)&&c(t,o+r,e+1)&&l(t,o+(1-r),e+1)&&(i.random.chance(50)?(n=o+(1-r),h=e):(n=o+r,h=e+1),a=!0,t[n][h]=1)}while(1==a)}function z(t){t.forEach(((i,o,e)=>{t.isBoundaryXY(o,e)||2==i&&(1!=t.get(o+1,e)&&1!=t.get(o-1,e)||1!=t.get(o,e+1)&&1!=t.get(o,e-1)?(1!==t.get(o+1,e)?1:0)+(1!==t.get(o-1,e)?1:0)+(1!==t.get(o,e+1)?1:0)+(1!==t.get(o,e-1)?1:0)>=3&&(t[o][e]=1):t[o][e]=1)}))}function V(t,i=3){t.forEach(((o,e,r)=>{0==o&&(t[e][r]=i)}))}k("DEFAULT",F);var Q={__proto__:null,room:{__proto__:null,rooms:W,install:k,checkConfig:B,cavern:function(t,o){if(t=B(t,{width:12,height:8}),!o)return t;let e,r,n;const l=t.width.value(),h=t.height.value(),a=t.tile||1;n=i.grid.alloc(o.width,o.height,0);const f=Math.floor(.5*l),s=l,u=Math.floor(.5*h),c=h;o.fill(0);const d=n.fillBlob(5,f,u,s,c,55,"ffffffttt","ffffttttt");return e=Math.floor((o.width-d.width)/2),r=Math.floor((o.height-d.height)/2),i.grid.offsetZip(o,n,e-d.x,r-d.y,a),i.grid.free(n),new I(t.id,e,r,d.width,d.height)},choiceRoom:function(t,o){let e;if(t=t||{},Array.isArray(t.choices)?e=i.random.item.bind(i.random,t.choices):"object"==typeof t.choices?e=i.random.weighted.bind(i.random,t.choices):i.utils.ERROR("Expected choices to be either array of room ids or map - ex: { ROOM_ID: weight }"),!o)return t;let r=e();const n=W[r];n||i.utils.ERROR("Missing digger choice: "+r);let l=n;return t.opts&&(l=Object.assign({},n,t.opts)),n.fn(l,o)},entrance:function(t,i){if(t=B(t,{width:20,height:10}),!i)return t;const o=t.width.value(),e=t.height.value(),r=t.tile||1,n=Math.floor(.4*o),l=e,h=o,a=Math.floor(.5*e),f=Math.floor(i.width/2-n/2-1),s=i.height-l-2,u=Math.floor(i.width/2-h/2-1),c=i.height-a-2;return i.fill(0),i.fillRect(f,s,n,l,r),i.fillRect(u,c,h,a,r),new I(t.id,Math.min(f,u),Math.min(s,c),Math.max(n,h),Math.max(l,a))},cross:function(t,o){if(t=B(t,{width:12,height:20}),!o)return t;const e=t.width.value(),r=t.height.value(),n=t.tile||1,l=e,h=Math.max(3,Math.floor(e*i.random.range(25,75)/100)),a=Math.max(3,Math.floor(r*i.random.range(25,75)/100)),f=r,s=Math.floor((o.width-l)/2),u=s+i.random.range(2,Math.max(2,l-h-2)),c=Math.floor((o.height-f)/2),d=c+i.random.range(2,Math.max(2,f-a-2));return o.fill(0),o.fillRect(s,d,l,a,n),o.fillRect(u,c,h,f,n),new I(t.id,s,c,Math.max(l,h),Math.max(a,f))},symmetricalCross:function(t,o){if(t=B(t,{width:7,height:7}),!o)return t;const e=t.width.value(),r=t.height.value(),n=t.tile||1;let l=Math.max(3,Math.floor(e*i.random.range(25,50)/100)),h=Math.max(3,Math.floor(r*i.random.range(25,50)/100));o.fill(0);const a=Math.floor((o.width-e)/2),f=Math.floor((o.height-h)/2);o.fillRect(a,f,e,h,n);const s=Math.floor((o.width-l)/2),u=Math.floor((o.height-r)/2);return o.fillRect(s,u,l,r,n),new I(t.id,Math.min(a,s),Math.min(f,u),Math.max(e,l),Math.max(r,h))},rectangular:F,circular:function(t,i){if(t=B(t,{radius:[3,4]}),!i)return t;const o=t.radius.value(),e=t.tile||1;i.fill(0);const r=Math.floor(i.width/2),n=Math.floor(i.height/2);return o>1&&i.fillCircle(r,n,o,e),new I(t.id,r-o,n-o,2*o+1,2*o+1)},brogueDonut:function(t,o){if(t=B(t,{radius:[5,10],ringMinWidth:3,holeMinSize:3,holeChance:50}),!o)return t;const e=t.radius.value(),r=t.ringMinWidth.value(),n=t.holeMinSize.value(),l=t.tile||1;o.fill(0);const h=Math.floor(o.width/2),a=Math.floor(o.height/2);return o.fillCircle(h,a,e,l),e>r+n&&i.random.chance(t.holeChance.value())&&o.fillCircle(h,a,i.random.range(n,e-n),0),new I(t.id,h-e,a-e,2*e+1,2*e+1)},chunkyRoom:function(t,o){if(t=B(t,{count:[2,12],width:[5,20],height:[5,20]}),!o)return t;let e,r,n,l,h,a,f,s=t.count.value();const u=t.width.value(),c=t.height.value(),d=t.tile||1;for(l=Math.floor(o.width/2)-Math.floor(u/2),h=Math.floor(o.width/2)+Math.floor(u/2),a=Math.floor(o.height/2)-Math.floor(c/2),f=Math.floor(o.height/2)+Math.floor(c/2),o.fill(0),o.fillCircle(Math.floor(o.width/2),Math.floor(o.height/2),2,d),e=0;e<s;)if(r=i.random.range(l,h),n=i.random.range(a,f),o[r][n]){if(r-2<l)continue;if(r+2>h)continue;if(n-2<a)continue;if(n+2>f)continue;o.fillCircle(r,n,2,d),e++}const g=o.valueBounds(d);return new I(t.id,g.x,g.y,g.width,g.height)}},hall:Y,lake:{__proto__:null,digLakes:U,digBridges:G},stairs:{__proto__:null,isValidStairLoc:H,setupStairs:j,addStairs:K},utils:E,start:function(t){r(t.width*t.height),t.fill(0)},finish:function(t){Z(t),V(t),z(t)},addRoom:function(t,o){if("string"==typeof(o=o||{room:"DEFAULT",hall:"DEFAULT",tries:10})&&(o={room:o}),o.loc&&(o.locs=[o.loc]),o.room||(o.room="DEFAULT"),"function"==typeof o.room&&(o.room={fn:o.room}),"string"==typeof o.room){const t=o.room;o.room=W[t],o.room||i.utils.ERROR("Failed to find room: "+t)}const e=o.room;let r=null;if(!0===o.hall&&(o.hall="DEFAULT"),!1===o.hall||o.hall||(o.hall="DEFAULT"),"function"==typeof o.hall&&(o.hall={fn:o.hall}),"string"==typeof o.hall){const t=o.hall;if(o.hall=A[t],!o.hall)return i.utils.ERROR("Failed to find hall: "+t),null;r=o.hall}else o.hall&&o.hall.fn&&(r=o.hall);!1===o.door?o.door=0:!0===o.door?o.door=2:"number"==typeof o.door?o.door=i.random.chance(o.door)?2:1:o.door=1;let n=o.locs||null;if(n&&n.doors&&(n=n.doors),n&&Array.isArray(n))n&&n.length&&2==n.length&&"number"==typeof n[0]?n=[n]:0==n.length&&(n=null);else if(n=null,0===t.count(1)){n=[[Math.floor(t.width/2),t.height-2]]}const l=o.room,h=i.grid.alloc(t.width,t.height);let a=!1;if(r){let t=void 0!==r.chance?r.chance:15;a=i.random.chance(t)}let f,s=!1,u=o.tries||10;for(;--u>=0&&!s;)h.fill(0),f=l.fn(e,h),f.doors=_(h,1),a&&r&&(f.hall=r.fn(r,h,f)),s=n?D(t,n,h,f,o):p(t,h,f,o);return i.grid.free(h),f&&s?f:null},addLoops:function(t,o,r){let h,a,s,u,c,d,g,m,w;o=o||Math.floor(Math.min(t.width,t.height)/2),r=r||1;const M=t,p=i.grid.alloc(t.width,t.height),R=i.grid.alloc(t.width,t.height),y=[[1,0],[0,1]];function O(i,o,e){return!!t.hasXY(i,o)&&(!!t.hasXY(i+e[1],o+e[0])&&(!!t.hasXY(i-e[1],o-e[0])&&(!t.get(i,o)&&(!t.get(i+e[1],o+e[0])&&!t.get(i-e[1],o-e[0])))))}function D(i,o,e){return!!t.hasXY(i,o)&&(!!t.hasXY(i+e[1],o+e[0])&&(!!t.hasXY(i-e[1],o-e[0])&&(!!t.get(i,o)||(!!t.get(i+e[1],o+e[0])||!!t.get(i-e[1],o-e[0])))))}for(n(t,R),c=0;c<e.length;c++){m=Math.floor(e[c]/M.height),w=e[c]%M.height;if(!M[m][w])for(g=0;g<=1;g++){let e=y[g];if(O(m,w,e)){if(d=r,t.hasXY(m+e[0],w+e[1])&&l(t,m+e[0],w+e[1])){if(!t.hasXY(m-e[0],w-e[1])||f(t,m-e[0],w-e[1]))continue}else{if(!t.hasXY(m-e[0],w-e[1])||!l(t,m-e[0],w-e[1]))continue;if(!t.hasXY(m+e[0],w+e[1])||f(t,m+e[0],w+e[1]))continue;e=e.map((t=>-1*t))}for(h=m+e[0],a=w+e[1],s=m,u=w,d=0;d<r&&(s-=e[0],u-=e[1],!D(s,u,e));++d);if(d<r&&(i.path.calculateDistances(p,h,a,R,!1),p[s][u]>o&&p[s][u]<3e4)){for(;s!==h||u!==a;)0==t.get(s,u)&&(t[s][u]=1,R[s][u]=1),s+=e[0],u+=e[1];t[m][w]=2;break}}}}i.grid.free(p),i.grid.free(R)},addLakes:function(t,i={}){return U(t,i)},addBridges:function(t,i,o){return G(t,i,o)},addStairs:function(t,i={}){return K(t,i)},removeDiagonalOpenings:Z,finishDoors:z,finishWalls:V,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,DEEP:4,SHALLOW:5,BRIDGE:6,UP_STAIRS:7,DOWN_STAIRS:17,IMPREGNABLE:8,TILEMAP:o,SEQ:e,initSeqence:r,fillCostGrid:n,isPassable:l,isNothing:h,isFloor:a,isDoor:f,isBridge:s,isWall:u,isObstruction:c,isStairs:d,isDeep:g,isShallow:m,isAnyWater:w,Hall:L,Room:I};t.dig=Q,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-dig.min.js.map

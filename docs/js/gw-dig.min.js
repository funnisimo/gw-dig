!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("gw-utils")):"function"==typeof define&&define.amd?define(["exports","gw-utils"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).GW=t.GW||{},t.GW)}(this,(function(t,i){"use strict";class o{constructor(t,o,e,r=1){this.width=1,this.doors=[],this.x=t[0],this.y=t[1];const n=i.utils.DIRS[o];this.length=e,this.width=r,o===i.utils.UP||o===i.utils.DOWN?(this.x2=this.x+(r-1),this.y2=this.y+(e-1)*n[1]):(this.x2=this.x+(e-1)*n[0],this.y2=this.y+(r-1)),this.dir=o}translate(t,i){this.x+=t,this.y+=i,this.x2+=t,this.y2+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))}))}}class e{constructor(t,i,o,e,r){this.doors=[],this.hall=null,this.digger=t,this.x=i,this.y=o,this.width=e,this.height=r}get cx(){return this.x+Math.floor(this.width/2)}get cy(){return this.y+Math.floor(this.height/2)}translate(t,i){this.x+=t,this.y+=i,this.doors&&this.doors.forEach((o=>{o&&(o[0]<0||o[1]<0||(o[0]+=t,o[1]+=i))})),this.hall&&this.hall.translate(t,i)}}var r={};function n(t,i,o){const e=i(o||{});return e.fn=i,e.id=t,r[t]=e,e}function l(t,o){return t=t||{},o=o||{},Object.entries(o).forEach((([o,e])=>{let r=t[o];if("tile"===o)return void(void 0===r&&(t[o]=e));if(!0===e){if(!r)return i.utils.ERROR("Missing required config for digger: "+o)}else r=("number"==typeof e||Array.isArray(e),r||e);const n=i.range.make(r);t[o]=n})),t}function h(t,i){if(t=l(t,{width:[3,6],height:[3,6]}),!i)return t;const o=t.width.value(),r=t.height.value(),n=t.tile||1;i.fill(0);const h=Math.floor((i.width-o)/2),f=Math.floor((i.height-r)/2);return i.fillRect(h,f,o,r,n),new e(t.id,h,f,o,r)}n("DEFAULT",h);var f={__proto__:null,Hall:o,Room:e,rooms:r,install:n,checkConfig:l,cavern:function(t,o){if(t=l(t,{width:12,height:8}),!o)return t;let r,n,h;const f=t.width.value(),a=t.height.value(),s=t.tile||1;h=i.grid.alloc(o.width,o.height,0);const c=Math.floor(.5*f),u=f,d=Math.floor(.5*a),g=a;o.fill(0);const m=h.fillBlob(5,c,d,u,g,55,"ffffffttt","ffffttttt");return r=Math.floor((o.width-m.width)/2),n=Math.floor((o.height-m.height)/2),i.grid.offsetZip(o,h,r-m.x,n-m.y,s),i.grid.free(h),new e(t.id,r,n,m.width,m.height)},choiceRoom:function(t,o){let e;if(t=t||{},Array.isArray(t.choices)?e=i.random.item.bind(i.random,t.choices):"object"==typeof t.choices?e=i.random.weighted.bind(i.random,t.choices):i.utils.ERROR("Expected choices to be either array of room ids or map - ex: { ROOM_ID: weight }"),!o)return t;let n=e();const l=r[n];l||i.utils.ERROR("Missing digger choice: "+n);let h=l;return t.opts&&(h=Object.assign({},l,t.opts)),l.fn(h,o)},entrance:function(t,i){if(t=l(t,{width:20,height:10}),!i)return t;const o=t.width.value(),r=t.height.value(),n=t.tile||1,h=Math.floor(.4*o),f=r,a=o,s=Math.floor(.5*r),c=Math.floor(i.width/2-h/2-1),u=i.height-f-2,d=Math.floor(i.width/2-a/2-1),g=i.height-s-2;return i.fill(0),i.fillRect(c,u,h,f,n),i.fillRect(d,g,a,s,n),new e(t.id,Math.min(c,d),Math.min(u,g),Math.max(h,a),Math.max(f,s))},cross:function(t,o){if(t=l(t,{width:12,height:20}),!o)return t;const r=t.width.value(),n=t.height.value(),h=t.tile||1,f=r,a=Math.max(3,Math.floor(r*i.random.range(25,75)/100)),s=Math.max(3,Math.floor(n*i.random.range(25,75)/100)),c=n,u=Math.floor((o.width-f)/2),d=u+i.random.range(2,Math.max(2,f-a-2)),g=Math.floor((o.height-c)/2),m=g+i.random.range(2,Math.max(2,c-s-2));return o.fill(0),o.fillRect(u,m,f,s,h),o.fillRect(d,g,a,c,h),new e(t.id,u,g,Math.max(f,a),Math.max(s,c))},symmetricalCross:function(t,o){if(t=l(t,{width:7,height:7}),!o)return t;const r=t.width.value(),n=t.height.value(),h=t.tile||1;let f=Math.max(3,Math.floor(r*i.random.range(25,50)/100)),a=Math.max(3,Math.floor(n*i.random.range(25,50)/100));o.fill(0);const s=Math.floor((o.width-r)/2),c=Math.floor((o.height-a)/2);o.fillRect(s,c,r,a,h);const u=Math.floor((o.width-f)/2),d=Math.floor((o.height-n)/2);return o.fillRect(u,d,f,n,h),new e(t.id,Math.min(s,u),Math.min(c,d),Math.max(r,f),Math.max(n,a))},rectangular:h,circular:function(t,i){if(t=l(t,{radius:[3,4]}),!i)return t;const o=t.radius.value(),r=t.tile||1;i.fill(0);const n=Math.floor(i.width/2),h=Math.floor(i.height/2);return o>1&&i.fillCircle(n,h,o,r),new e(t.id,n-o,h-o,2*o+1,2*o+1)},brogueDonut:function(t,o){if(t=l(t,{radius:[5,10],ringMinWidth:3,holeMinSize:3,holeChance:50}),!o)return t;const r=t.radius.value(),n=t.ringMinWidth.value(),h=t.holeMinSize.value(),f=t.tile||1;o.fill(0);const a=Math.floor(o.width/2),s=Math.floor(o.height/2);return o.fillCircle(a,s,r,f),r>n+h&&i.random.chance(t.holeChance.value())&&o.fillCircle(a,s,i.random.range(h,r-h),0),new e(t.id,a-r,s-r,2*r+1,2*r+1)},chunkyRoom:function(t,o){if(t=l(t,{count:[2,12],width:[5,20],height:[5,20]}),!o)return t;let r,n,h,f,a,s,c,u=t.count.value();const d=t.width.value(),g=t.height.value(),m=t.tile||1;for(f=Math.floor(o.width/2)-Math.floor(d/2),a=Math.floor(o.width/2)+Math.floor(d/2),s=Math.floor(o.height/2)-Math.floor(g/2),c=Math.floor(o.height/2)+Math.floor(g/2),o.fill(0),o.fillCircle(Math.floor(o.width/2),Math.floor(o.height/2),2,m),r=0;r<u;)if(n=i.random.range(f,a),h=i.random.range(s,c),o[n][h]){if(n-2<f)continue;if(n+2>a)continue;if(h-2<s)continue;if(h+2>c)continue;o.fillCircle(n,h,2,m),r++}const w=o.valueBounds(m);return new e(t.id,w.x,w.y,w.width,w.height)}};const a=i.utils.DIRS;var s={};function c(t,i,o={}){const e=i(o||{});return e.fn=i,e.id=t,s[t]=e,e}function u(t={}){return i.utils.clamp(function(t){if(!t)return 1;if("number"==typeof t)return t;if(void 0===t.width)return 1;let o=t.width;if("number"==typeof o)return o;o=Array.isArray(o)?i.random.weighted(o)+1:"string"==typeof o?i.range.make(o).value():Number.parseInt(i.random.weighted(o));return o}(t),1,3)}function d(t,o){return o.length||(o.length=[]),Array.isArray(o.length)?t==i.utils.UP||t==i.utils.DOWN?i.range.make(o.length[1]||[2,9]):i.range.make(o.length[0]||[9,15]):i.range.make(o.length)}function g(t,o,e){const r=o.doors;let n=e.dir||i.utils.NO_DIRECTION;if(n==i.utils.NO_DIRECTION){const o=i.random.sequence(4);for(let l=0;l<4;l++){n=o[l];const h=d(n,e).hi,f=r[n];if(f&&-1!=f[0]&&-1!=f[1]){const i=f[0]+Math.floor(a[n][0]*h),o=f[1]+Math.floor(a[n][1]*h);if(t.hasXY(i,o))break}n=i.utils.NO_DIRECTION}}return n}function m(t,o,e,r,n){let l,h;const f=i.utils.firstOpt("obliqueChance",n,15),s=i.random.chance(f),c=[];for(let i=0;i<4;i++)l=o+a[i][0],h=e+a[i][1],i!=r&&!s||!t.hasXY(l,h)||t[l][h]||(c[i]=[l,h]);return c}function w(t,e,r){if((t=t||{}).width=1,!e)return t;const n=g(e,r,t);if(n===i.utils.NO_DIRECTION)return null;const l=d(n,t).value(),h=r.doors[n],f=a[n];let s=h[0],c=h[1];const u=t.tile||1;for(let t=0;t<l;t++)e[s][c]=u,s+=f[0],c+=f[1];s-=f[0],c-=f[1];const w=new o(h,n,l);return w.doors=m(e,s,c,n,t),w}c("DEFAULT",w,{chance:15});var M={__proto__:null,halls:s,install:c,pickWidth:u,pickLengthRange:d,pickHallDirection:g,pickHallExits:m,digWide:function(t,e,r){if((t=t||{}).width||(t.width=2),!e)return t;const n=g(e,r,t);if(n===i.utils.NO_DIRECTION)return null;const l=d(n,t).value(),h=u(t)||2,f=r.doors[n],a=t.tile||1,s=[];let c,m,w;if(n===i.utils.UP){c=i.utils.clamp(f[0],r.x,r.x+r.width-h),m=f[1]-l+1;for(let t=c;t<c+h;++t)for(let i=m;i<m+l;++i)e[t][i]=a;s[n]=[c,m-1],w=new o([c,f[1]],n,l,2)}else if(n===i.utils.DOWN){c=i.utils.clamp(f[0],r.x,r.x+r.width-h),m=f[1]+l-1;for(let t=c;t<c+h;++t)for(let i=m;i>m-l;--i)e[t][i]=a;s[n]=[c,m+1],w=new o([c,f[1]],n,l,2)}else if(n===i.utils.LEFT){c=f[0]-l+1,m=i.utils.clamp(f[1],r.y,r.y+r.height-h);for(let t=c;t<c+l;++t)for(let i=m;i<m+h;++i)e[t][i]=a;s[n]=[c-1,m],w=new o([f[0],m],n,l,2)}else{c=f[0]+l-1,m=i.utils.clamp(f[1],r.y,r.y+r.height-h);for(let t=c;t>c-l;--t)for(let i=m;i<m+h;++i)e[t][i]=a;s[n]=[c+1,m],w=new o([f[0],m],n,l,h)}return w.doors=s,w.width=h,w},dig:w};const y=i.utils.DIRS;var R;function p(t,o,e,r){const n=e.hall?e.hall.doors:e.doors;for(let l=0;l<R.length;l++){const h=Math.floor(R[l]/t.height),f=R[l]%t.height;if(0!=t.get(h,f))continue;const a=D(t,h,f,1);if(a!=i.utils.NO_DIRECTION){const l=(a+2)%4,s=n[l];if(!s)continue;const c=h-s[0],u=f-s[1];if(-1!=s[0]&&x(t,o,c,u))return i.grid.offsetZip(t,o,c,u,((i,o,e,n)=>{t[e][n]=r.room.tile||1})),O(t,e,r,h,f,l),e.translate(c,u),!0}}return!1}function O(t,o,e,r,n,l){const h=e.door||2;if(t[r][n]=h,o.hall&&o.hall.width>1&&o.hall.dir===l)if(l===i.utils.UP||l===i.utils.DOWN){let i=!0,o=1;for(;i;)i=!1,0===t.get(r-o,n)&&t.get(r-o,n-1)&&t.get(r-o,n+1)&&(t[r-o][n]=h,i=!0),0===t.get(r+o,n)&&t.get(r+o,n-1)&&t.get(r+o,n+1)&&(t[r+o][n]=h,i=!0),++o}else{let i=!0,o=1;for(;i;)i=!1,0===t.get(r,n-o)&&t.get(r-1,n-o)&&t.get(r+1,n-o)&&(t[r][n-o]=e.door,i=!0),0===t.get(r,n+o)&&t.get(r-1,n+o)&&t.get(r+1,n+o)&&(t[r][n+o]=e.door,i=!0),++o}}function x(t,i,o,e){let r,n,l,h,f,a;for(r=0;r<i.width;r++)for(n=0;n<i.height;n++)if(i[r][n])for(l=r+o,h=n+e,f=l-1;f<=l+1;f++)for(a=h-1;a<=h+1;a++)if(!t.hasXY(f,a)||t.isBoundaryXY(f,a)||0!==t.get(f,a))return!1;return!0}function D(t,o,e,r){let n,l,h,f,a,s;const c="function"==typeof r?r:t=>t==r;for(l=i.utils.NO_DIRECTION,n=0;n<4;n++)if(h=o+y[n][0],f=e+y[n][1],a=o-y[n][0],s=e-y[n][1],t.hasXY(a,s)&&t.hasXY(h,f)&&c(t[a][s],a,s,t)){if(l!=i.utils.NO_DIRECTION)return i.utils.NO_DIRECTION;l=n}return l}function v(t,o,e,r,n){const l=i.random.sequence(o.length);for(let i=0;i<l.length;i++){const h=o[l[i]];if(!h)continue;if(E(t,h[0],h[1],e,r,n))return!0}return!1}function E(t,o,e,r,n,l){const h=n.hall?n.hall.doors:n.doors,f=i.random.sequence(4);for(let a of f){const f=(a+2)%4,s=h[f];if(s&&(-1!=s[0]&&x(t,r,o-s[0],e-s[1]))){const h=o-s[0],a=e-s[1];return i.grid.offsetZip(t,r,h,a,((i,o,e,r)=>{t[e][r]=l.room.tile||1})),O(t,n,l,o,e,f),n.translate(h,a),!0}}return!1}function I(t,o){let e,r,n,l,h,f,a;o=o||1;const s=i.grid.alloc(t.width,t.height);for(s.copy(t),e=0;e<s.width;e++)for(r=0;r<s.height;r++)if(!s[e][r]&&(f=D(s,e,r,o),f!=i.utils.NO_DIRECTION)){for(l=e+y[f][0],h=r+y[f][1],a=!1,n=0;n<10&&s.hasXY(l,h)&&!a;n++)s[l][h]&&(a=!0),l+=y[f][0],h+=y[f][1];a||(s[e][r]=f+200)}let c=[];for(f=0;f<4;f++){const t=s.randomMatchingLoc(f+200)||[-1,-1];c[f]=[t[0],t[1]]}return i.grid.free(s),c}function N(t,i,o){const e=t.get(i,o);return 1===e||2===e||5===e||6===e||7===e}function _(t,i,o){return 2===t.get(i,o)}function T(t,i,o){const e=t.get(i,o);return 0===e||3===e}function b(t,i,o){const e=t.get(i,o);return 6===e||7===e}function A(t,o,e=0,r=0){const n=i.grid.alloc(t.width,t.height);let l=!1;t.forEach(((i,h,f)=>{const a=h+e,s=f+r;if(i)if(b(t,h,f))o.get(a,s)?l=!0:n[h][f]=1;else if(N(t,h,f)){if(o.get(a,s))return;n[h][f]=1}}));let h=!0;for(let t=0;t<n.width&&!l;++t)for(let i=0;i<n.height&&!l;++i)1==n[t][i]&&(h?(n.floodFill(t,i,1,2),h=!1):l=!0);return i.grid.free(n),l}function C(t){let o,e,r,n,l,h;do{for(h=!1,o=0;o<t.width-1;o++)for(e=0;e<t.height-1;e++)for(r=0;r<=1;r++)N(t,o+r,e)&&!N(t,o+(1-r),e)&&T(t,o+(1-r),e)&&!N(t,o+r,e+1)&&T(t,o+r,e+1)&&N(t,o+(1-r),e+1)&&(i.random.chance(50)?(n=o+(1-r),l=e):(n=o+r,l=e+1),h=!0,t[n][l]=1)}while(1==h)}function X(t){t.forEach(((i,o,e)=>{t.isBoundaryXY(o,e)||2==i&&(1!=t.get(o+1,e)&&1!=t.get(o-1,e)||1!=t.get(o,e+1)&&1!=t.get(o,e-1)?(1!==t.get(o+1,e)?1:0)+(1!==t.get(o-1,e)?1:0)+(1!==t.get(o,e+1)?1:0)+(1!==t.get(o,e-1)?1:0)>=3&&(t[o][e]=1):t[o][e]=1)}))}function Y(t,i=3){t.forEach(((o,e,r)=>{0==o&&(t[e][r]=i)}))}var L={__proto__:null,room:f,hall:M,start:function(t){R=i.random.sequence(t.width*t.height),t.fill(0)},finish:function(t){C(t),Y(t),X(t)},dig:function(t,o){if("string"==typeof(o=o||{room:"DEFAULT",hall:"DEFAULT",tries:10})&&(o={room:o}),o.loc&&(o.locs=[o.loc]),o.room||(o.room="DEFAULT"),"function"==typeof o.room&&(o.room={fn:o.room}),"string"==typeof o.room){const t=o.room;o.room=r[t],o.room||i.utils.ERROR("Failed to find room: "+t)}const e=o.room;let n=null;if(!0===o.hall&&(o.hall="DEFAULT"),!1===o.hall||o.hall||(o.hall="DEFAULT"),"function"==typeof o.hall&&(o.hall={fn:o.hall}),"string"==typeof o.hall){const t=o.hall;if(o.hall=s[t],!o.hall)return i.utils.ERROR("Failed to find hall: "+t),null;n=o.hall}else o.hall&&o.hall.fn&&(n=o.hall);!1===o.door?o.door=1:!0!==o.door&&o.door||(o.door=2);let l=o.locs||null;if(l&&Array.isArray(l))l&&l.length&&2==l.length&&"number"==typeof l[0]?l=[l]:0==l.length&&(l=null);else if(l=null,0===t.count(1)){l=[[Math.floor(t.width/2),t.height-2]]}const h=o.room,f=i.grid.alloc(t.width,t.height);let a=!1;if(n){let t=void 0!==n.chance?n.chance:15;a=i.random.chance(t)}let c,u=!1,d=o.tries||10;for(;--d>=0&&!u;)f.fill(0),c=h.fn(e,f),c.doors=I(f,1),a&&n&&(c.hall=n.fn(n,f,c)),u=l?v(t,l,f,c,o):p(t,f,c,o);return i.grid.free(f),c&&u?c:null},attachRoom:p,attachDoor:O,roomFitsAt:x,directionOfDoorSite:D,forceRoomAtMapLoc:function(t,o,e,r,n){for(let l=0;l<R.length;l++){const h=Math.floor(R[l]/t.height),f=R[l]%t.height;if(e[h][f])continue;if(D(e,h,f,1)!=i.utils.NO_DIRECTION){const l=o[0]-h,a=o[1]-f;if(x(t,e,l,a)){if(i.grid.offsetZip(t,e,l,a,((i,o,e,r)=>{t[e][r]=n.room.tile||1})),!1!==n.room.door){const i=!0!==n.room.door&&n.room.door?n.room.door:2;t[o[0]][o[1]]=i}return r.translate(l,a),!0}}}return!1},chooseRandomDoorSites:I,isPassable:N,isDoor:_,isObstruction:T,isStairs:b,addLoops:function(t,o,e){let r,n,l,h,f,a,s,c,u;o=o||Math.floor(Math.min(t.width,t.height)/2),e=e||1;const d=t,g=i.grid.alloc(t.width,t.height),m=i.grid.alloc(t.width,t.height),w=[[1,0],[0,1]];function M(i,o,e){return!!t.hasXY(i,o)&&(!!t.hasXY(i+e[1],o+e[0])&&(!!t.hasXY(i-e[1],o-e[0])&&(!t.get(i,o)&&(!t.get(i+e[1],o+e[0])&&!t.get(i-e[1],o-e[0])))))}function y(i,o,e){return!!t.hasXY(i,o)&&(!!t.hasXY(i+e[1],o+e[0])&&(!!t.hasXY(i-e[1],o-e[0])&&(!!t.get(i,o)||(!!t.get(i+e[1],o+e[0])||!!t.get(i-e[1],o-e[0])))))}for(function(t,o){t.forEach(((e,r,n)=>{o[r][n]=N(t,r,n)?1:i.path.OBSTRUCTION}))}(t,m),f=0;f<R.length;f++){c=Math.floor(R[f]/d.height),u=R[f]%d.height;if(!d[c][u])for(s=0;s<=1;s++){let f=w[s];if(M(c,u,f)){if(a=e,t.hasXY(c+f[0],u+f[1])&&N(t,c+f[0],u+f[1])){if(!t.hasXY(c-f[0],u-f[1])||_(t,c-f[0],u-f[1]))continue}else{if(!t.hasXY(c-f[0],u-f[1])||!N(t,c-f[0],u-f[1]))continue;if(!t.hasXY(c+f[0],u+f[1])||_(t,c+f[0],u+f[1]))continue;f=f.map((t=>-1*t))}for(r=c+f[0],n=u+f[1],l=c,h=u,a=0;a<e&&(l-=f[0],h-=f[1],!y(l,h,f));++a);if(a<e&&(i.path.calculateDistances(g,r,n,m,!1),g[l][h]>o&&g[l][h]<3e4)){for(;l!==r||h!==n;)0==t.get(l,h)&&(t[l][h]=1,m[l][h]=1),l+=f[0],h+=f[1];t[c][u]=2;break}}}}i.grid.free(g),i.grid.free(m)},addLakes:function(t,o={}){let e,r,n,l,h,f,a,s,c,u,d,g=0;f=o.height||15,a=o.width||30,s=o.minSize||5,c=o.tries||20,u=o.count||1,d=o.canDisrupt||!1;const m=i.grid.alloc(t.width,t.height,0);for(;f>=s&&a>=s&&g<u;f--,a-=2){m.fill(0);const s=m.fillBlob(5,4,4,a,f,55,"ffffftttt","ffffttttt");for(n=0;n<c&&g<u;n++)if(l=i.random.range(1-s.x,m.width-s.width-s.x-2),h=i.random.range(1-s.y,m.height-s.height-s.y-2),d||!A(t,m,-l,-h)){for(++g,e=0;e<s.width;e++)for(r=0;r<s.height;r++)if(m[e+s.x][r+s.y]){const i=e+s.x+l,n=r+s.y+h;t[i][n]=o.tile||4}break}}return i.grid.free(m),g},removeDiagonalOpenings:C,finishDoors:X,finishWalls:Y,Room:e,Hall:o,NOTHING:0,FLOOR:1,DOOR:2,WALL:3,LAKE:4,BRIDGE:5,UP_STAIRS:6,DOWN_STAIRS:7};t.dig=L,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gw-dig.min.js.map
